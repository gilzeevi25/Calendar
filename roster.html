<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×©×‘×¦×´×§ â€” ×¤×œ×•×’×” ×‘</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&family=Frank+Ruhl+Libre:wght@700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --clr-bg: #faf8f5;
    --clr-surface: #ffffff;
    --clr-border: #e8e2da;
    --clr-text: #1a1612;
    --clr-text-secondary: #6b5e52;
    --clr-text-tertiary: #9c8f82;
    --clr-activity: #16a34a;
    --clr-activity-bg: #dcfce7;
    --clr-home: #2563eb;
    --clr-home-bg: #dbeafe;
    --clr-accent: #7c3aed;
    --clr-accent-bg: #f3f0ff;
    --clr-danger: #dc2626;
    --clr-warning: #d97706;
    --clr-warning-bg: #fef3c7;
    --radius: 10px;
    --shadow-sm: 0 1px 3px rgba(26,22,18,0.06);
    --shadow-md: 0 4px 16px rgba(26,22,18,0.08);
    --font-body: 'Heebo', sans-serif;
    --font-display: 'Frank Ruhl Libre', serif;

    --clr-patrol: #2563eb;
    --clr-patrol-bg: #dbeafe;
    --clr-guard: #16a34a;
    --clr-guard-bg: #dcfce7;
    --clr-kitchen: #d97706;
    --clr-kitchen-bg: #fef3c7;
    --clr-qrf: #dc2626;
    --clr-qrf-bg: #fee2e2;
  }

  [data-theme="dark"] {
    --clr-bg: #1a1714;
    --clr-surface: #242019;
    --clr-border: #3d362c;
    --clr-text: #e8e2da;
    --clr-text-secondary: #a89e92;
    --clr-text-tertiary: #7a7068;
    --clr-activity-bg: #1a2e1a;
    --clr-home-bg: #1a2340;
    --clr-accent-bg: #2a2540;
    --clr-warning-bg: #332a12;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.25);

    --clr-patrol-bg: #1a2340;
    --clr-guard-bg: #1a2e1a;
    --clr-kitchen-bg: #332a12;
    --clr-qrf-bg: #2e1a1a;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--font-body);
    background: var(--clr-bg);
    color: var(--clr-text);
    line-height: 1.5;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
  }

  [data-theme="dark"] body::before { opacity: 0.04; }

  .app {
    position: relative;
    z-index: 1;
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1.5rem 4rem;
  }

  /* Header */
  .header {
    text-align: center;
    margin-bottom: 2rem;
    animation: fadeInDown 0.6s ease-out;
  }

  .header__title {
    font-family: var(--font-display);
    font-weight: 900;
    font-size: clamp(2rem, 4.5vw, 3rem);
    color: var(--clr-text);
    letter-spacing: -0.02em;
    margin-bottom: 0.25rem;
  }

  .header__subtitle {
    font-weight: 300;
    font-size: 1rem;
    color: var(--clr-text-secondary);
  }

  .header__line {
    width: 60px;
    height: 3px;
    background: linear-gradient(90deg, var(--clr-accent), var(--clr-patrol));
    border-radius: 3px;
    margin: 0.75rem auto 0;
  }

  .header__nav-link {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    margin-top: 0.75rem;
    font-size: 0.85rem;
    font-weight: 400;
    color: var(--clr-text-tertiary);
    text-decoration: none;
    transition: color 0.2s;
  }
  .header__nav-link:hover { color: var(--clr-text-secondary); }
  .header__nav-link svg { width: 16px; height: 16px; flex-shrink: 0; }

  .btn--help-corner {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 100;
    font-size: 0.82rem;
    color: var(--clr-accent);
    border-color: var(--clr-accent);
    background: var(--clr-surface);
    box-shadow: var(--shadow-md);
  }

  /* Controls */
  .controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    animation: fadeInUp 0.6s ease-out 0.15s both;
  }

  .controls__group {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  /* Buttons */
  .btn {
    font-family: var(--font-body);
    font-size: 0.85rem;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: var(--radius);
    border: 1.5px solid var(--clr-border);
    background: var(--clr-surface);
    color: var(--clr-text);
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: var(--shadow-sm);
    white-space: nowrap;
    touch-action: manipulation;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
  }
  .btn:hover { border-color: #c4b8aa; background: #f5f1ec; }
  [data-theme="dark"] .btn { background: #2a2520; border-color: #3d362c; color: #a89e92; }
  [data-theme="dark"] .btn:hover { border-color: #5a5040; background: #332e27; }

  .btn--primary { border-color: var(--clr-accent); color: var(--clr-accent); }
  .btn--primary:hover { background: var(--clr-accent-bg); }
  [data-theme="dark"] .btn--primary { border-color: #7c3aed; color: #a78bfa; }
  [data-theme="dark"] .btn--primary:hover { background: #2a2540; }

  .btn--success { border-color: var(--clr-activity); color: #15803d; }
  .btn--success:hover { background: var(--clr-activity-bg); }
  [data-theme="dark"] .btn--success { border-color: var(--clr-activity); color: #4ade80; }
  [data-theme="dark"] .btn--success:hover { background: #1a2e1a; }

  .btn--danger { border-color: var(--clr-danger); color: var(--clr-danger); }
  .btn--danger:hover { background: #fee2e2; }

  .btn--warning { border-color: var(--clr-warning); color: #92400e; }
  .btn--warning:hover { background: var(--clr-warning-bg); }
  [data-theme="dark"] .btn--warning { border-color: #a07208; color: #f0c050; }
  [data-theme="dark"] .btn--warning:hover { background: #332a12; }

  .btn--filled { background: var(--clr-accent); color: #fff; border-color: var(--clr-accent); }
  .btn--filled:hover { background: #6d28d9; }

  .btn--sm { font-size: 0.78rem; padding: 0.35rem 0.65rem; }

  .btn--icon { padding: 0.5rem; min-width: 36px; justify-content: center; }
  .btn--icon svg { width: 18px; height: 18px; }

  .btn:disabled { opacity: 0.4; cursor: default; pointer-events: none; }

  /* View toggle */
  .view-toggle {
    display: inline-flex;
    border-radius: var(--radius);
    border: 1.5px solid var(--clr-border);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
  }
  .view-toggle__btn {
    font-family: var(--font-body);
    font-size: 0.82rem;
    font-weight: 500;
    padding: 0.5rem 0.85rem;
    border: none;
    background: var(--clr-surface);
    color: var(--clr-text-secondary);
    cursor: pointer;
    transition: all 0.2s;
  }
  .view-toggle__btn:last-child { border-inline-start: 1px solid var(--clr-border); }
  .view-toggle__btn:hover { background: #f5f1ec; }
  .view-toggle__btn--active { background: var(--clr-accent-bg); color: var(--clr-accent); font-weight: 600; }
  [data-theme="dark"] .view-toggle { border-color: #3d362c; }
  [data-theme="dark"] .view-toggle__btn { background: #2a2520; color: #a89e92; }
  [data-theme="dark"] .view-toggle__btn:last-child { border-color: #3d362c; }
  [data-theme="dark"] .view-toggle__btn:hover { background: #332e27; }
  [data-theme="dark"] .view-toggle__btn--active { background: #2a2540; color: #a78bfa; }

  /* Date navigator */
  .date-nav {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .date-nav__label {
    font-weight: 600;
    font-size: 1rem;
    min-width: 140px;
    text-align: center;
    cursor: pointer;
  }
  .date-nav__input {
    font-family: var(--font-body);
    font-size: 0.85rem;
    padding: 0.4rem 0.6rem;
    border: 1.5px solid var(--clr-border);
    border-radius: var(--radius);
    background: var(--clr-surface);
    color: var(--clr-text);
    display: none;
  }
  .date-nav__input--visible { display: block; }

  /* Shift cards */
  .shifts-container { display: flex; flex-direction: column; gap: 1rem; }

  .shift-card {
    background: var(--clr-surface);
    border: 1.5px solid var(--clr-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    transition: border-color 0.2s;
    animation: fadeInUp 0.3s ease-out both;
  }
  .shift-card:hover { border-color: #c4b8aa; }
  [data-theme="dark"] .shift-card:hover { border-color: #5a5040; }

  .shift-card__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--clr-border);
    gap: 0.5rem;
  }

  .shift-card__type {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-weight: 600;
    font-size: 0.95rem;
  }
  .shift-card__type-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .shift-card__time {
    font-size: 0.82rem;
    color: var(--clr-text-secondary);
    font-weight: 400;
    direction: ltr;
    unicode-bidi: embed;
  }

  .shift-card__badge {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.15rem 0.5rem;
    border-radius: 12px;
    white-space: nowrap;
  }
  .shift-card__badge--full { background: var(--clr-activity-bg); color: #15803d; }
  .shift-card__badge--partial { background: var(--clr-warning-bg); color: #92400e; }
  .shift-card__badge--empty { background: #fee2e2; color: #dc2626; }
  [data-theme="dark"] .shift-card__badge--full { background: #1a2e1a; color: #4ade80; }
  [data-theme="dark"] .shift-card__badge--partial { background: #332a12; color: #f0c050; }
  [data-theme="dark"] .shift-card__badge--empty { background: #2e1a1a; color: #f87171; }

  .shift-card__actions {
    display: flex;
    gap: 0.35rem;
    align-items: center;
  }
  .shift-card__action-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.2rem;
    color: var(--clr-text-tertiary);
    border-radius: 4px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
  }
  .shift-card__action-btn:hover { color: var(--clr-text); background: rgba(0,0,0,0.05); }
  .shift-card__action-btn svg { width: 16px; height: 16px; }

  .shift-card__body { padding: 0.75rem 1rem; }

  .shift-card__person {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.3rem 0;
    font-size: 0.88rem;
  }
  .shift-card__person-name { font-weight: 500; }
  .shift-card__person-role {
    font-size: 0.75rem;
    color: var(--clr-text-tertiary);
    background: rgba(0,0,0,0.04);
    padding: 0.1rem 0.4rem;
    border-radius: 4px;
  }
  [data-theme="dark"] .shift-card__person-role { background: rgba(255,255,255,0.06); }
  .shift-card__person--manual { position: relative; }
  .shift-card__person--manual::after {
    content: 'ğŸ“Œ';
    font-size: 0.7rem;
    margin-inline-start: 0.25rem;
  }
  .shift-card__person--duplicate {
    position: relative;
  }
  .shift-card__person--duplicate::before {
    content: 'âš ';
    font-size: 0.72rem;
    margin-inline-end: 0.2rem;
    color: var(--clr-warning);
  }
  .shift-card__person--duplicate .shift-card__person-name {
    color: var(--clr-warning);
    text-decoration: underline;
    text-decoration-style: wavy;
    text-underline-offset: 3px;
    text-decoration-color: var(--clr-warning);
  }

  .shift-card__note {
    margin-top: 0.5rem;
    padding: 0.4rem 0.6rem;
    background: var(--clr-warning-bg);
    border-radius: 6px;
    font-size: 0.8rem;
    color: #92400e;
  }
  [data-theme="dark"] .shift-card__note { background: #332a12; color: #f0c050; }

  .shift-card__empty {
    padding: 0.5rem 0;
    font-size: 0.82rem;
    color: var(--clr-text-tertiary);
    font-style: italic;
  }

  .shift-card--unassigned {
    border: 1.5px dashed var(--clr-border);
    border-right: 3px dashed var(--clr-text-tertiary);
    background: var(--clr-bg);
    opacity: 0.85;
  }
  .shift-card--unassigned .shift-card__header {
    border-bottom: 1px dashed var(--clr-border);
  }
  .shift-card--unassigned .shift-card__type-dot {
    background: var(--clr-text-tertiary) !important;
  }
  .shift-card--unassigned .shift-card__person-name {
    color: var(--clr-text-secondary);
  }

  /* Week / Gantt view */
  /* Week Summary Table */
  .week-summary {
    background: var(--clr-surface);
    border: 1.5px solid var(--clr-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    overflow-x: auto;
  }
  .week-summary__table {
    width: 100%;
    border-collapse: collapse;
    min-width: 400px;
  }
  .week-summary__table th {
    padding: 0.6rem 0.5rem;
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--clr-text-secondary);
    text-align: center;
    border-bottom: 2px solid var(--clr-border);
    white-space: nowrap;
  }
  .week-summary__table th:first-child {
    text-align: right;
    padding-right: 0.75rem;
    width: 100px;
  }
  .week-summary__day-row {
    cursor: pointer;
    transition: background 0.15s;
  }
  .week-summary__day-row:hover {
    background: var(--clr-accent-bg);
  }
  .week-summary__day-label {
    padding: 0.6rem 0.75rem;
    font-size: 0.85rem;
    font-weight: 600;
    border-bottom: 1px solid var(--clr-border);
    white-space: nowrap;
  }
  .week-summary__cell {
    padding: 0.5rem;
    text-align: center;
    font-size: 0.82rem;
    font-weight: 600;
    border-bottom: 1px solid var(--clr-border);
    border-inline-start: 1px solid rgba(0,0,0,0.03);
  }
  [data-theme="dark"] .week-summary__cell {
    border-inline-start-color: rgba(255,255,255,0.03);
  }
  .week-summary__cell--full {
    color: var(--clr-activity);
    background: var(--clr-activity-bg);
  }
  .week-summary__cell--partial {
    color: #d97706;
    background: rgba(217, 119, 6, 0.08);
  }
  .week-summary__cell--empty {
    color: var(--clr-danger);
    background: rgba(220, 38, 38, 0.06);
  }
  .week-summary__cell--none {
    color: var(--clr-text-tertiary);
    font-weight: 400;
  }
  .week-summary__today {
    background: var(--clr-accent-bg);
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s;
    padding: 1rem;
  }
  [data-theme="dark"] .modal-overlay { background: rgba(0,0,0,0.6); }

  .modal {
    background: var(--clr-surface);
    border-radius: var(--radius);
    box-shadow: var(--shadow-md);
    max-width: 700px;
    width: 100%;
    max-height: 85vh;
    overflow-y: auto;
    animation: scaleIn 0.25s ease-out;
  }

  .modal__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--clr-border);
    position: sticky;
    top: 0;
    background: var(--clr-surface);
    z-index: 2;
  }
  .modal__title { font-weight: 700; font-size: 1.1rem; }
  .modal__close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--clr-text-tertiary);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.2s;
  }
  .modal__close:hover { background: rgba(0,0,0,0.05); color: var(--clr-text); }
  [data-theme="dark"] .modal__close:hover { background: rgba(255,255,255,0.08); }

  .modal__body { padding: 1.25rem; }
  .modal__footer {
    padding: 0.75rem 1.25rem;
    border-top: 1px solid var(--clr-border);
    display: flex;
    justify-content: flex-start;
    gap: 0.5rem;
  }

  /* Form elements */
  .form-group { margin-bottom: 1rem; }
  .form-label {
    display: block;
    font-weight: 500;
    font-size: 0.88rem;
    margin-bottom: 0.35rem;
    color: var(--clr-text-secondary);
  }
  .form-input, .form-select, .form-textarea {
    font-family: var(--font-body);
    font-size: 0.88rem;
    padding: 0.5rem 0.75rem;
    border: 1.5px solid var(--clr-border);
    border-radius: 8px;
    background: var(--clr-surface);
    color: var(--clr-text);
    width: 100%;
    transition: border-color 0.2s;
  }
  .form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: var(--clr-accent);
  }
  [data-theme="dark"] .form-input, [data-theme="dark"] .form-select, [data-theme="dark"] .form-textarea {
    background: #1a1714;
    border-color: #3d362c;
    color: #e8e2da;
  }
  .form-textarea { resize: vertical; min-height: 60px; }
  .form-row { display: flex; gap: 0.75rem; }
  .form-row > * { flex: 1; }
  .form-hint { font-size: 0.75rem; color: var(--clr-text-tertiary); margin-top: 0.2rem; }

  /* Checkbox grid */
  .checkbox-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 0.4rem;
  }
  .checkbox-grid label {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.82rem;
    padding: 0.3rem 0.4rem;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .checkbox-grid label:hover { background: rgba(0,0,0,0.03); }
  [data-theme="dark"] .checkbox-grid label:hover { background: rgba(255,255,255,0.04); }

  /* Tabs in modal */
  .tabs {
    display: flex;
    gap: 0;
    border-bottom: 2px solid var(--clr-border);
    margin-bottom: 1rem;
    overflow-x: auto;
  }
  .tabs__tab {
    font-family: var(--font-body);
    font-size: 0.82rem;
    font-weight: 500;
    padding: 0.6rem 1rem;
    border: none;
    background: none;
    color: var(--clr-text-secondary);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .tabs__tab:hover { color: var(--clr-text); }
  .tabs__tab--active { color: var(--clr-accent); border-bottom-color: var(--clr-accent); font-weight: 600; }
  .tab-panel { display: none; }
  .tab-panel--active { display: block; }

  /* Item list (for mission types, buddy rules) */
  .item-list { display: flex; flex-direction: column; gap: 0.5rem; }
  .item-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: rgba(0,0,0,0.02);
    border-radius: 8px;
    font-size: 0.85rem;
  }
  [data-theme="dark"] .item-row { background: rgba(255,255,255,0.03); }
  .item-row__dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .item-row__name { font-weight: 500; flex: 1; }
  .item-row__detail { color: var(--clr-text-tertiary); font-size: 0.78rem; }
  .item-row__actions { display: flex; gap: 0.25rem; }
  .item-row__btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--clr-text-tertiary);
    padding: 0.15rem;
    border-radius: 4px;
    transition: all 0.2s;
  }
  .item-row__btn:hover { color: var(--clr-danger); background: #fee2e2; }
  .item-row__btn svg { width: 14px; height: 14px; }

  /* Fairness table */
  .fairness-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.82rem;
  }
  .fairness-table th {
    text-align: right;
    padding: 0.5rem 0.6rem;
    font-weight: 600;
    border-bottom: 2px solid var(--clr-border);
    color: var(--clr-text-secondary);
    white-space: nowrap;
  }
  .fairness-table td {
    padding: 0.45rem 0.6rem;
    border-bottom: 1px solid var(--clr-border);
  }
  .fairness-bar {
    height: 8px;
    border-radius: 4px;
    background: var(--clr-accent);
    transition: width 0.5s ease-out;
  }
  .fairness-bar-cell { min-width: 80px; }

  /* Alerts panel */
  .alerts-panel {
    background: var(--clr-surface);
    border: 1.5px solid var(--clr-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    margin-bottom: 1rem;
    animation: fadeInUp 0.3s ease-out;
  }
  .alerts-panel__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.6rem 1rem;
    border-bottom: 1px solid var(--clr-border);
    font-weight: 600;
    font-size: 0.88rem;
  }
  .alerts-panel__list { padding: 0.5rem 1rem; }
  .alert-item {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    padding: 0.4rem 0;
    font-size: 0.82rem;
    border-bottom: 1px solid rgba(0,0,0,0.04);
  }
  .alert-item:last-child { border-bottom: none; }
  .alert-item__icon { flex-shrink: 0; font-size: 0.9rem; margin-top: 0.1rem; }
  .alert-item__text { flex: 1; }
  .alert-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 18px;
    height: 18px;
    padding: 0 4px;
    border-radius: 9px;
    font-size: 0.68rem;
    font-weight: 700;
    color: #fff;
    background: var(--clr-danger);
  }

  /* Theme toggle */
  .theme-toggle {
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 100;
    background: var(--clr-surface);
    border: 1.5px solid var(--clr-border);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: var(--shadow-sm);
    transition: all 0.2s;
  }
  .theme-toggle:hover { border-color: #c4b8aa; }
  .theme-toggle svg { width: 20px; height: 20px; stroke: var(--clr-text-secondary); fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
  [data-theme="dark"] .theme-toggle { background: #2a2520; border-color: #3d362c; }

  /* Toast */
  .toast-container {
    position: fixed;
    top: 1.5rem;
    left: 50%;
    transform: translateX(-50%);
    z-index: 2000;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    align-items: center;
  }
  .toast {
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    color: #fff;
    font-size: 0.85rem;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: toastIn 0.3s ease-out;
    max-width: 400px;
    text-align: center;
  }
  .toast--success { background: #15803d; }
  .toast--error { background: #dc2626; }
  .toast--info { background: #2563eb; }
  .toast--warning { background: #d97706; }
  .toast--action { display: flex; align-items: center; gap: 0.75rem; }
  .toast__undo-btn { background: rgba(255,255,255,0.25); color: #fff; border: 1px solid rgba(255,255,255,0.4); padding: 0.2rem 0.6rem; border-radius: 4px; cursor: pointer; font-family: var(--font-body); font-size: 0.8rem; }
  .toast__undo-btn:hover { background: rgba(255,255,255,0.4); }

  .calendar-data-banner {
    background: var(--clr-warning-bg);
    color: #92400e;
    border: 1px solid var(--clr-warning);
    border-radius: var(--radius);
    padding: 0.5rem 1rem;
    margin-bottom: 1rem;
    font-size: 0.85rem;
    text-align: center;
  }

  .conflict-badge { color: var(--clr-danger); cursor: help; font-size: 0.85rem; margin-right: 0.2rem; }

  .confirm-modal__message { font-size: 0.95rem; line-height: 1.6; color: var(--clr-text-secondary); margin-bottom: 0.5rem; }

  /* Loading spinner */
  .loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.2);
    z-index: 1500;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--clr-border);
    border-top-color: var(--clr-accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--clr-text-tertiary);
  }
  .empty-state__icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
  .empty-state__text { font-size: 0.95rem; margin-bottom: 1rem; }

  /* Animations */
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes fadeInDown { from { opacity: 0; transform: translateY(-15px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  @keyframes toastIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-10px); } }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Print */
  @media print {
    .controls, .theme-toggle, .toast-container, .btn, .header__nav-link, .shift-card--unassigned { display: none !important; }
    .app { padding: 0; }
    .shift-card { break-inside: avoid; }
  }

  /* Person history tooltip */
  .person-tooltip {
    position: fixed;
    z-index: 2000;
    background: var(--clr-text);
    color: var(--clr-bg);
    border-radius: 8px;
    padding: 0.6rem 0.8rem;
    font-size: 0.78rem;
    direction: rtl;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s ease;
    max-width: 320px;
    line-height: 1.6;
  }
  .person-tooltip--visible { opacity: 1; }
  .person-tooltip__title {
    font-weight: 700;
    margin-bottom: 0.3rem;
    font-size: 0.82rem;
  }
  .person-tooltip__divider {
    border: none;
    border-top: 1px solid rgba(255,255,255,0.2);
    margin: 0.3rem 0;
  }
  .person-tooltip__row {
    display: flex;
    justify-content: space-between;
    gap: 0.5rem;
  }
  .person-tooltip__empty {
    color: rgba(255,255,255,0.6);
    font-style: italic;
  }
  [data-theme="dark"] .person-tooltip {
    background: var(--clr-surface);
    color: var(--clr-text);
    border: 1px solid var(--clr-border);
  }
  [data-theme="dark"] .person-tooltip__divider {
    border-top-color: var(--clr-border);
  }
  [data-theme="dark"] .person-tooltip__empty {
    color: var(--clr-text-tertiary);
  }


  /* Responsive */
  @media (max-width: 768px) {
    .controls__group { flex-wrap: wrap; justify-content: center; }
    .form-row { flex-direction: column; }
    .week-summary__table { min-width: 350px; }
    .fairness-table { font-size: 0.75rem; }
    .modal { max-width: 95vw; max-height: 90vh; }
  }
</style>
</head>
<body>

<button class="theme-toggle" id="themeToggle" title="××¦×‘ ×›×”×”/×‘×”×™×¨">
  <svg viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
  </svg>
</button>

<div id="toastContainer" class="toast-container"></div>

<div class="app">
  <header class="header">
    <h1 class="header__title">×©×‘×¦×´×§ â€” ×¤×œ×•×’×” ×‘</h1>
    <p class="header__subtitle" id="headerSubtitle"></p>
    <div class="header__line"></div>
    <a class="header__nav-link" href="index.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      ×œ×•×— ×©× ×”
    </a>
  </header>

  <div class="controls">
    <div class="controls__group">
      <div class="date-nav" id="dateNav">
        <button class="btn btn--icon" id="btnPrevDay" title="×™×•× ×§×•×“×">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        </button>
        <span class="date-nav__label" id="dateLabel"></span>
        <input type="date" class="date-nav__input" id="datePicker">
        <button class="btn btn--icon" id="btnNextDay" title="×™×•× ×”×‘×">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
      </div>
      <div class="view-toggle" id="viewToggle">
        <button class="view-toggle__btn view-toggle__btn--active" id="btnDayView">×ª×¦×•×’×ª ×™×•×</button>
        <button class="view-toggle__btn" id="btnWeekView">×ª×¦×•×’×ª ×©×‘×•×¢</button>
      </div>
    </div>
    <div class="controls__group">
      <button class="btn btn--primary" id="btnConfig">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        ×”×’×“×¨×•×ª
      </button>
      <button class="btn btn--filled" id="btnGenerate">×©×™×‘×•×¥ ××•×˜×•××˜×™</button>
      <button class="btn btn--warning" id="btnFairness">×”×•×’× ×•×ª</button>
      <button class="btn" id="btnAlerts">
        ×”×ª×¨××•×ª
        <span class="alert-badge" id="alertBadge" style="display:none;">0</span>
      </button>
      <button class="btn btn--success" id="btnExportPdf">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        ×™×™×¦×•× PDF
      </button>
      <button class="btn btn--danger" id="btnDeleteDay">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        ××—×§ ××©××¨×•×ª
      </button>
    </div>
  </div>
  <button class="btn btn--outline btn--help-corner" id="btnHelp" title="×¢×–×¨×”">×”×•×¨××•×ª ×©×™××•×©</button>

  <div id="alertsPanel" style="display:none;"></div>

  <div id="mainContent">
    <div class="empty-state" id="emptyState">
      <div class="empty-state__icon">ğŸ“‹</div>
      <div class="empty-state__text">××™×Ÿ ××©××¨×•×ª ×œ×™×•× ×–×”</div>
      <button class="btn btn--primary" id="btnCreateShifts">×¦×•×¨ ××©××¨×•×ª ××ª×‘× ×™×ª</button>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  // ===================== CONSTANTS =====================

  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx7tIx9awHDsdXZ0y01QElrDNv4F9sy_7ENDFVlHPOns7H-KhRrHLGJG5zhpuVBZ_YV0A/exec';
  const DATE_START = '2026-04-26';
  const DATE_END = '2026-06-18';

  const DAY_NAMES = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
  const GREG_MONTHS = { 3: '××¤×¨×™×œ', 4: '×××™', 5: '×™×•× ×™' };

  const ROLE_LABELS = { officer: '×§×¦×™×Ÿ', commander: '××¤×§×“', driver: '× ×”×’', member: '×—×™×™×œ' };

  const DEFAULT_MISSION_TYPES = [
    { id: 'patrol', name: '×¡×™×•×¨', duration_hours: 8, min_team: 3, requires_commander: true, requires_driver: true, requires_officer: false, color: '#2563eb', fixed_people: [] },
    { id: 'guard', name: '×©××™×¨×”', duration_hours: 4, min_team: 1, requires_commander: false, requires_driver: false, requires_officer: false, color: '#16a34a', fixed_people: [] },
    { id: 'kitchen', name: '×ª×•×¨× ×•×ª ××˜×‘×—', duration_hours: 24, min_team: 1, requires_commander: false, requires_driver: false, requires_officer: false, color: '#d97706', fixed_people: [] },
    { id: 'qrf', name: '×›×— ×›×•× ×Ÿ', duration_hours: 24, min_team: 3, requires_commander: true, requires_driver: false, requires_officer: false, color: '#dc2626', fixed_people: [] }
  ];

  const DEFAULT_SCHEDULING_PARAMS = {
    min_rest_hours: 8,
    max_consecutive_days: 5,
    enforce_consecutive_limit: false
  };

  const DEFAULT_SHIFT_TEMPLATES = [
    { mission_type: 'patrol', start_time: '06:00', end_time: '14:00' },
    { mission_type: 'patrol', start_time: '14:00', end_time: '22:00' },
    { mission_type: 'patrol', start_time: '22:00', end_time: '06:00' },
    { mission_type: 'guard', start_time: '06:00', end_time: '10:00' },
    { mission_type: 'guard', start_time: '10:00', end_time: '14:00' },
    { mission_type: 'guard', start_time: '14:00', end_time: '18:00' },
    { mission_type: 'guard', start_time: '18:00', end_time: '22:00' },
    { mission_type: 'guard', start_time: '22:00', end_time: '02:00' },
    { mission_type: 'guard', start_time: '02:00', end_time: '06:00' },
    { mission_type: 'kitchen', start_time: '00:00', end_time: '00:00' },
    { mission_type: 'qrf', start_time: '22:00', end_time: '22:00' }
  ];

  // ===================== STATE =====================

  let currentDate = new Date();
  let currentView = 'day'; // 'day' | 'week'
  let config = {};
  let missionTypes = [...DEFAULT_MISSION_TYPES];
  let personnelTags = {};
  let exclusions = {};
  let buddyRules = [];
  let schedulingParams = { ...DEFAULT_SCHEDULING_PARAMS };
  let shiftTemplates = [...DEFAULT_SHIFT_TEMPLATES];
  let shifts = [];
  let recentShifts = []; // shifts from 3 days before current view, for tooltip
  let calendarData = null; // { map, names }
  let alertsList = [];
  let isLoading = false;
  let isBusy = false;
  let calendarDataFailed = false;

  // Performance: Map for O(1) mission type lookups
  let missionTypeMap = new Map();
  function buildMissionTypeMap() {
    missionTypeMap = new Map(missionTypes.map(m => [m.id, m]));
  }
  buildMissionTypeMap(); // initial build from DEFAULT_MISSION_TYPES

  // Performance: pre-index shifts by date for O(1) lookups
  let shiftsByDateIndex = new Map();
  function buildShiftsByDateIndex() {
    shiftsByDateIndex = new Map();
    shifts.forEach(s => {
      if (!shiftsByDateIndex.has(s.date)) shiftsByDateIndex.set(s.date, []);
      shiftsByDateIndex.get(s.date).push(s);
    });
  }

  // ===================== CONFIG GUARD =====================

  function isConfigSaved() {
    return !!config.mission_types;
  }

  function requireConfig() {
    if (!isConfigSaved()) {
      showToast('×™×© ×œ×”×’×“×™×¨ ×•×œ×©××•×¨ ×”×’×“×¨×•×ª (âš™ï¸) ×œ×¤× ×™ ×©×™×‘×•×¥ ××©××¨×•×ª', 'error', 5000);
      return false;
    }
    return true;
  }

  // ===================== UTILITIES =====================

  function formatDateStr(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${dd}`;
  }

  function parseDateStr(s) {
    const [y, m, d] = s.split('-').map(Number);
    return new Date(y, m - 1, d);
  }

  function formatDateHebrew(d) {
    const day = DAY_NAMES[d.getDay()];
    const dd = d.getDate();
    const month = GREG_MONTHS[d.getMonth()] || '';
    return `×™×•× ${day}, ${dd} ${month ? '×‘' + month : ''}`;
  }

  function escapeHtml(str) {
    if (str == null || str === '') return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function generateId(date, missionType, startTime) {
    return `${date}_${missionType}_${startTime.replace(':', '')}`;
  }

  function timeToMinutes(t) {
    const [h, m] = t.split(':').map(Number);
    return h * 60 + m;
  }

  function shiftsOverlap(a, b) {
    if (a.date !== b.date) return false;
    // All-day shifts always overlap
    if (a.start_time === a.end_time || b.start_time === b.end_time) return true;
    let aStart = timeToMinutes(a.start_time), aEnd = timeToMinutes(a.end_time);
    let bStart = timeToMinutes(b.start_time), bEnd = timeToMinutes(b.end_time);
    if (aEnd <= aStart) aEnd += 1440;
    if (bEnd <= bStart) bEnd += 1440;
    return aStart < bEnd && bStart < aEnd;
  }

  function shiftDurationHours(start, end) {
    let s = timeToMinutes(start);
    let e = timeToMinutes(end);
    if (e <= s) e += 1440; // overnight
    return (e - s) / 60;
  }


  // Effective shift times considering actual_end_time for all-day shifts
  function getEffectiveDuration(shift) {
    if (shift.start_time === shift.end_time) {
      if (shift.actual_end_time) {
        return shiftDurationHours('06:00', shift.actual_end_time);
      }
      return 24;
    }
    return shiftDurationHours(shift.start_time, shift.end_time);
  }

  function getEffectiveLastEnd(shift) {
    if (shift.start_time === shift.end_time && shift.actual_end_time) {
      return new Date(shift.date + 'T' + shift.actual_end_time + ':00');
    }
    const endTime = shift.end_time === '00:00' ? '24:00' : shift.end_time;
    const shiftEnd = new Date(shift.date + 'T' + endTime + ':00');
    if (shift.end_time !== shift.start_time && timeToMinutes(shift.end_time) <= timeToMinutes(shift.start_time)) {
      shiftEnd.setDate(shiftEnd.getDate() + 1);
    }
    return shiftEnd;
  }

  function getEffectiveShiftRange(shift) {
    if (shift.start_time === shift.end_time && shift.actual_end_time) {
      return { start: '06:00', end: shift.actual_end_time };
    }
    return { start: shift.start_time, end: shift.end_time };
  }

  function getPersonRecentHistory(personName) {
    const entries = [];
    recentShifts.forEach(function(shift) {
      const assigned = shift.assignments || [];
      const match = assigned.find(function(a) { return a.name === personName; });
      if (match) {
        const mt = getMissionType(shift.mission_type);
        const mtName = mt ? mt.name : shift.mission_type;
        const tLabel = shift.start_time === shift.end_time
          ? '×™×•× ×©×œ×'
          : shift.start_time + '-' + shift.end_time;
        const d = parseDateStr(shift.date);
        const dayName = DAY_NAMES[d.getDay()];
        const dd = d.getDate();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        entries.push({
          date: shift.date,
          dayName: dayName,
          dateLabel: dd + '/' + mm,
          mtName: mtName,
          timeLabel: tLabel
        });
      }
    });
    entries.sort(function(a, b) { return a.date.localeCompare(b.date); });
    return entries;
  }

  function getDuplicateNames(dateStr) {
    const dayShifts = shiftsByDateIndex.get(dateStr) || [];
    const nameCount = {};
    dayShifts.forEach(function(shift) {
      (shift.assignments || []).forEach(function(a) {
        nameCount[a.name] = (nameCount[a.name] || 0) + 1;
      });
    });
    const duplicates = new Set();
    Object.keys(nameCount).forEach(function(name) {
      if (nameCount[name] > 1) duplicates.add(name);
    });
    return duplicates;
  }

  function getUnassignedPersonnel(dateStr) {
    const available = getAvailablePersonnel(dateStr);
    if (available.length === 0) return [];
    const dayShifts = shiftsByDateIndex.get(dateStr) || [];
    const assignedNames = new Set();
    dayShifts.forEach(function(shift) {
      (shift.assignments || []).forEach(function(a) {
        assignedNames.add(a.name);
      });
    });
    return available.filter(function(name) {
      return !assignedNames.has(name);
    });
  }

  function getMissionType(id) {
    return missionTypeMap.get(id);
  }

  function getPersonRole(name) {
    const tags = personnelTags[name] || [];
    if (tags.includes('officer')) return 'officer';
    if (tags.includes('commander')) return 'commander';
    if (tags.includes('driver')) return 'driver';
    return 'member';
  }

  // Sort shifts by (mission_type order, then start_time)
  function sortShiftsByTypeAndTime(shiftList) {
    const typeOrder = {};
    missionTypes.forEach((mt, i) => { typeOrder[mt.id] = i; });
    shiftList.sort((a, b) => {
      const orderA = typeOrder[a.mission_type] !== undefined ? typeOrder[a.mission_type] : 999;
      const orderB = typeOrder[b.mission_type] !== undefined ? typeOrder[b.mission_type] : 999;
      if (orderA !== orderB) return orderA - orderB;
      return timeToMinutes(a.start_time) - timeToMinutes(b.start_time);
    });
  }

  function getWeekDates(baseDate) {
    const dates = [];
    const d = new Date(baseDate);
    const day = d.getDay();
    d.setDate(d.getDate() - day); // go to Sunday
    for (let i = 0; i < 7; i++) {
      dates.push(new Date(d));
      d.setDate(d.getDate() + 1);
    }
    return dates;
  }

  // ===================== TOAST =====================

  function showToast(message, type, duration, actionLabel, actionCallback) {
    type = type || 'info';
    duration = duration || 3000;
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'toast toast--' + type;
    if (actionLabel && actionCallback) {
      toast.classList.add('toast--action');
      toast.textContent = message;
      const btn = document.createElement('button');
      btn.className = 'toast__undo-btn';
      btn.textContent = actionLabel;
      btn.addEventListener('click', () => { toast.remove(); actionCallback(); });
      toast.appendChild(btn);
    } else {
      toast.textContent = message;
    }
    container.appendChild(toast);
    setTimeout(() => {
      toast.style.animation = 'toastOut 0.3s ease-in forwards';
      toast.addEventListener('animationend', () => toast.remove());
    }, duration);
  }

  // ===================== API =====================

  async function callAppsScript(payload) {
    if (APPS_SCRIPT_URL === 'YOUR_DEPLOYED_APPS_SCRIPT_URL_HERE') {
      showToast('×™×© ×œ×”×’×“×™×¨ ××ª ×›×ª×•×‘×ª Apps Script', 'error', 4000);
      throw new Error('Apps Script URL not configured');
    }
    try {
      const resp = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
      });
      const result = await resp.json();
      if (!result.success) throw new Error(result.error || '×©×’×™××” ×œ× ×™×“×•×¢×”');
      return result;
    } catch (err) {
      showToast('×©×’×™××”: ' + err.message, 'error', 5000);
      throw err;
    }
  }

  function showLoading() {
    if (isLoading) return;
    isLoading = true;
    isBusy = true;
    const el = document.createElement('div');
    el.id = 'loadingOverlay';
    el.className = 'loading-overlay';
    el.innerHTML = '<div class="spinner"></div>';
    document.body.appendChild(el);
  }

  function hideLoading() {
    isLoading = false;
    isBusy = false;
    const el = document.getElementById('loadingOverlay');
    if (el) el.remove();
  }

  // ===================== DATA LOADING =====================

  async function loadConfig() {
    try {
      const result = await callAppsScript({ action: 'getRosterConfig' });
      config = result.config || {};

      if (config.mission_types) {
        try {
          missionTypes = JSON.parse(config.mission_types);
          // Ensure requires_officer field exists (backward compat)
          missionTypes.forEach(mt => { if (mt.requires_officer === undefined) mt.requires_officer = false; if (!mt.fixed_people) mt.fixed_people = []; });
          buildMissionTypeMap();
        } catch(e) { showToast('×©×’×™××ª ×˜×¢×™× ×ª ×”×’×“×¨×•×ª: ×¡×•×’×™ ××©×™××•×ª, × ×˜×¢× ×• ×‘×¨×™×¨×•×ª ××—×“×œ', 'error', 5000); }
      }
      if (config.personnel_tags) {
        try { personnelTags = JSON.parse(config.personnel_tags); } catch(e) { showToast('×©×’×™××ª ×˜×¢×™× ×ª ×”×’×“×¨×•×ª: ×ª×’×™×•×ª ×›×•×— ××“×, × ×˜×¢× ×• ×‘×¨×™×¨×•×ª ××—×“×œ', 'error', 5000); }
      }
      if (config.exclusions) {
        try { exclusions = JSON.parse(config.exclusions); } catch(e) { showToast('×©×’×™××ª ×˜×¢×™× ×ª ×”×’×“×¨×•×ª: ×”×—×¨×’×•×ª, × ×˜×¢× ×• ×‘×¨×™×¨×•×ª ××—×“×œ', 'error', 5000); }
      }
      if (config.buddy_rules) {
        try { buddyRules = JSON.parse(config.buddy_rules); } catch(e) { showToast('×©×’×™××ª ×˜×¢×™× ×ª ×”×’×“×¨×•×ª: ×›×œ×œ×™ ×¦××“, × ×˜×¢× ×• ×‘×¨×™×¨×•×ª ××—×“×œ', 'error', 5000); }
      }
      if (config.scheduling_params) {
        try { schedulingParams = { ...DEFAULT_SCHEDULING_PARAMS, ...JSON.parse(config.scheduling_params) }; } catch(e) { showToast('×©×’×™××ª ×˜×¢×™× ×ª ×”×’×“×¨×•×ª: ×¤×¨××˜×¨×™ ×©×™×‘×•×¥, × ×˜×¢× ×• ×‘×¨×™×¨×•×ª ××—×“×œ', 'error', 5000); }
      }
      if (config.shift_templates) {
        try { shiftTemplates = JSON.parse(config.shift_templates); } catch(e) { showToast('×©×’×™××ª ×˜×¢×™× ×ª ×”×’×“×¨×•×ª: ×ª×‘× ×™×•×ª ××©××¨×ª, × ×˜×¢× ×• ×‘×¨×™×¨×•×ª ××—×“×œ', 'error', 5000); }
      }
    } catch (err) {
      console.warn('Failed to load roster config, using defaults');
    }
  }

  async function saveConfigKey(key, value) {
    const json = typeof value === 'string' ? value : JSON.stringify(value);
    await callAppsScript({ action: 'saveRosterConfig', key, value: json });
    config[key] = json;
  }

  async function loadShifts(startDate, endDate) {
    try {
      const result = await callAppsScript({
        action: 'getRosterShifts',
        startDate: startDate || formatDateStr(currentDate),
        endDate: endDate || formatDateStr(currentDate)
      });
      const shifts = result.shifts || [];
      // Normalize is_manual: Google Sheets may return boolean true which
      // becomes lowercase "true" via String(), but all comparisons expect 'TRUE'
      shifts.forEach(s => {
        (s.assignments || []).forEach(a => {
          a.is_manual = String(a.is_manual || '').toUpperCase() === 'TRUE' ? 'TRUE' : 'FALSE';
        });
      });
      return shifts;
    } catch (err) {
      showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ××©××¨×•×ª', 'error');
      return [];
    }
  }

  async function loadCalendarData() {
    try {
      const result = await callAppsScript({ action: 'getData' });
      const rows = result.rows || [];
      const map = {};
      const namesSet = new Set();
      rows.forEach(r => {
        const name = r.name;
        const date = r.date;
        const status = r.status;
        namesSet.add(name);
        if (!map[date]) map[date] = {};
        map[date][name] = status;
      });
      calendarData = { map, names: [...namesSet] };
    } catch (err) {
      calendarDataFailed = true;
      showToast('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×œ×•×— ×©× ×” â€” ×™×™×ª×›×Ÿ ×©×”×–××™× ×•×ª ×œ× ××“×•×™×§×ª', 'error', 6000);
      calendarData = { map: {}, names: [] };
    }
  }

  function getAvailablePersonnel(date) {
    if (!calendarData) return [];
    const dateStr = typeof date === 'string' ? date : formatDateStr(date);
    const dayData = calendarData.map[dateStr] || {};
    return calendarData.names.filter(name => {
      const status = dayData[name];
      return status === 'activity' || status === 'switch-base';
    });
  }

  // ===================== SHIFT OPERATIONS =====================

  async function createShiftsFromTemplate(startDate, endDate) {
    const start = parseDateStr(startDate);
    const end = parseDateStr(endDate);
    const newShifts = [];
    const fixedAssignments = [];

    const d = new Date(start);
    while (d <= end) {
      const dateStr = formatDateStr(d);
      shiftTemplates.forEach(t => {
        const id = generateId(dateStr, t.mission_type, t.start_time);
        const shift = {
          id,
          date: dateStr,
          mission_type: t.mission_type,
          start_time: t.start_time,
          end_time: t.end_time,
          note: ''
        };
        if (t.rest_end_time) shift.actual_end_time = t.rest_end_time;
        newShifts.push(shift);

        // Auto-assign fixed people for this mission type
        const mt = getMissionType(t.mission_type);
        if (mt && mt.fixed_people && mt.fixed_people.length > 0) {
          mt.fixed_people.forEach(name => {
            fixedAssignments.push({
              shift_id: id,
              name: name,
              role: getPersonRole(name),
              is_manual: 'TRUE'
            });
          });
        }
      });
      d.setDate(d.getDate() + 1);
    }

    if (newShifts.length === 0) return;

    showLoading();
    try {
      await callAppsScript({ action: 'saveRosterShifts', shifts: newShifts });
      if (fixedAssignments.length > 0) {
        await callAppsScript({ action: 'saveRosterAssignments', assignments: fixedAssignments });
      }
      showToast(`× ×•×¦×¨×• ${newShifts.length} ××©××¨×•×ª ×‘×”×¦×œ×—×”`, 'success');
      await refreshView();
    } catch (err) {
      // toast already shown
    } finally {
      hideLoading();
    }
  }

  async function deleteShift(shiftId) {
    if (isBusy) { showToast('×¤×¢×•×œ×” ×‘×ª×”×œ×™×š, × × ×œ×”××ª×™×Ÿ', 'info'); return; }
    showLoading();
    try {
      await callAppsScript({ action: 'deleteRosterShifts', ids: [shiftId] });
      showToast('×”××©××¨×ª × ××—×§×”', 'success');
      await refreshView();
    } catch (err) {
      // toast shown
    } finally {
      hideLoading();
    }
  }

  async function saveShiftNote(shiftId, note) {
    const shift = shifts.find(s => s.id === shiftId);
    if (!shift) return;
    const oldNote = shift.note;
    shift.note = note;
    try {
      await callAppsScript({ action: 'saveRosterShifts', shifts: [shift] });
      buildShiftsByDateIndex();
      showToast('×”×”×¢×¨×” × ×©××¨×”', 'success');
    } catch (err) {
      shift.note = oldNote;
    }
  }

  // ===================== AUTO-SCHEDULING ALGORITHM =====================

  function autoSchedule(targetShifts, allAssignments) {
    const results = [];
    const warnings = [];

    // Performance: O(1) shift lookup by id
    const shiftMap = new Map(shifts.map(s => [s.id, s]));

    // Build history for fairness: name -> { totalHours, missionCounts, lastEnd, consecutiveDays }
    const history = {};
    if (calendarData) {
      calendarData.names.forEach(name => {
        history[name] = { totalHours: 0, missionCounts: {}, lastEnd: null, consecutiveDays: 0 };
      });
    }

    // Process existing assignments into history
    allAssignments.forEach(a => {
      const shift = shiftMap.get(a.shift_id);
      if (!shift || !history[a.name]) return;
      const dur = getEffectiveDuration(shift);
      history[a.name].totalHours += dur;

      history[a.name].missionCounts[shift.mission_type] = (history[a.name].missionCounts[shift.mission_type] || 0) + 1;

      // Track lastEnd for rest gap enforcement
      const shiftEnd = getEffectiveLastEnd(shift);
      if (!history[a.name].lastEnd || shiftEnd > history[a.name].lastEnd) {
        history[a.name].lastEnd = shiftEnd;
      }
    });

    // Group shifts by date then sort by constraint difficulty
    const shiftsByDate = {};
    targetShifts.forEach(s => {
      if (!shiftsByDate[s.date]) shiftsByDate[s.date] = [];
      shiftsByDate[s.date].push(s);
    });

    const sortedDates = Object.keys(shiftsByDate).sort();
    // Track assignments made in this run: name -> { byDate: Map<date, entries[]>, all: entries[] }
    const newAssignments = {};

    function addNewAssignment(name, entry) {
      if (!newAssignments[name]) newAssignments[name] = { byDate: new Map(), all: [] };
      newAssignments[name].all.push(entry);
      if (!newAssignments[name].byDate.has(entry.date)) newAssignments[name].byDate.set(entry.date, []);
      newAssignments[name].byDate.get(entry.date).push(entry);
    }

    // Pre-seed newAssignments with ALL manual assignments across ALL target shifts
    // so manually-pinned people are excluded from being auto-assigned to other shifts
    for (const date of sortedDates) {
      const dayShifts = shiftsByDate[date];
      for (const shift of dayShifts) {
        (shift.assignments || [])
          .filter(a => a.is_manual === 'TRUE')
          .forEach(a => {
            const effRange = getEffectiveShiftRange(shift);
            addNewAssignment(a.name, { date, start: effRange.start, end: effRange.end, shiftId: shift.id });
          });
      }
    }

    // Track which dates each person was assigned (for consecutive day counting)
    const assignedOnDate = {}; // name -> Set of date strings

    for (const date of sortedDates) {
      const dayShifts = shiftsByDate[date];
      const available = getAvailablePersonnel(date);

      // Update consecutive days for each person before this day's assignments
      const prevDate = new Date(parseDateStr(date));
      prevDate.setDate(prevDate.getDate() - 1);
      const prevDateStr = formatDateStr(prevDate);

      if (calendarData) {
        calendarData.names.forEach(name => {
          if (!history[name]) return;
          const wasAssignedYesterday = assignedOnDate[name] && assignedOnDate[name].has(prevDateStr);
          const statusToday = calendarData.map[date] && calendarData.map[date][name];
          const isHome = statusToday === 'home' || statusToday === 'switch-home';

          if (isHome || !wasAssignedYesterday) {
            // Went home or wasn't assigned yesterday â†’ reset
            history[name].consecutiveDays = 0;
          }
          // consecutiveDays will be incremented after assignment below
        });
      }

      // Sort shifts: most constrained first (role requirements, then by min_team desc)
      dayShifts.sort((a, b) => {
        const ma = getMissionType(a.mission_type);
        const mb = getMissionType(b.mission_type);
        const scoreA = (ma && ma.requires_officer ? 20 : 0) + (ma && ma.requires_commander ? 10 : 0) + (ma && ma.requires_driver ? 10 : 0) + (ma ? ma.min_team : 0);
        const scoreB = (mb && mb.requires_officer ? 20 : 0) + (mb && mb.requires_commander ? 10 : 0) + (mb && mb.requires_driver ? 10 : 0) + (mb ? mb.min_team : 0);
        return scoreB - scoreA;
      });

      for (const shift of dayShifts) {
        const mt = getMissionType(shift.mission_type);
        if (!mt) continue;
        const minTeam = mt.min_team;

        // Pre-placed manual assignments
        const manualAssigned = (shift.assignments || [])
          .filter(a => a.is_manual === 'TRUE')
          .map(a => a.name);
        const manualSet = new Set(manualAssigned);

        const needed = minTeam - manualAssigned.length;
        if (needed <= 0) {
          // Manual assignments are already preserved in the DB (clearManual: false)
          // No need to re-emit them â€” just skip this shift
          continue;
        }

        // Filter candidates
        const candidates = available.filter(name => {
          if (manualSet.has(name)) return false;

          // Exclusion check
          if (exclusions[name] && exclusions[name].includes(shift.mission_type)) return false;

          // Already assigned to overlapping or too-close shift today?
          const myRec = newAssignments[name];
          const myDayAssignments = myRec ? (myRec.byDate.get(date) || []) : [];
          const restMinutes = schedulingParams.min_rest_hours * 60;
          const sRange = getEffectiveShiftRange(shift);
          let sStart = timeToMinutes(sRange.start);
          let sEnd = timeToMinutes(sRange.end);
          if (sEnd <= sStart) sEnd += 1440;
          const hasConflict = myDayAssignments.some(a => {
            let aStart = timeToMinutes(a.start);
            let aEnd = timeToMinutes(a.end);
            if (aEnd <= aStart) aEnd += 1440;
            // Check overlap
            if (sStart < aEnd && sEnd > aStart) return true;
            // Check insufficient rest gap
            const gapAfter = sStart - aEnd;
            const gapBefore = aStart - sEnd;
            const gap = Math.max(gapAfter, gapBefore);
            if (gap >= 0 && gap < restMinutes) return true;
            return false;
          });
          if (hasConflict) return false;

          // Rest compliance
          const h = history[name];
          if (h && h.lastEnd) {
            const restNeeded = schedulingParams.min_rest_hours * 60;
            const shiftStart = new Date(date + 'T' + shift.start_time + ':00');
            const diff = (shiftStart - h.lastEnd) / 60000;
            if (diff < restNeeded && diff >= 0) return false;
          }

          // Buddy must-not
          const buddyConflict = buddyRules.some(rule => {
            if (rule.type !== 'must_not') return false;
            const partner = rule.person1 === name ? rule.person2 : (rule.person2 === name ? rule.person1 : null);
            if (!partner) return false;
            const partnerRec = newAssignments[partner];
            const partnerAssigned = partnerRec ? partnerRec.all.some(a => a.shiftId === shift.id) : false;
            return partnerAssigned;
          });
          if (buddyConflict) return false;

          return true;
        });

        // Score candidates
        const candidateSet = new Set(candidates);
        const scored = candidates.map(name => {
          const h = history[name] || { totalHours: 0, missionCounts: {}, consecutiveDays: 0 };
          let score = 0;

          // Same-day assignment penalty: heavily penalize people who already
          // have shifts today so unassigned people are strongly preferred.
          const myRec = newAssignments[name];
          const dayCount = myRec ? (myRec.byDate.get(date) || []).length : 0;
          score -= dayCount * 50000;

          // Fairness: fewer hours â†’ higher score
          score += (1000 - h.totalHours) * 100;

          // Diversity: hasn't done this mission recently
          const mcount = h.missionCounts[shift.mission_type] || 0;
          score += (50 - mcount) * 60;

          // Consecutive days penalty (optional)
          if (schedulingParams.enforce_consecutive_limit) {
            score += (schedulingParams.max_consecutive_days - h.consecutiveDays) * 40;
          }

          // Buddy must-pair bonus
          const buddyBonus = buddyRules.some(rule => {
            if (rule.type !== 'must') return false;
            const partner = rule.person1 === name ? rule.person2 : (rule.person2 === name ? rule.person1 : null);
            if (!partner) return false;
            return candidateSet.has(partner);
          });
          if (buddyBonus) score += 30;

          return { name, score };
        });

        scored.sort((a, b) => b.score - a.score);

        // --- Role-aware picking: fill required role slots first, then remaining by score ---
        const assignedRoles = [];
        const pickedSet = new Set();

        // Manual roles preserved from DB
        manualAssigned.forEach(name => {
          const existing = (shift.assignments || []).find(a => a.name === name);
          assignedRoles.push({ name, role: existing ? existing.role : 'member', is_manual: true });
          pickedSet.add(name);
        });

        // Check which roles manual assignments already cover
        let needsOfficer = mt.requires_officer && !manualAssigned.some(n => (personnelTags[n] || []).includes('officer'));
        let needsCommander = mt.requires_commander && !manualAssigned.some(n => {
          const t = personnelTags[n] || [];
          return t.includes('officer') || t.includes('commander');
        });
        let needsDriver = mt.requires_driver && !manualAssigned.some(n => (personnelTags[n] || []).includes('driver'));

        let slotsLeft = needed;

        // 1) Reserve a slot for officer if required
        if (needsOfficer && slotsLeft > 0) {
          const pick = scored.find(s => !pickedSet.has(s.name) && (personnelTags[s.name] || []).includes('officer'));
          if (pick) {
            assignedRoles.push({ name: pick.name, role: 'commander', is_manual: false });
            pickedSet.add(pick.name);
            slotsLeft--;
            needsOfficer = false;
            needsCommander = false;
          }
        }

        // 2) Reserve a slot for commander if required (officer also satisfies this)
        if (needsCommander && slotsLeft > 0) {
          const pick = scored.find(s => !pickedSet.has(s.name) && ((personnelTags[s.name] || []).includes('officer') || (personnelTags[s.name] || []).includes('commander')));
          if (pick) {
            assignedRoles.push({ name: pick.name, role: 'commander', is_manual: false });
            pickedSet.add(pick.name);
            slotsLeft--;
            needsCommander = false;
            if ((personnelTags[pick.name] || []).includes('officer')) needsOfficer = false;
          }
        }

        // 3) Reserve a slot for driver if required
        if (needsDriver && slotsLeft > 0) {
          const pick = scored.find(s => !pickedSet.has(s.name) && (personnelTags[s.name] || []).includes('driver'));
          if (pick) {
            assignedRoles.push({ name: pick.name, role: 'driver', is_manual: false });
            pickedSet.add(pick.name);
            slotsLeft--;
            needsDriver = false;
          }
        }

        // 4) Fill remaining slots by fairness score
        if (slotsLeft > 0) {
          const rest = scored.filter(s => !pickedSet.has(s.name)).slice(0, slotsLeft);
          rest.forEach(s => {
            const tags = personnelTags[s.name] || [];
            let role = 'member';
            if (tags.includes('officer')) role = 'commander';
            assignedRoles.push({ name: s.name, role, is_manual: false });
            pickedSet.add(s.name);
          });
        }

        const picked = assignedRoles.filter(a => !a.is_manual).map(a => a.name);
        const allAssigned = [...manualAssigned, ...picked];

        // Track assignments â€” only emit auto-assigned to results (manual already in DB)
        assignedRoles.forEach(a => {
          if (!a.is_manual) {
            results.push({ shift_id: shift.id, name: a.name, role: a.role, is_manual: false });
          }
          const effR = getEffectiveShiftRange(shift);
          addNewAssignment(a.name, { date, start: effR.start, end: effR.end, shiftId: shift.id });

          // Update history
          if (history[a.name]) {
            const dur = getEffectiveDuration(shift);
            history[a.name].totalHours += dur;
      
            history[a.name].missionCounts[shift.mission_type] = (history[a.name].missionCounts[shift.mission_type] || 0) + 1;

            history[a.name].lastEnd = getEffectiveLastEnd(shift);

            // Track assigned date for consecutive days counting
            if (!assignedOnDate[a.name]) assignedOnDate[a.name] = new Set();
            if (!assignedOnDate[a.name].has(date)) {
              assignedOnDate[a.name].add(date);
              history[a.name].consecutiveDays++;
            }
          }
        });

        // Check warnings
        if (allAssigned.length < minTeam) {
          warnings.push(`${mt.name} ${shift.start_time}-${shift.end_time} (${date}): ×—×¡×¨×™× ${minTeam - allAssigned.length} ×× ×©×™×`);
        }
        if (needsOfficer) {
          warnings.push(`${mt.name} ${shift.start_time}-${shift.end_time} (${date}): ×—×¡×¨ ×§×¦×™×Ÿ`);
        }
        if (needsCommander) {
          warnings.push(`${mt.name} ${shift.start_time}-${shift.end_time} (${date}): ×—×¡×¨ ××¤×§×“`);
        }
        if (needsDriver) {
          warnings.push(`${mt.name} ${shift.start_time}-${shift.end_time} (${date}): ×—×¡×¨ × ×”×’`);
        }
      }
    }

    return { assignments: results, warnings };
  }

  async function runAutoSchedule() {
    if (isBusy) { showToast('×¤×¢×•×œ×” ×‘×ª×”×œ×™×š, × × ×œ×”××ª×™×Ÿ', 'info'); return; }
    if (!requireConfig()) return;
    if (!calendarData) {
      showToast('× ×ª×•× ×™ ×œ×•×— ×”×©× ×” ×˜×¨× × ×˜×¢× ×•', 'error');
      return;
    }

    let startDate, endDate;
    if (currentView === 'day') {
      startDate = endDate = formatDateStr(currentDate);
    } else {
      const weekDates = getWeekDates(currentDate);
      startDate = formatDateStr(weekDates[0]);
      endDate = formatDateStr(weekDates[6]);
    }

    showLoading();
    try {
      // Load all shifts and existing assignments for the range
      const loaded = await loadShifts(startDate, endDate);
      if (loaded.length === 0) {
        hideLoading();
        showToast('××™×Ÿ ××©××¨×•×ª ×œ×©×™×‘×•×¥. ×¦×•×¨ ××©××¨×•×ª ××ª×‘× ×™×ª ×ª×—×™×œ×”.', 'warning');
        return;
      }

      // Also load surrounding shifts for rest calculation
      const prevDate = new Date(parseDateStr(startDate));
      prevDate.setDate(prevDate.getDate() - 2);
      const allShifts = await loadShifts(formatDateStr(prevDate), endDate);
      shifts = allShifts;

      // Collect all existing assignments
      const existingAssignments = [];
      allShifts.forEach(s => {
        (s.assignments || []).forEach(a => existingAssignments.push(a));
      });

      // Filter target shifts (only the requested range)
      const targetShifts = loaded;

      // Count manual assignments to preserve
      const manualCount = targetShifts.reduce((sum, s) => {
        return sum + (s.assignments || []).filter(a => a.is_manual === 'TRUE').length;
      }, 0);

      // Snapshot existing auto-assignments for undo
      const autoSnapshot = targetShifts.flatMap(s =>
        (s.assignments || []).filter(a => a.is_manual !== 'TRUE')
      );

      // Clear non-manual assignments for target shifts
      const targetIds = targetShifts.map(s => s.id);
      await callAppsScript({ action: 'clearRosterAssignments', shiftIds: targetIds, clearManual: false });

      // Run solver
      const { assignments, warnings } = autoSchedule(targetShifts, existingAssignments);

      if (assignments.length === 0) {
        hideLoading();
        showToast('×œ× × ×™×ª×Ÿ ×œ×©×‘×¥ ×× ×©×™×. ×‘×“×•×§ ××ª ×”×’×“×¨×•×ª ×”×›×•×— ×”××“×.', 'warning');
        return;
      }

      // Save assignments
      await callAppsScript({ action: 'saveRosterAssignments', assignments });

      warnings.forEach(w => showToast(w, 'warning', 5000));
      if (manualCount > 0) {
        showToast(`×©×™×‘×•×¥ ××•×˜×•××˜×™: ×©×•××¨ ${manualCount} ×©×™×‘×•×¦×™× ×™×“× ×™×™× ×•××©×œ×™× ××ª ×”×©××¨`, 'info', 4000);
      }

      // Undo function
      const undoAutoSchedule = async () => {
        showLoading();
        try {
          await callAppsScript({ action: 'clearRosterAssignments', shiftIds: targetIds, clearManual: false });
          if (autoSnapshot.length > 0) {
            await callAppsScript({ action: 'saveRosterAssignments', assignments: autoSnapshot });
          }
          showToast('×”×©×™×‘×•×¥ ×”××•×˜×•××˜×™ ×‘×•×˜×œ', 'success');
          await refreshView();
        } catch (err) {
          // toast shown by callAppsScript
        } finally {
          hideLoading();
        }
      };

      showToast(`×©×•×‘×¦×• ${assignments.length} ×× ×©×™× ×‘×”×¦×œ×—×”`, 'success', 15000, '×‘×™×˜×•×œ', undoAutoSchedule);

      await refreshView();
    } catch (err) {
      // toast shown
    } finally {
      hideLoading();
    }
  }

  // ===================== ALERTS =====================

  function computeAlerts(dayShifts) {
    const alerts = [];

    dayShifts.forEach(shift => {
      const mt = getMissionType(shift.mission_type);
      if (!mt) return;

      const assigned = shift.assignments || [];
      const count = assigned.length;

      if (count < mt.min_team) {
        alerts.push({
          type: 'understaffed',
          icon: 'ğŸ”´',
          text: `${mt.name} ${shift.start_time}-${shift.end_time}: ×—×¡×¨×™× ${mt.min_team - count} ×× ×©×™× (${count}/${mt.min_team})`
        });
      }

      if (mt.requires_officer && !assigned.some(a => {
        const t = personnelTags[a.name] || [];
        return t.includes('officer');
      })) {
        alerts.push({
          type: 'missing_role',
          icon: 'ğŸ”´',
          text: `${mt.name} ${shift.start_time}-${shift.end_time}: ×—×¡×¨ ×§×¦×™×Ÿ`
        });
      }

      if (mt.requires_commander && !assigned.some(a => a.role === 'commander')) {
        alerts.push({
          type: 'missing_role',
          icon: 'ğŸŸ ',
          text: `${mt.name} ${shift.start_time}-${shift.end_time}: ×—×¡×¨ ××¤×§×“`
        });
      }

      if (mt.requires_driver && !assigned.some(a => a.role === 'driver')) {
        alerts.push({
          type: 'missing_role',
          icon: 'ğŸŸ ',
          text: `${mt.name} ${shift.start_time}-${shift.end_time}: ×—×¡×¨ × ×”×’`
        });
      }
    });

    // Detect duplicate assignments
    const nameOccurrences = {};
    dayShifts.forEach(shift => {
      const mt = getMissionType(shift.mission_type);
      const mtName = mt ? mt.name : shift.mission_type;
      const timeLabel = shift.start_time + '-' + shift.end_time;
      (shift.assignments || []).forEach(a => {
        if (!nameOccurrences[a.name]) nameOccurrences[a.name] = [];
        nameOccurrences[a.name].push(mtName + ' ' + timeLabel);
      });
    });
    Object.keys(nameOccurrences).forEach(name => {
      if (nameOccurrences[name].length > 1) {
        alerts.push({
          type: 'duplicate',
          icon: 'ğŸŸ¡',
          text: `${name} ××©×•×‘×¥/×ª ×‘-${nameOccurrences[name].length} ××©××¨×•×ª: ${nameOccurrences[name].join(', ')}`
        });
      }
    });

    return alerts;
  }

  function renderAlerts() {
    const panel = document.getElementById('alertsPanel');
    const badge = document.getElementById('alertBadge');

    if (alertsList.length === 0) {
      panel.style.display = 'none';
      badge.style.display = 'none';
      return;
    }

    badge.style.display = '';
    badge.textContent = alertsList.length;

    if (panel.style.display === 'none') return; // only render if visible

    const parts = [`<div class="alerts-panel">
      <div class="alerts-panel__header">
        <span>×”×ª×¨××•×ª (${alertsList.length})</span>
        <button class="btn btn--sm" onclick="document.getElementById('alertsPanel').style.display='none'">×¡×’×•×¨</button>
      </div>
      <div class="alerts-panel__list">`];

    alertsList.forEach(a => {
      parts.push(`<div class="alert-item">
        <span class="alert-item__icon">${a.icon}</span>
        <span class="alert-item__text">${escapeHtml(a.text)}</span>
      </div>`);
    });

    parts.push('</div></div>');
    panel.innerHTML = parts.join('');
  }

  // ===================== RENDERING â€” DAY VIEW =====================

  function renderDayView() {
    const container = document.getElementById('mainContent');
    const dateStr = formatDateStr(currentDate);
    const dayShifts = (shiftsByDateIndex.get(dateStr) || []).slice();

    // Sort by mission type, then start_time
    sortShiftsByTypeAndTime(dayShifts);

    // Compute alerts
    alertsList = computeAlerts(dayShifts);
    renderAlerts();

    const duplicateNames = getDuplicateNames(dateStr);

    const calendarBanner = calendarDataFailed ? '<div class="calendar-data-banner">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×œ×•×— ×©× ×” â€” ×™×™×ª×›×Ÿ ×©×”×–××™× ×•×ª ×œ× ××“×•×™×§×ª</div>' : '';

    if (dayShifts.length === 0) {
      container.innerHTML = calendarBanner + `
        <div class="empty-state">
          <div class="empty-state__icon">ğŸ“‹</div>
          <div class="empty-state__text">××™×Ÿ ××©××¨×•×ª ×œ×™×•× ×–×”</div>
          <button class="btn btn--primary" id="btnCreateShifts">×¦×•×¨ ××©××¨×•×ª ××ª×‘× ×™×ª</button>
        </div>`;
      // btnCreateShifts click handled by delegated listener in init()
      return;
    }

    const parts = [calendarBanner + '<div class="shifts-container">'];

    dayShifts.forEach((shift, idx) => {
      const mt = getMissionType(shift.mission_type);
      const name = mt ? mt.name : shift.mission_type;
      const color = mt ? mt.color : '#888';
      const minTeam = mt ? mt.min_team : 1;
      const assigned = shift.assignments || [];
      const count = assigned.length;
      const isFull = count >= minTeam;
      const badgeClass = count === 0 ? 'empty' : (isFull ? 'full' : 'partial');
      const timeLabel = `${shift.start_time}-${shift.end_time}`;

      parts.push(`<div class="shift-card" style="animation-delay:${idx * 0.05}s; border-right: 3px solid ${color};">
        <div class="shift-card__header">
          <div style="display:flex;align-items:center;gap:0.75rem;">
            <span class="shift-card__type">
              <span class="shift-card__type-dot" style="background:${color};"></span>
              ${escapeHtml(name)}
            </span>
            <span class="shift-card__time">${timeLabel}</span>
          </div>
          <div style="display:flex;align-items:center;gap:0.5rem;">
            <span class="shift-card__badge shift-card__badge--${badgeClass}">${count}/${minTeam} ${isFull ? 'âœ“' : ''}</span>
            <div class="shift-card__actions">
              <button class="shift-card__action-btn" title="×©×™×‘×•×¥ ×™×“× ×™" data-action="manual" data-shift-id="${shift.id}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
              </button>
              <button class="shift-card__action-btn" title="×”×¢×¨×”" data-action="note" data-shift-id="${shift.id}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
              </button>
              <button class="shift-card__action-btn" title="××—×§ ××©××¨×ª" data-action="delete" data-shift-id="${shift.id}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
              </button>
            </div>
          </div>
        </div>
        <div class="shift-card__body">`);

      if (assigned.length === 0) {
        parts.push('<div class="shift-card__empty">×œ× ×©×•×‘×¦×• ×× ×©×™×</div>');
      } else {
        assigned.forEach(a => {
          const roleLabel = ROLE_LABELS[a.role] || '';
          const manualClass = a.is_manual === 'TRUE' ? ' shift-card__person--manual' : '';
          const dupClass = duplicateNames.has(a.name) ? ' shift-card__person--duplicate' : '';
          parts.push(`<div class="shift-card__person${manualClass}${dupClass}">
            <span class="shift-card__person-name">${escapeHtml(a.name)}</span>
            ${a.role !== 'member' ? `<span class="shift-card__person-role">${roleLabel}</span>` : ''}
          </div>`);
        });
      }

      if (shift.note) {
        parts.push(`<div class="shift-card__note">${escapeHtml(shift.note)}</div>`);
      }

      parts.push('</div></div>');
    });

    // Pseudo-shift: unassigned available personnel
    const unassigned = getUnassignedPersonnel(dateStr);
    if (unassigned.length > 0) {
      parts.push(`<div class="shift-card shift-card--unassigned" style="animation-delay:${dayShifts.length * 0.05}s;">
        <div class="shift-card__header">
          <div style="display:flex;align-items:center;gap:0.75rem;">
            <span class="shift-card__type">
              <span class="shift-card__type-dot"></span>
              ×œ× ××©×•×‘×¦×™×
            </span>
            <span class="shift-card__time">×–××™× ×™× ×œ×œ× ×©×™×‘×•×¥</span>
          </div>
          <div style="display:flex;align-items:center;gap:0.5rem;">
            <span class="shift-card__badge shift-card__badge--partial">${unassigned.length}</span>
          </div>
        </div>
        <div class="shift-card__body">`);
      unassigned.forEach(name => {
        parts.push(`<div class="shift-card__person">
          <span class="shift-card__person-name">${escapeHtml(name)}</span>
        </div>`);
      });
      parts.push('</div></div>');
    }

    parts.push('</div>');
    container.innerHTML = parts.join('');

    // Action buttons and allday-select are handled by delegated listener in init()

    // Tooltip for person names (3-day history)
    container.querySelectorAll('.shift-card__person-name').forEach(nameEl => {
      nameEl.style.cursor = 'default';
      nameEl.addEventListener('mouseenter', function(e) {
        const personName = nameEl.textContent.trim();
        const history = getPersonRecentHistory(personName);

        const tooltip = document.createElement('div');
        tooltip.className = 'person-tooltip';

        let content = '<div class="person-tooltip__title">' + escapeHtml(personName) + ' â€” 3 ×™××™× ××—×¨×•× ×™×:</div>';
        content += '<hr class="person-tooltip__divider">';

        if (history.length === 0) {
          content += '<div class="person-tooltip__empty">×œ×œ× ××©××¨×•×ª ×‘-3 ×™××™× ××—×¨×•× ×™×</div>';
        } else {
          history.forEach(function(h) {
            content += '<div class="person-tooltip__row"><span>×™×•× ' + escapeHtml(h.dayName) + ' ' + escapeHtml(h.dateLabel) + ':</span> <span>' + escapeHtml(h.mtName) + ' ' + escapeHtml(h.timeLabel) + '</span></div>';
          });
        }

        tooltip.innerHTML = content;
        document.body.appendChild(tooltip);

        // Position tooltip below the name element
        const rect = nameEl.getBoundingClientRect();
        tooltip.style.top = (rect.bottom + 8) + 'px';
        tooltip.style.right = (window.innerWidth - rect.right) + 'px';

        // Ensure tooltip doesn't overflow viewport
        requestAnimationFrame(function() {
          const tRect = tooltip.getBoundingClientRect();
          if (tRect.bottom > window.innerHeight) {
            tooltip.style.top = (rect.top - tRect.height - 8) + 'px';
          }
          if (tRect.left < 0) {
            tooltip.style.right = 'auto';
            tooltip.style.left = '8px';
          }
          tooltip.classList.add('person-tooltip--visible');
        });

        nameEl._tooltip = tooltip;
      });

      nameEl.addEventListener('mouseleave', function() {
        if (nameEl._tooltip) {
          nameEl._tooltip.remove();
          nameEl._tooltip = null;
        }
      });
    });
  }

  // ===================== RENDERING â€” WEEK SUMMARY VIEW =====================

  function renderWeekView() {
    const container = document.getElementById('mainContent');
    const weekDates = getWeekDates(currentDate);
    const startStr = formatDateStr(weekDates[0]);
    const endStr = formatDateStr(weekDates[6]);
    const todayStr = formatDateStr(new Date());

    // Build weekShifts from index instead of filtering entire array
    const weekShifts = [];
    weekDates.forEach(date => {
      const dateStr = formatDateStr(date);
      const ds = shiftsByDateIndex.get(dateStr);
      if (ds) weekShifts.push(...ds);
    });

    // Compute alerts for entire week
    alertsList = computeAlerts(weekShifts);
    renderAlerts();

    const calendarBanner = calendarDataFailed ? '<div class="calendar-data-banner">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×œ×•×— ×©× ×” â€” ×™×™×ª×›×Ÿ ×©×”×–××™× ×•×ª ×œ× ××“×•×™×§×ª</div>' : '';

    if (weekShifts.length === 0) {
      container.innerHTML = calendarBanner + `
        <div class="empty-state">
          <div class="empty-state__icon">ğŸ“‹</div>
          <div class="empty-state__text">××™×Ÿ ××©××¨×•×ª ×œ×©×‘×•×¢ ×–×”</div>
          <button class="btn btn--primary" id="btnCreateShifts">×¦×•×¨ ××©××¨×•×ª ××ª×‘× ×™×ª</button>
        </div>`;
      // btnCreateShifts click handled by delegated listener in init()
      return;
    }

    // Determine which mission types are present this week
    const activeMtIds = [...new Set(weekShifts.map(s => s.mission_type))];
    const activeMts = activeMtIds.map(id => getMissionType(id)).filter(Boolean);

    // Build summary table
    const parts = [calendarBanner + '<div class="week-summary"><table class="week-summary__table"><thead><tr>'];
    parts.push('<th>×™×•×</th>');
    activeMts.forEach(mt => {
      parts.push(`<th><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${mt.color};margin-left:4px;vertical-align:middle;"></span> ${escapeHtml(mt.name)}</th>`);
    });
    parts.push('<th style="border-inline-start:2px solid var(--clr-border);">×¡×”×´×›</th>');
    parts.push('</tr></thead><tbody>');

    weekDates.forEach(date => {
      const dateStr = formatDateStr(date);
      const dayShifts = shiftsByDateIndex.get(dateStr) || [];
      const dayName = DAY_NAMES[date.getDay()];
      const dayNum = date.getDate();
      const isToday = dateStr === todayStr;

      parts.push(`<tr class="week-summary__day-row ${isToday ? 'week-summary__today' : ''}" data-date="${dateStr}">`);
      parts.push(`<td class="week-summary__day-label">${dayName} ${dayNum}</td>`);

      let dayTotalAssigned = 0;
      let dayTotalRequired = 0;

      activeMts.forEach(mt => {
        const mtShifts = dayShifts.filter(s => s.mission_type === mt.id);
        if (mtShifts.length === 0) {
          parts.push('<td class="week-summary__cell week-summary__cell--none">â€”</td>');
          return;
        }

        const totalAssigned = mtShifts.reduce((sum, s) => sum + (s.assignments || []).length, 0);
        const totalRequired = mtShifts.length * mt.min_team;

        dayTotalAssigned += totalAssigned;
        dayTotalRequired += totalRequired;

        let cellClass = 'week-summary__cell--empty';
        if (totalAssigned >= totalRequired) cellClass = 'week-summary__cell--full';
        else if (totalAssigned > 0) cellClass = 'week-summary__cell--partial';

        parts.push(`<td class="week-summary__cell ${cellClass}">${totalAssigned}/${totalRequired}</td>`);
      });

      // Day total column
      let totalClass = 'week-summary__cell--empty';
      if (dayTotalRequired === 0) totalClass = 'week-summary__cell--none';
      else if (dayTotalAssigned >= dayTotalRequired) totalClass = 'week-summary__cell--full';
      else if (dayTotalAssigned > 0) totalClass = 'week-summary__cell--partial';

      parts.push(`<td class="week-summary__cell ${totalClass}" style="border-inline-start:2px solid var(--clr-border);font-weight:700;">${dayTotalAssigned}/${dayTotalRequired}</td>`);

      parts.push('</tr>');
    });

    parts.push('</tbody></table></div>');
    container.innerHTML = parts.join('');

    // Week row click is handled by delegated listener in init()
  }

  // ===================== MODALS =====================

  function createModal(title, bodyHtml, footerHtml) {
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.innerHTML = `
      <div class="modal">
        <div class="modal__header">
          <span class="modal__title">${escapeHtml(title)}</span>
          <button class="modal__close">&times;</button>
        </div>
        <div class="modal__body">${bodyHtml}</div>
        ${footerHtml ? `<div class="modal__footer">${footerHtml}</div>` : ''}
      </div>`;

    document.body.appendChild(overlay);

    const handler = (e) => {
      if (e.key === 'Escape') closeModal();
    };
    const closeModal = () => {
      document.removeEventListener('keydown', handler);
      overlay.remove();
    };
    overlay.querySelector('.modal__close').addEventListener('click', closeModal);
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) closeModal();
    });
    document.addEventListener('keydown', handler);

    return { overlay, close: closeModal };
  }

  function confirmModal(title, message, confirmText, onConfirm) {
    const { overlay, close } = createModal(title,
      `<div class="confirm-modal__message">${escapeHtml(message)}</div>`,
      `<button class="btn btn--danger" id="modalConfirmYes">${escapeHtml(confirmText)}</button>
       <button class="btn" id="modalConfirmNo">×‘×™×˜×•×œ</button>`
    );
    overlay.querySelector('#modalConfirmYes').addEventListener('click', () => { close(); onConfirm(); });
    overlay.querySelector('#modalConfirmNo').addEventListener('click', close);
  }

  function promptShiftNote(shiftId) {
    const shift = shifts.find(s => s.id === shiftId);
    if (!shift) return;

    const { overlay, close } = createModal('×”×¢×¨×” ×œ××©××¨×ª', `
      <div class="form-group">
        <textarea class="form-textarea" id="modalNoteInput" rows="3" placeholder="×”×¢×¨×ª ××¡×™×¨×”...">${escapeHtml(shift.note || '')}</textarea>
      </div>
    `, `
      <button class="btn btn--filled" id="modalNoteSave">×©××•×¨</button>
      <button class="btn" id="modalNoteCancel">×‘×™×˜×•×œ</button>
    `);

    overlay.querySelector('#modalNoteSave').addEventListener('click', async () => {
      const note = overlay.querySelector('#modalNoteInput').value.trim();
      await saveShiftNote(shiftId, note);
      close();
      renderDayView();
    });
    overlay.querySelector('#modalNoteCancel').addEventListener('click', close);
    overlay.querySelector('#modalNoteInput').focus();
  }

  function promptManualAssign(shiftId) {
    if (isBusy) { showToast('×¤×¢×•×œ×” ×‘×ª×”×œ×™×š, × × ×œ×”××ª×™×Ÿ', 'info'); return; }
    if (!requireConfig()) return;
    const shift = shifts.find(s => s.id === shiftId);
    if (!shift) return;

    const mt = getMissionType(shift.mission_type);
    const mtName = mt ? mt.name : shift.mission_type;
    const timeLabel = shift.start_time === shift.end_time ? '×™×•× ×©×œ×' : `${shift.start_time}-${shift.end_time}`;

    // Get available personnel for this date
    const available = getAvailablePersonnel(shift.date);
    const allNames = calendarData ? calendarData.names : [];
    const currentManual = (shift.assignments || []).filter(a => a.is_manual === 'TRUE');
    const currentManualNames = new Set(currentManual.map(a => a.name));

    // Build conflict map: name -> list of overlapping shifts (excluding current shift)
    const dayShifts = (shiftsByDateIndex.get(shift.date) || []).filter(s => s.id !== shiftId);
    const conflictMap = {};
    allNames.forEach(name => {
      const conflicts = [];
      dayShifts.forEach(other => {
        if (!shiftsOverlap(shift, other)) return;
        if ((other.assignments || []).some(a => a.name === name)) {
          const otherMt = getMissionType(other.mission_type);
          const otherName = otherMt ? otherMt.name : other.mission_type;
          const otherTime = other.start_time === other.end_time ? '×™×•× ×©×œ×' : `${other.start_time}-${other.end_time}`;
          conflicts.push(`${otherName} ${otherTime}`);
        }
      });
      if (conflicts.length) conflictMap[name] = conflicts;
    });

    // Build person list â€” available people first, then rest (greyed out)
    let checkboxHtml = '<div style="margin-bottom:0.75rem;font-size:0.8rem;color:var(--clr-text-tertiary);">×¡××Ÿ ××ª ×”×× ×©×™× ×©×™×©×•×‘×¦×• ×™×“× ×™×ª. ×©×™×‘×•×¥ ×™×“× ×™ × ×¢×•×œ â€” ×”×©×™×‘×•×¥ ×”××•×˜×•××˜×™ ×œ× ×™×’×¢ ×‘×”× ×•×œ× ×™×©×‘×¥ ××•×ª× ×œ××©××¨×•×ª ××—×¨×•×ª.</div>';
    checkboxHtml += '<div class="checkbox-grid" style="grid-template-columns:repeat(auto-fill, minmax(160px, 1fr));">';

    // Role selector per person
    const roleOptions = `
      <select class="form-select manual-role-select" style="font-size:0.75rem;padding:0.15rem 0.3rem;min-width:auto;width:70px;border-radius:4px;" data-name="__NAME__">
        <option value="member">×—×™×™×œ</option>
        <option value="commander">××¤×§×“</option>
        <option value="officer">×§×¦×™×Ÿ</option>
        <option value="driver">× ×”×’</option>
      </select>`;

    allNames.forEach(name => {
      const isOnBase = available.includes(name);
      const isChecked = currentManualNames.has(name);
      const existingRole = isChecked ? (currentManual.find(a => a.name === name)?.role || 'member') : 'member';
      const opacity = isOnBase ? '1' : '0.45';
      const hint = isOnBase ? '' : ' (×œ× ×‘××•×¦×‘)';
      const conflictBadge = conflictMap[name]
        ? `<span class="conflict-badge" title="×—×¤×™×¤×” ×¢× ${escapeHtml(conflictMap[name].join(', '))}">&#9888;&#65039;</span>`
        : '';

      checkboxHtml += `<label style="opacity:${opacity};flex-direction:column;align-items:flex-start;gap:0.15rem;">
        <div style="display:flex;align-items:center;gap:0.4rem;">
          <input type="checkbox" class="manual-cb" data-name="${escapeHtml(name)}" ${isChecked ? 'checked' : ''}>
          <span>${escapeHtml(name)}${hint}${conflictBadge}</span>
        </div>
        <div style="padding-right:1.2rem;">
          ${roleOptions.replace('__NAME__', escapeHtml(name)).replace(`value="${existingRole}"`, `value="${existingRole}" selected`)}
        </div>
      </label>`;
    });
    checkboxHtml += '</div>';

    const { overlay, close } = createModal(`×©×™×‘×•×¥ ×™×“× ×™ â€” ${mtName} ${timeLabel}`, checkboxHtml, `
      <button class="btn btn--filled" id="modalManualSave">×©××•×¨ ×©×™×‘×•×¥ ×™×“× ×™</button>
      <button class="btn" id="modalManualCancel">×‘×™×˜×•×œ</button>
    `);

    overlay.querySelector('#modalManualSave').addEventListener('click', async () => {
      const checkboxes = overlay.querySelectorAll('.manual-cb');
      const newAssignments = [];

      checkboxes.forEach(cb => {
        if (!cb.checked) return;
        const name = cb.dataset.name;
        const roleSelect = overlay.querySelector(`.manual-role-select[data-name="${CSS.escape(name)}"]`);
        const role = roleSelect ? roleSelect.value : 'member';
        newAssignments.push({
          shift_id: shiftId,
          name,
          role,
          is_manual: 'TRUE',
          assigned_at: new Date().toISOString()
        });
      });

      const originalAssignments = [...(shift.assignments || [])];
      showLoading();
      try {
        // Clear ALL existing assignments for this shift (both manual and auto)
        await callAppsScript({ action: 'clearRosterAssignments', shiftIds: [shiftId], clearManual: true });

        // Save the new manual assignments
        try {
          if (newAssignments.length > 0) {
            await callAppsScript({ action: 'saveRosterAssignments', assignments: newAssignments });
          }
        } catch (saveErr) {
          // Save failed after clear â€” attempt to restore original assignments
          showToast('×©×’×™××” ×‘×©××™×¨×ª ×©×™×‘×•×¦×™× ×—×“×©×™× â€” ×× ×¡×” ×œ×©×—×–×¨ ××ª ×”×§×•×“××™×', 'error', 5000);
          if (originalAssignments.length > 0) {
            try {
              await callAppsScript({ action: 'saveRosterAssignments', assignments: originalAssignments });
              showToast('×”×©×™×‘×•×¦×™× ×”×§×•×“××™× ×©×•×—×–×¨×•', 'info');
            } catch (restoreErr) {
              showToast('×©×’×™××” ×‘×©×—×–×•×¨ â€” ×™×© ×œ×¨×¢× ×Ÿ ×•×œ×‘×“×•×§ ××ª ×”× ×ª×•× ×™×', 'error', 6000);
            }
          }
          await refreshView();
          return;
        }

        showToast(`×©×•×‘×¦×• ${newAssignments.length} ×× ×©×™× ×™×“× ×™×ª`, 'success');
        close();
        await refreshView();
      } catch (err) {
        // toast shown by callAppsScript
      } finally {
        hideLoading();
      }
    });

    overlay.querySelector('#modalManualCancel').addEventListener('click', close);
  }

  function promptCreateShifts() {
    if (isBusy) { showToast('×¤×¢×•×œ×” ×‘×ª×”×œ×™×š, × × ×œ×”××ª×™×Ÿ', 'info'); return; }
    if (!requireConfig()) return;
    const today = formatDateStr(currentDate);
    const { overlay, close } = createModal('×™×¦×™×¨×ª ××©××¨×•×ª ××ª×‘× ×™×ª', `
      <div class="form-group">
        <label class="form-label">×ª××¨×™×š ×”×ª×—×œ×”</label>
        <input type="date" class="form-input" id="modalStartDate" value="${today}">
      </div>
      <div class="form-group">
        <label class="form-label">×ª××¨×™×š ×¡×™×•×</label>
        <input type="date" class="form-input" id="modalEndDate" value="${today}">
      </div>
      <div class="form-hint">×™×™×•×•×¦×¨×• ××©××¨×•×ª ×œ×¤×™ ×”×ª×‘× ×™×ª ×”××•×’×“×¨×ª ×‘×”×’×“×¨×•×ª (${shiftTemplates.length} ××©××¨×•×ª ×œ×™×•×)</div>
    `, `
      <button class="btn btn--filled" id="modalCreateBtn">×¦×•×¨ ××©××¨×•×ª</button>
      <button class="btn" id="modalCancelBtn">×‘×™×˜×•×œ</button>
    `);

    overlay.querySelector('#modalCreateBtn').addEventListener('click', async () => {
      const start = overlay.querySelector('#modalStartDate').value;
      const end = overlay.querySelector('#modalEndDate').value;
      if (!start || !end) { showToast('×™×© ×œ×‘×—×•×¨ ×ª××¨×™×›×™×', 'error'); return; }
      if (start > end) { showToast('×ª××¨×™×š ×”×ª×—×œ×” ×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤× ×™ ×ª××¨×™×š ×¡×™×•×', 'error'); return; }
      close();
      await createShiftsFromTemplate(start, end);
    });
    overlay.querySelector('#modalCancelBtn').addEventListener('click', close);
  }

  // ===================== CONFIG MODAL =====================

  function openConfigModal() {
    let activeTab = 'missions';

    function renderConfigBody() {
      return `
        <div class="tabs" id="configTabs">
          <button class="tabs__tab ${activeTab === 'missions' ? 'tabs__tab--active' : ''}" data-tab="missions">×¡×•×’×™ ××©×™××•×ª</button>
          <button class="tabs__tab ${activeTab === 'tags' ? 'tabs__tab--active' : ''}" data-tab="tags">×ª×’×™×•×ª ×›×•×— ××“×</button>
          <button class="tabs__tab ${activeTab === 'exclusions' ? 'tabs__tab--active' : ''}" data-tab="exclusions">×¤×˜×•×¨×™×</button>
          <button class="tabs__tab ${activeTab === 'buddies' ? 'tabs__tab--active' : ''}" data-tab="buddies">×›×œ×œ×™ ×–×•×’×•×ª</button>
          <button class="tabs__tab ${activeTab === 'params' ? 'tabs__tab--active' : ''}" data-tab="params">×¤×¨××˜×¨×™×</button>
          <button class="tabs__tab ${activeTab === 'templates' ? 'tabs__tab--active' : ''}" data-tab="templates">×ª×‘× ×™×ª ××©××¨×•×ª</button>
        </div>

        <div class="tab-panel ${activeTab === 'missions' ? 'tab-panel--active' : ''}" id="panelMissions">
          ${renderMissionTypesPanel()}
        </div>
        <div class="tab-panel ${activeTab === 'tags' ? 'tab-panel--active' : ''}" id="panelTags">
          ${renderPersonnelTagsPanel()}
        </div>
        <div class="tab-panel ${activeTab === 'exclusions' ? 'tab-panel--active' : ''}" id="panelExclusions">
          ${renderExclusionsPanel()}
        </div>
        <div class="tab-panel ${activeTab === 'buddies' ? 'tab-panel--active' : ''}" id="panelBuddies">
          ${renderBuddyRulesPanel()}
        </div>
        <div class="tab-panel ${activeTab === 'params' ? 'tab-panel--active' : ''}" id="panelParams">
          ${renderSchedulingParamsPanel()}
        </div>
        <div class="tab-panel ${activeTab === 'templates' ? 'tab-panel--active' : ''}" id="panelTemplates">
          ${renderShiftTemplatesPanel()}
        </div>
      `;
    }

    const { overlay, close } = createModal('×”×’×“×¨×•×ª ×©×‘×¦×´×§', renderConfigBody(), `
      <button class="btn btn--filled" id="configSave">×©××•×¨ ×”×’×“×¨×•×ª</button>
      <button class="btn" id="configClose">×¡×’×•×¨</button>
    `);

    function rebindTabs() {
      overlay.querySelectorAll('.tabs__tab').forEach(tab => {
        tab.addEventListener('click', () => {
          activeTab = tab.dataset.tab;
          overlay.querySelector('.modal__body').innerHTML = renderConfigBody();
          rebindTabs();
          rebindPanels();
        });
      });
    }

    function rebindPanels() {
      // Mission type add button
      const addMtBtn = overlay.querySelector('#addMissionType');
      if (addMtBtn) {
        addMtBtn.addEventListener('click', () => {
          const name = overlay.querySelector('#newMtName').value.trim();
          const dur = parseInt(overlay.querySelector('#newMtDuration').value) || 8;
          const team = parseInt(overlay.querySelector('#newMtTeam').value) || 1;
          const color = overlay.querySelector('#newMtColor').value;
          if (!name) { showToast('×™×© ×œ×”×–×™×Ÿ ×©× ××©×™××”', 'error'); return; }
          const id = name.replace(/\s+/g, '_').toLowerCase() + '_' + Date.now();
          missionTypes.push({ id, name, duration_hours: dur, min_team: team, requires_commander: false, requires_driver: false, requires_officer: false, color, fixed_people: [] });
          buildMissionTypeMap();
          overlay.querySelector('.modal__body').innerHTML = renderConfigBody();
          rebindTabs();
          rebindPanels();
        });
      }

      // Delete mission type buttons
      overlay.querySelectorAll('.delete-mt').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          missionTypes = missionTypes.filter(m => m.id !== id);
          buildMissionTypeMap();
          overlay.querySelector('.modal__body').innerHTML = renderConfigBody();
          rebindTabs();
          rebindPanels();
        });
      });

      // Toggle checkboxes for commander/driver
      overlay.querySelectorAll('.mt-toggle').forEach(cb => {
        cb.addEventListener('change', () => {
          const id = cb.dataset.id;
          const field = cb.dataset.field;
          const mt = missionTypes.find(m => m.id === id);
          if (mt) mt[field] = cb.checked;
        });
      });

      // Editable duration_hours / min_team inputs
      overlay.querySelectorAll('.mt-edit').forEach(inp => {
        inp.addEventListener('change', () => {
          const mt = missionTypes.find(m => m.id === inp.dataset.id);
          if (mt) mt[inp.dataset.field] = parseInt(inp.value) || 1;
        });
      });

      // Fixed people buttons
      overlay.querySelectorAll('.fixed-people-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const mtId = btn.dataset.id;
          const mt = missionTypes.find(m => m.id === mtId);
          if (!mt) return;
          promptFixedPeople(mt);
        });
      });

      // Personnel tag checkboxes
      overlay.querySelectorAll('.tag-cb').forEach(cb => {
        cb.addEventListener('change', () => {
          const name = cb.dataset.name;
          const tag = cb.dataset.tag;
          if (!personnelTags[name]) personnelTags[name] = [];
          if (cb.checked) {
            if (!personnelTags[name].includes(tag)) personnelTags[name].push(tag);
          } else {
            personnelTags[name] = personnelTags[name].filter(t => t !== tag);
          }
        });
      });

      // Exclusion checkboxes
      overlay.querySelectorAll('.excl-cb').forEach(cb => {
        cb.addEventListener('change', () => {
          const name = cb.dataset.name;
          const mt = cb.dataset.mt;
          if (!exclusions[name]) exclusions[name] = [];
          if (cb.checked) {
            if (!exclusions[name].includes(mt)) exclusions[name].push(mt);
          } else {
            exclusions[name] = exclusions[name].filter(m => m !== mt);
          }
        });
      });

      // Buddy rule add
      const addBuddyBtn = overlay.querySelector('#addBuddyRule');
      if (addBuddyBtn) {
        addBuddyBtn.addEventListener('click', () => {
          const type = overlay.querySelector('#buddyType').value;
          const p1 = overlay.querySelector('#buddyPerson1').value;
          const p2 = overlay.querySelector('#buddyPerson2').value;
          if (!p1 || !p2 || p1 === p2) { showToast('×™×© ×œ×‘×—×•×¨ ×©× ×™ ×× ×©×™× ×©×•× ×™×', 'error'); return; }
          buddyRules.push({ type, person1: p1, person2: p2 });
          overlay.querySelector('.modal__body').innerHTML = renderConfigBody();
          rebindTabs();
          rebindPanels();
        });
      }

      // Delete buddy rule
      overlay.querySelectorAll('.delete-buddy').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.idx);
          buddyRules.splice(idx, 1);
          overlay.querySelector('.modal__body').innerHTML = renderConfigBody();
          rebindTabs();
          rebindPanels();
        });
      });

      // Scheduling params inputs
      overlay.querySelectorAll('.param-input').forEach(input => {
        input.addEventListener('change', () => {
          const key = input.dataset.key;
          schedulingParams[key] = isNaN(input.value) ? input.value : Number(input.value);
        });
      });

      // Scheduling params toggle (consecutive limit)
      overlay.querySelectorAll('.param-toggle').forEach(cb => {
        cb.addEventListener('change', () => {
          const key = cb.dataset.key;
          schedulingParams[key] = cb.checked;
          // Enable/disable the related number input
          const numInput = overlay.querySelector('.param-input[data-key="max_consecutive_days"]');
          if (numInput) numInput.disabled = !cb.checked;
        });
      });

      // All-day toggle for template
      const tplAllDay = overlay.querySelector('#tplAllDay');
      if (tplAllDay) {
        tplAllDay.addEventListener('change', () => {
          const startInput = overlay.querySelector('#tplStart');
          const endInput = overlay.querySelector('#tplEnd');
          const restRow = overlay.querySelector('#tplRestRow');
          if (!startInput || !endInput) return;
          if (tplAllDay.checked) {
            startInput.value = '00:00';
            endInput.value = '00:00';
            startInput.disabled = true;
            endInput.disabled = true;
            if (restRow) restRow.style.display = '';
          } else {
            startInput.disabled = false;
            endInput.disabled = false;
            startInput.value = '08:00';
            endInput.value = '16:00';
            if (restRow) restRow.style.display = 'none';
          }
        });
      }

      // Rest select for existing all-day templates
      overlay.querySelectorAll('.tpl-rest-select').forEach(sel => {
        sel.addEventListener('change', () => {
          const idx = parseInt(sel.dataset.idx);
          if (shiftTemplates[idx]) {
            shiftTemplates[idx].rest_end_time = sel.value || '';
          }
        });
      });

      // Template add
      const addTplBtn = overlay.querySelector('#addTemplate');
      if (addTplBtn) {
        addTplBtn.addEventListener('click', () => {
          const mt = overlay.querySelector('#tplMissionType').value;
          const start = overlay.querySelector('#tplStart').value || '08:00';
          const end = overlay.querySelector('#tplEnd').value || '16:00';
          const isAllDay = start === end;
          const restEndSel = overlay.querySelector('#tplRestEndTime');
          const restEnd = isAllDay && restEndSel ? restEndSel.value : '';
          const tpl = { mission_type: mt, start_time: start, end_time: end };
          if (restEnd) tpl.rest_end_time = restEnd;
          shiftTemplates.push(tpl);
          overlay.querySelector('.modal__body').innerHTML = renderConfigBody();
          rebindTabs();
          rebindPanels();
        });
      }

      // Delete template
      overlay.querySelectorAll('.delete-tpl').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.idx);
          shiftTemplates.splice(idx, 1);
          overlay.querySelector('.modal__body').innerHTML = renderConfigBody();
          rebindTabs();
          rebindPanels();
        });
      });
    }

    function promptFixedPeople(mt) {
      const names = calendarData ? calendarData.names : [];
      if (names.length === 0) { showToast('×˜×¢×Ÿ × ×ª×•× ×™ ×œ×•×— ×©× ×” ×ª×—×™×œ×”', 'error'); return; }

      const currentFixed = new Set(mt.fixed_people || []);
      let checkboxHtml = `<div style="margin-bottom:0.75rem;font-size:0.85rem;color:var(--clr-text-secondary);">×¡××Ÿ ×× ×©×™× ×©×™×©×•×‘×¦×• ××•×˜×•××˜×™×ª ×‘×›×œ ××©××¨×ª ××¡×•×’ <strong>${escapeHtml(mt.name)}</strong>:</div>`;
      checkboxHtml += '<div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(140px, 1fr));gap:0.5rem;">';
      names.forEach(name => {
        const checked = currentFixed.has(name) ? 'checked' : '';
        checkboxHtml += `<label style="display:flex;align-items:center;gap:0.3rem;font-size:0.85rem;cursor:pointer;">
          <input type="checkbox" class="fixed-person-cb" data-name="${escapeHtml(name)}" ${checked}>
          ${escapeHtml(name)}
        </label>`;
      });
      checkboxHtml += '</div>';

      const sub = createModal(
        '×× ×©×™× ×§×‘×•×¢×™× â€” ' + mt.name,
        checkboxHtml,
        '<button class="btn btn--filled" id="fixedPeopleSave">×©××•×¨</button> <button class="btn" id="fixedPeopleCancel">×‘×™×˜×•×œ</button>'
      );

      sub.overlay.querySelector('#fixedPeopleSave').addEventListener('click', () => {
        const selected = [];
        sub.overlay.querySelectorAll('.fixed-person-cb:checked').forEach(cb => {
          selected.push(cb.dataset.name);
        });
        mt.fixed_people = selected;
        sub.close();
        overlay.querySelector('.modal__body').innerHTML = renderConfigBody();
        rebindTabs();
        rebindPanels();
      });
      sub.overlay.querySelector('#fixedPeopleCancel').addEventListener('click', sub.close);
    }

    rebindTabs();
    rebindPanels();

    overlay.querySelector('#configSave').addEventListener('click', async () => {
      showLoading();
      try {
        await saveConfigKey('mission_types', missionTypes);
        await saveConfigKey('personnel_tags', personnelTags);
        await saveConfigKey('exclusions', exclusions);
        await saveConfigKey('buddy_rules', buddyRules);
        await saveConfigKey('scheduling_params', schedulingParams);
        await saveConfigKey('shift_templates', shiftTemplates);
        showToast('×”×”×’×“×¨×•×ª × ×©××¨×• ×‘×”×¦×œ×—×”', 'success');
        close();
      } catch (err) {} finally { hideLoading(); }
    });
    overlay.querySelector('#configClose').addEventListener('click', close);
  }

  function renderMissionTypesPanel() {
    let html = '<div class="item-list">';
    missionTypes.forEach(mt => {
      html += `<div class="item-row">
        <span class="item-row__dot" style="background:${mt.color}"></span>
        <span class="item-row__name">${escapeHtml(mt.name)}</span>
        <span class="item-row__detail"><input type="number" class="mt-edit" data-id="${mt.id}" data-field="duration_hours" value="${mt.duration_hours}" min="1" max="24" style="width:3rem;text-align:center;border:1px solid #ccc;border-radius:4px;padding:0.1rem 0.2rem;font-size:0.8rem;">×© | <input type="number" class="mt-edit" data-id="${mt.id}" data-field="min_team" value="${mt.min_team}" min="1" max="20" style="width:3rem;text-align:center;border:1px solid #ccc;border-radius:4px;padding:0.1rem 0.2rem;font-size:0.8rem;"> ×× ×©×™×</span>
        <label style="font-size:0.75rem;display:flex;align-items:center;gap:0.2rem;"><input type="checkbox" class="mt-toggle" data-id="${mt.id}" data-field="requires_officer" ${mt.requires_officer ? 'checked' : ''}> ×§×¦×™×Ÿ ×—×•×‘×”</label>
        <label style="font-size:0.75rem;display:flex;align-items:center;gap:0.2rem;"><input type="checkbox" class="mt-toggle" data-id="${mt.id}" data-field="requires_commander" ${mt.requires_commander ? 'checked' : ''}> ××¤×§×“</label>
        <label style="font-size:0.75rem;display:flex;align-items:center;gap:0.2rem;"><input type="checkbox" class="mt-toggle" data-id="${mt.id}" data-field="requires_driver" ${mt.requires_driver ? 'checked' : ''}> × ×”×’</label>
        <button class="btn btn--sm fixed-people-btn" data-id="${mt.id}" style="font-size:0.72rem;padding:0.15rem 0.5rem;">×× ×©×™× ×§×‘×•×¢×™× (${(mt.fixed_people || []).length})</button>
        <div class="item-row__actions">
          <button class="item-row__btn delete-mt" data-id="${mt.id}" title="××—×§">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
          </button>
        </div>
      </div>`;
    });
    html += '</div>';

    html += `<div style="margin-top:1rem;padding:0.75rem;background:rgba(0,0,0,0.02);border-radius:8px;">
      <div style="font-weight:600;font-size:0.85rem;margin-bottom:0.5rem;">×”×•×¡×£ ×¡×•×’ ××©×™××”</div>
      <div class="form-row">
        <div class="form-group"><input class="form-input" id="newMtName" placeholder="×©× (×œ××©×œ: ×¡×™×•×¨)"></div>
        <div class="form-group"><input class="form-input" id="newMtDuration" type="number" value="8" placeholder="×©×¢×•×ª"></div>
        <div class="form-group"><input class="form-input" id="newMtTeam" type="number" value="1" placeholder="××™× ×³ ×× ×©×™×"></div>
        <div class="form-group"><input class="form-input" id="newMtColor" type="color" value="#2563eb"></div>
      </div>
      <button class="btn btn--sm btn--primary" id="addMissionType">×”×•×¡×£</button>
    </div>`;

    return html;
  }

  function renderPersonnelTagsPanel() {
    const names = calendarData ? calendarData.names : [];
    if (names.length === 0) return '<div class="form-hint">×˜×¢×Ÿ × ×ª×•× ×™ ×œ×•×— ×©× ×” ×ª×—×™×œ×”</div>';

    const tags = ['officer', 'commander', 'driver'];
    const tagLabels = { officer: '×§×¦×™×Ÿ (×ª××™×“ ××¤×§×“)', commander: '××¤×§×“', driver: '× ×”×’' };

    let html = '<table class="fairness-table"><thead><tr><th>×©×</th>';
    tags.forEach(t => { html += `<th style="text-align:center;">${tagLabels[t]}</th>`; });
    html += '</tr></thead><tbody>';

    names.forEach(name => {
      const pTags = personnelTags[name] || [];
      html += `<tr><td style="font-weight:500;">${escapeHtml(name)}</td>`;
      tags.forEach(t => {
        const checked = pTags.includes(t) ? 'checked' : '';
        html += `<td style="text-align:center;"><input type="checkbox" class="tag-cb" data-name="${escapeHtml(name)}" data-tag="${t}" ${checked}></td>`;
      });
      html += '</tr>';
    });

    html += '</tbody></table>';
    return html;
  }

  function renderExclusionsPanel() {
    const names = calendarData ? calendarData.names : [];
    if (names.length === 0) return '<div class="form-hint">×˜×¢×Ÿ × ×ª×•× ×™ ×œ×•×— ×©× ×” ×ª×—×™×œ×”</div>';

    let html = '<table class="fairness-table"><thead><tr><th>×©×</th>';
    missionTypes.forEach(mt => { html += `<th style="text-align:center;">${escapeHtml(mt.name)}</th>`; });
    html += '</tr></thead><tbody>';

    names.forEach(name => {
      const excl = exclusions[name] || [];
      html += `<tr><td style="font-weight:500;">${escapeHtml(name)}</td>`;
      missionTypes.forEach(mt => {
        const checked = excl.includes(mt.id) ? 'checked' : '';
        html += `<td style="text-align:center;"><input type="checkbox" class="excl-cb" data-name="${escapeHtml(name)}" data-mt="${mt.id}" ${checked}></td>`;
      });
      html += '</tr>';
    });

    html += '</tbody></table>';
    return html;
  }

  function renderBuddyRulesPanel() {
    const names = calendarData ? calendarData.names : [];

    let html = '<div class="item-list">';
    buddyRules.forEach((rule, idx) => {
      const typeLabel = rule.type === 'must' ? '×—×™×™×‘ ×™×—×“' : '××¡×•×¨ ×™×—×“';
      const color = rule.type === 'must' ? 'var(--clr-activity)' : 'var(--clr-danger)';
      html += `<div class="item-row">
        <span style="font-size:0.78rem;font-weight:600;color:${color};">${typeLabel}</span>
        <span class="item-row__name">${escapeHtml(rule.person1)} â†” ${escapeHtml(rule.person2)}</span>
        <button class="item-row__btn delete-buddy" data-idx="${idx}" title="××—×§">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        </button>
      </div>`;
    });
    html += '</div>';

    if (names.length > 0) {
      const nameOptions = names.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('');
      html += `<div style="margin-top:1rem;padding:0.75rem;background:rgba(0,0,0,0.02);border-radius:8px;">
        <div style="font-weight:600;font-size:0.85rem;margin-bottom:0.5rem;">×”×•×¡×£ ×›×œ×œ</div>
        <div class="form-row">
          <div class="form-group">
            <select class="form-select" id="buddyType">
              <option value="must">×—×™×™×‘ ×™×—×“</option>
              <option value="must_not">××¡×•×¨ ×™×—×“</option>
            </select>
          </div>
          <div class="form-group"><select class="form-select" id="buddyPerson1"><option value="">×‘×—×¨ ××“×</option>${nameOptions}</select></div>
          <div class="form-group"><select class="form-select" id="buddyPerson2"><option value="">×‘×—×¨ ××“×</option>${nameOptions}</select></div>
        </div>
        <button class="btn btn--sm btn--primary" id="addBuddyRule">×”×•×¡×£</button>
      </div>`;
    }

    return html;
  }

  function renderSchedulingParamsPanel() {
    const checked = schedulingParams.enforce_consecutive_limit ? 'checked' : '';
    return `
      <div class="form-group">
        <label class="form-label">×©×¢×•×ª ×× ×•×—×” ××™× ×™××œ×™×•×ª ×‘×™×Ÿ ××©××¨×•×ª</label>
        <input class="form-input param-input" data-key="min_rest_hours" type="number" value="${schedulingParams.min_rest_hours}" style="max-width:200px;">
        <div class="form-hint">××¡×¤×¨ ×©×¢×•×ª ×× ×•×—×” ××™× ×™××œ×™ ×‘×™×Ÿ ×¡×™×•× ××©××¨×ª ×œ×ª×—×™×œ×ª ×”×‘××”</div>
      </div>
      <div style="margin-top:1rem;padding:0.75rem;background:rgba(0,0,0,0.02);border-radius:8px;">
        <label style="display:flex;align-items:center;gap:0.5rem;font-size:0.88rem;font-weight:500;cursor:pointer;">
          <input type="checkbox" class="param-toggle" data-key="enforce_consecutive_limit" ${checked}>
          ×”×’×‘×œ×ª ×™××™× ×¨×¦×•×¤×™×
        </label>
        <div class="form-hint" style="margin-top:0.25rem;">×›×©××•×¤×¢×œ, ×”×©×™×‘×•×¥ ××¢×“×™×£ ×œ×ª×ª ×”×¤×¡×§×” ×œ×× ×©×™× ×©×¢×‘×“×• ×™××™× ×¨×‘×™× ×‘×¨×¦×£. ××ª××¤×¡ ×›×©××“× ×™×•×¦× ×”×‘×™×ª×”.</div>
        <div style="margin-top:0.5rem;">
          <label class="form-label">××§×¡×™××•× ×™××™× ×¨×¦×•×¤×™×</label>
          <input class="form-input param-input" data-key="max_consecutive_days" type="number" value="${schedulingParams.max_consecutive_days}" style="max-width:200px;" ${checked ? '' : 'disabled'}>
        </div>
      </div>
    `;
  }

  function renderShiftTemplatesPanel() {
    let html = '<div class="item-list">';
    shiftTemplates.forEach((tpl, idx) => {
      const mt = getMissionType(tpl.mission_type);
      const mtName = mt ? mt.name : tpl.mission_type;
      const color = mt ? mt.color : '#888';
      const isAllDay = tpl.start_time === tpl.end_time;
      const timeLabel = isAllDay ? '×™×•× ×©×œ×' : `${tpl.start_time}-${tpl.end_time}`;
      const restHtml = isAllDay ? `<select class="form-select tpl-rest-select" data-idx="${idx}" style="font-size:0.78rem;padding:0.15rem 0.3rem;max-width:160px;">
        <option value=""${!tpl.rest_end_time ? ' selected' : ''}>×œ×œ× ×× ×•×—×”</option>
        <option value="14:00"${tpl.rest_end_time === '14:00' ? ' selected' : ''}>×× ×•×—×” (06:00-14:00)</option>
      </select>` : '';
      html += `<div class="item-row">
        <span class="item-row__dot" style="background:${color}"></span>
        <span class="item-row__name">${escapeHtml(mtName)}</span>
        <span class="item-row__detail">${timeLabel}</span>
        ${restHtml}
        <button class="item-row__btn delete-tpl" data-idx="${idx}" title="××—×§">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        </button>
      </div>`;
    });
    html += '</div>';

    const mtOptions = missionTypes.map(mt => `<option value="${mt.id}">${escapeHtml(mt.name)}</option>`).join('');
    html += `<div style="margin-top:1rem;padding:0.75rem;background:rgba(0,0,0,0.02);border-radius:8px;">
      <div style="font-weight:600;font-size:0.85rem;margin-bottom:0.5rem;">×”×•×¡×£ ×œ××©××¨×ª ×œ×ª×‘× ×™×ª</div>
      <div class="form-row">
        <div class="form-group"><select class="form-select" id="tplMissionType">${mtOptions}</select></div>
        <div class="form-group" style="display:flex;align-items:center;">
          <label style="display:flex;align-items:center;gap:0.4rem;font-size:0.85rem;cursor:pointer;white-space:nowrap;">
            <input type="checkbox" id="tplAllDay"> ×™×•× ×©×œ×
          </label>
        </div>
        <div class="form-group"><input class="form-input" id="tplStart" type="time" value="08:00"></div>
        <div class="form-group"><input class="form-input" id="tplEnd" type="time" value="16:00"></div>
      </div>
      <div class="form-row" id="tplRestRow" style="display:none;margin-top:0.4rem;">
        <div class="form-group" style="display:flex;align-items:center;">
          <label style="display:flex;align-items:center;gap:0.4rem;font-size:0.85rem;white-space:nowrap;">
            ×× ×•×—×”:
            <select class="form-select" id="tplRestEndTime" style="font-size:0.85rem;padding:0.2rem 0.35rem;">
              <option value="">×œ×œ× ×× ×•×—×”</option>
              <option value="14:00">06:00-14:00 (×¤× ×•×™ ×‘×‘×•×§×¨)</option>
            </select>
          </label>
        </div>
      </div>
      <button class="btn btn--sm btn--primary" id="addTemplate">×”×•×¡×£</button>
    </div>`;

    return html;
  }

  // ===================== FAIRNESS MODAL =====================

  function openFairnessModal() {
    // Aggregate assignment data
    const personStats = {};
    if (calendarData) {
      calendarData.names.forEach(name => {
        personStats[name] = { totalHours: 0, missions: {} };
        missionTypes.forEach(mt => { personStats[name].missions[mt.id] = 0; });
      });
    }

    shifts.forEach(s => {
      (s.assignments || []).forEach(a => {
        if (!personStats[a.name]) {
          personStats[a.name] = { totalHours: 0, missions: {} };
          missionTypes.forEach(mt => { personStats[a.name].missions[mt.id] = 0; });
        }
        const dur = getEffectiveDuration(s);
        personStats[a.name].totalHours += dur;
        personStats[a.name].missions[s.mission_type] = (personStats[a.name].missions[s.mission_type] || 0) + 1;
      });
    });

    const maxHours = Math.max(1, ...Object.values(personStats).map(p => p.totalHours));

    let tableHtml = '<table class="fairness-table"><thead><tr><th>×©×</th><th>×¡×”×´×› ×©×¢×•×ª</th>';
    missionTypes.forEach(mt => { tableHtml += `<th>${escapeHtml(mt.name)}</th>`; });
    tableHtml += '<th>×—×œ×•×§×”</th></tr></thead><tbody>';

    const sortedNames = Object.keys(personStats).sort((a, b) => personStats[b].totalHours - personStats[a].totalHours);

    sortedNames.forEach(name => {
      const p = personStats[name];
      if (p.totalHours === 0) return;
      const barWidth = Math.round((p.totalHours / maxHours) * 100);
      tableHtml += `<tr>
        <td style="font-weight:500;">${escapeHtml(name)}</td>
        <td>${p.totalHours}</td>`;
      missionTypes.forEach(mt => {
        tableHtml += `<td>${p.missions[mt.id] || 0}</td>`;
      });
      tableHtml += `<td class="fairness-bar-cell"><div class="fairness-bar" style="width:${barWidth}%;"></div></td>
      </tr>`;
    });

    tableHtml += '</tbody></table>';

    if (sortedNames.length === 0 || Object.values(personStats).every(p => p.totalHours === 0)) {
      tableHtml = '<div class="empty-state"><div class="empty-state__icon">ğŸ“Š</div><div class="empty-state__text">××™×Ÿ × ×ª×•× ×™ ×©×™×‘×•×¥ ×œ×”×¦×’×”</div></div>';
    }

    createModal('×œ×•×— ×”×•×’× ×•×ª', `<div style="overflow-x:auto;">${tableHtml}</div>`, '');
  }

  // ===================== DATE NAVIGATION =====================

  function updateDateDisplay() {
    const label = document.getElementById('dateLabel');
    const subtitle = document.getElementById('headerSubtitle');

    if (currentView === 'day') {
      label.textContent = formatDateHebrew(currentDate);
      subtitle.textContent = formatDateStr(currentDate);
    } else {
      const weekDates = getWeekDates(currentDate);
      const startStr = `${weekDates[0].getDate()}/${weekDates[0].getMonth() + 1}`;
      const endStr = `${weekDates[6].getDate()}/${weekDates[6].getMonth() + 1}`;
      label.textContent = `${startStr} â€” ${endStr}`;
      subtitle.textContent = `×©×‘×•×¢: ${formatDateStr(weekDates[0])} ×¢×“ ${formatDateStr(weekDates[6])}`;
    }
  }

  // ===================== HELP MODAL =====================

  function openHelpModal() {
    const helpHtml = `
      <div style="font-size:0.88rem;line-height:1.8;color:var(--clr-text);">

        <h3 style="font-size:1.05rem;font-weight:700;margin-bottom:0.5rem;color:var(--clr-accent);">××” ×–×” ×©×‘×¦×´×§?</h3>
        <p>×©×‘×¦×´×§ ×”×•× ××¢×¨×›×ª ×©×™×‘×•×¥ ××©××¨×•×ª ×œ××—×œ×§×”. ×”××¢×¨×›×ª ××—×•×‘×¨×ª ×™×©×™×¨×•×ª ×œ×œ×•×— ×”×©× ×” (×œ×•×— ×”×¤×¢×™×œ×•×™×•×ª) â€” ×”×™× ×™×•×“×¢×ª ××™ × ××¦× ×‘××•×¦×‘ ×•××™ ×‘×‘×™×ª ×‘×›×œ ×™×•×, ×•××©×‘×¦×ª ×× ×©×™× ×œ××©××¨×•×ª ×‘×”×ª××.</p>

        <h3 style="font-size:1.05rem;font-weight:700;margin:1rem 0 0.5rem;color:var(--clr-accent);">×—×™×‘×•×¨ ×œ×œ×•×— ×”×©× ×”</h3>
        <p>×”××¢×¨×›×ª ×§×•×¨××ª ××ª × ×ª×•× ×™ ×”× ×•×›×—×•×ª ××”×’×™×œ×™×•×Ÿ (×¡×˜×˜×•×¡ "×‘××•×¦×‘" / "×‘×‘×™×ª" ×œ×›×œ ××“× ×‘×›×œ ×™×•×). ×¨×§ ×× ×©×™× ×©× ××¦××™× <strong>×‘××•×¦×‘</strong> ×‘××•×ª×• ×™×•× ×–××™× ×™× ×œ×©×™×‘×•×¥. ×× ××“× ×™×•×¦× ×”×‘×™×ª×” â€” ×”×•× ×œ× ×™×•×¤×™×¢ ×›×–××™×Ÿ, ×•×¡×¤×™×¨×ª ×”×™××™× ×”×¨×¦×•×¤×™× ×©×œ×• ××ª××¤×¡×ª.</p>

        <h3 style="font-size:1.05rem;font-weight:700;margin:1rem 0 0.5rem;color:var(--clr-accent);">×ª×”×œ×™×š ×¢×‘×•×“×” ××•××œ×¥</h3>
        <ol style="padding-right:1.2rem;">
          <li><strong>×™×¦×™×¨×ª ××©××¨×•×ª</strong> â€” ×‘×—×¨×• ×˜×•×•×— ×ª××¨×™×›×™× ×•×œ×—×¦×• "×¦×•×¨ ××©××¨×•×ª ××ª×‘× ×™×ª".</li>
          <li><strong>×©×™×‘×•×¥ ×™×“× ×™ ×—×œ×§×™ (××•×¤×¦×™×•× ×œ×™)</strong> â€” ×œ×—×¦×• ×¢×œ ğŸ‘¥ ×‘××©××¨×•×ª ×©×‘×”×Ÿ ××ª× ×¨×•×¦×™× ×œ×§×‘×¢ ×× ×©×™× ×¡×¤×¦×™×¤×™×™×. ××¤×©×¨ ×œ×©×‘×¥ ×—×œ×§ ××”×× ×©×™× â€” ×œ× ×—×•×‘×” ×œ××œ× ××ª ×›×œ ×”×“×¨×™×©×•×ª.</li>
          <li><strong>×©×™×‘×•×¥ ××•×˜×•××˜×™</strong> â€” ×œ×—×¦×• "×©×™×‘×•×¥ ××•×˜×•××˜×™". ×”××¢×¨×›×ª ×ª×©×œ×™× ××ª ×”××©××¨×•×ª ×©×œ× ××œ××•×ª, ×‘×œ×™ ×œ×’×¢×ª ×‘×©×™×‘×•×¦×™× ×™×“× ×™×™× (ğŸ“Œ). ×–×• ×”×“×¨×š ×”××•××œ×¦×ª: ×§×•×“× ×§×•×‘×¢×™× ×™×“× ×™×ª ××ª ××” ×©×—×©×•×‘, ×•××– ×”××¢×¨×›×ª ××©×œ×™××” ××ª ×”×©××¨.</li>
          <li><strong>×‘×“×™×§×” ×•×ª×™×§×•×Ÿ</strong> â€” ×‘×“×§×• ×”×ª×¨××•×ª ×•×”×•×’× ×•×ª.</li>
          <li><strong>×™×™×¦×•×</strong> â€” ×œ×—×¦×• "×™×™×¦×•× PDF" ×œ×”×“×¤×¡×”.</li>
        </ol>

        <h3 style="font-size:1.05rem;font-weight:700;margin:1rem 0 0.5rem;color:var(--clr-accent);">×¡×•×’×™ ××©×™××•×ª</h3>
        <p>×›×œ ×¡×•×’ ××©×™××” ××•×’×“×¨ ×¢×: ×©×, ×¦×‘×¢, ××©×š, ××™× ×™××•× ×× ×©×™×, ×•×“×¨×™×©×•×ª ×ª×¤×§×™×“. × ×™×ª×Ÿ ×œ×”×•×¡×™×£, ×œ×¢×¨×•×š ×•×œ××—×•×§ ×¡×•×’×™ ××©×™××•×ª ×‘×”×’×“×¨×•×ª. ×“×¨×™×©×•×ª ×”×ª×¤×§×™×“:</p>
        <ul style="padding-right:1.2rem;">
          <li><strong>×§×¦×™×Ÿ ×—×•×‘×”</strong> â€” ×”××©×™××” ×“×•×¨×©×ª ×§×¦×™×Ÿ ×¡×¤×¦×™×¤×™×ª (×œ× ××¤×§×“ ×¨×’×™×œ). ×× ××™×Ÿ ×§×¦×™×Ÿ ×–××™×Ÿ â€” ×ª×•×¤×™×¢ ×”×ª×¨××”.</li>
          <li><strong>××¤×§×“</strong> â€” ×”××©×™××” ×“×•×¨×©×ª ××¤×§×“. ×§×¦×™×Ÿ ××§×‘×œ ×¢×“×™×¤×•×ª, ××š ×’× ××¤×§×“ ×¨×’×™×œ ×™×›×•×œ ×œ××œ× ××ª ×”×ª×¤×§×™×“.</li>
          <li><strong>× ×”×’</strong> â€” ×”××©×™××” ×“×•×¨×©×ª × ×”×’ ××ª×•×™×’.</li>
        </ul>

        <h3 style="font-size:1.05rem;font-weight:700;margin:1rem 0 0.5rem;color:var(--clr-accent);">×ª×¤×§×™×“×™× ×•×ª×’×™×•×ª</h3>
        <table style="width:100%;border-collapse:collapse;margin:0.5rem 0;font-size:0.82rem;">
          <tr style="border-bottom:1px solid var(--clr-border);">
            <td style="padding:0.4rem 0.6rem;font-weight:600;">×§×¦×™×Ÿ</td>
            <td style="padding:0.4rem 0.6rem;">×ª××™×“ ××©×•×‘×¥ ×›××¤×§×“. ×œ× ×™×©××© ×›×—×™×™×œ ×¨×’×™×œ ××• × ×”×’ â€” ×ª××™×“ ×‘×ª×¤×§×™×“ ×¤×™×§×•×“.</td>
          </tr>
          <tr style="border-bottom:1px solid var(--clr-border);">
            <td style="padding:0.4rem 0.6rem;font-weight:600;">××¤×§×“</td>
            <td style="padding:0.4rem 0.6rem;">××•×¢×“×£ ×œ×ª×¤×§×™×“ ××¤×§×“ ×‘××©××¨×•×ª ×©×“×•×¨×©×•×ª ××¤×§×“. ×× ×™×© ××¡×¤×™×§ ×× ×©×™× â€” ×™×›×•×œ ×œ×©××© ×’× ×›×—×™×™×œ ×¨×’×™×œ ××• × ×”×’.</td>
          </tr>
          <tr style="border-bottom:1px solid var(--clr-border);">
            <td style="padding:0.4rem 0.6rem;font-weight:600;">× ×”×’</td>
            <td style="padding:0.4rem 0.6rem;">××•×¢×“×£ ×œ×ª×¤×§×™×“ × ×”×’. ×× ×™×© ××¡×¤×™×§ × ×”×’×™× â€” ×™×›×•×œ ×œ×©××© ×’× ×›×—×™×™×œ ×¨×’×™×œ.</td>
          </tr>
          <tr>
            <td style="padding:0.4rem 0.6rem;font-weight:600;">×—×™×™×œ</td>
            <td style="padding:0.4rem 0.6rem;">×ª×¤×§×™×“ ×‘×¨×™×¨×ª ××—×“×œ ×œ×›×œ ××™ ×©×œ× ××ª×•×™×’ ××—×¨×ª.</td>
          </tr>
        </table>

        <h3 style="font-size:1.05rem;font-weight:700;margin:1rem 0 0.5rem;color:var(--clr-accent);">×©×™×‘×•×¥ ×™×“× ×™ (ğŸ“Œ)</h3>
        <p>×œ×—×¦×• ×¢×œ ××™×™×§×•×Ÿ ×”×× ×©×™× (ğŸ‘¥) ×‘××©××¨×ª ×›×œ×©×”×™. ×‘×—×¨×• ×× ×©×™× ×•×§×‘×¢×• ×œ×”× ×ª×¤×§×™×“. ×©×™×‘×•×¥ ×™×“× ×™ ×”×•× <strong>× ×¢×•×œ</strong>:</p>
        <ul style="padding-right:1.2rem;">
          <li>×”×©×™×‘×•×¥ ×”××•×˜×•××˜×™ <strong>×œ× ×™×©× ×”</strong> ××•×ª×•</li>
          <li>××•×ª×• ××“× <strong>×œ× ×™×©×•×‘×¥</strong> ×œ××©××¨×ª ××—×¨×ª ×©×—×•×¤×¤×ª ×‘×–××Ÿ</li>
          <li>××¡×•××Ÿ ×‘-ğŸ“Œ ×‘×›×¨×˜×™×¡ ×”××©××¨×ª</li>
        </ul>

        <div style="margin-top:0.75rem;padding:0.75rem;background:var(--clr-accent-bg);border-radius:8px;font-size:0.82rem;">
          <strong>ğŸ’¡ ×˜×™×¤:</strong> ×”×“×¨×š ×”× ×›×•× ×” ×œ×¢×‘×•×“ â€” ×§×•×“× ×©×™×‘×•×¥ ×™×“× ×™ ×—×œ×§×™ (×œ×§×‘×¢ ××ª ×”×× ×©×™× ×©×—×©×•×‘×™× ×œ×›×), ×•××– ×©×™×‘×•×¥ ××•×˜×•××˜×™ ×©××©×œ×™× ××ª ×”×©××¨. ×”×©×™×‘×•×¥ ×”××•×˜×•××˜×™ ××£ ×¤×¢× ×œ× ×“×•×¨×¡ ×©×™×‘×•×¥ ×™×“× ×™.
        </div>

        <h3 style="font-size:1.05rem;font-weight:700;margin:1rem 0 0.5rem;color:var(--clr-accent);">××™×š ×¢×•×‘×“ ×”×©×™×‘×•×¥ ×”××•×˜×•××˜×™?</h3>
        <p>×”××¢×¨×›×ª ×××œ××ª ××ª ×”××©××¨×•×ª ×‘×¦×•×¨×” ×—×›××”:</p>
        <ol style="padding-right:1.2rem;">
          <li><strong>×–××™× ×•×ª</strong> â€” ×¨×§ ×× ×©×™× ×©× ××¦××™× ×‘××•×¦×‘ (×œ×¤×™ ×œ×•×— ×”×©× ×”) ×–××™× ×™× ×œ×©×™×‘×•×¥.</li>
          <li><strong>××™×œ×•×¦×™× ×§×©×™×—×™×</strong> â€” ×”××¢×¨×›×ª ×œ× ×ª×©×‘×¥ ××“× ××:
            <ul style="padding-right:1rem;">
              <li>×”×•× ×›×‘×¨ ××©×•×‘×¥ ×œ××©××¨×ª ×—×•×¤×¤×ª ×‘××•×ª×• ×™×•×</li>
              <li>×”×•× ×¤×˜×•×¨ ××¡×•×’ ×”××©×™××” ×”×–×” (×¤×˜×•×¨×™× ×‘×”×’×“×¨×•×ª)</li>
              <li>×œ× ×¢×‘×¨×• ××¡×¤×™×§ ×©×¢×•×ª ×× ×•×—×” ×××– ×”××©××¨×ª ×”×§×•×“××ª ×©×œ×•</li>
              <li>×™×© ×›×œ×œ "××¡×•×¨ ×™×—×“" ×¢× ××“× ×©×›×‘×¨ ××©×•×‘×¥</li>
            </ul>
          </li>
          <li><strong>× ×™×§×•×“ ×”×•×’× ×•×ª</strong> â€” ××‘×™×Ÿ ×”×–××™× ×™×, ×”××¢×¨×›×ª ××¢×“×™×¤×”:
            <ul style="padding-right:1rem;">
              <li>×× ×©×™× ×¢× ×¤×—×•×ª ×©×¢×•×ª ×©×™×‘×•×¥ ×›×•×œ×œ×•×ª (×”×•×’× ×•×ª)</li>
              <li>×× ×©×™× ×©×œ× ×¢×©×• ××ª ×”××©×™××” ×”×–×• ×œ××—×¨×•× ×” (×’×™×•×•×Ÿ)</li>
              <li>×× ×©×™× ×¢× ×›×œ×œ "×—×™×™×‘ ×™×—×“" ×©×”×©×•×ª×£ ×©×œ×”× ×’× ×–××™×Ÿ</li>
            </ul>
          </li>
        </ol>

        <h3 style="font-size:1.05rem;font-weight:700;margin:1rem 0 0.5rem;color:var(--clr-accent);">×”×’×‘×œ×ª ×™××™× ×¨×¦×•×¤×™× (××•×¤×¦×™×•× ×œ×™)</h3>
        <p>× ×™×ª×Ÿ ×œ×”×¤×¢×™×œ ×‘×”×’×“×¨×•×ª â†’ ×¤×¨××˜×¨×™×. ×›×©××•×¤×¢×œ, ×”××¢×¨×›×ª ××¢×“×™×¤×” ×œ×ª×ª ×”×¤×¡×§×” ×œ×× ×©×™× ×©×¢×‘×“×• ×™××™× ×¨×‘×™× ×‘×¨×¦×£. ×”×¡×¤×™×¨×” <strong>××ª××¤×¡×ª</strong> ×›×©××“× ×™×•×¦× ×”×‘×™×ª×”.</p>

        <h3 style="font-size:1.05rem;font-weight:700;margin:1rem 0 0.5rem;color:var(--clr-accent);">×”×’×“×¨×•×ª × ×•×¡×¤×•×ª (âš™)</h3>
        <table style="width:100%;border-collapse:collapse;margin:0.5rem 0;font-size:0.82rem;">
          <tr style="border-bottom:1px solid var(--clr-border);">
            <td style="padding:0.4rem 0.6rem;font-weight:600;">×¡×•×’×™ ××©×™××•×ª</td>
            <td style="padding:0.4rem 0.6rem;">×”×•×¡×¤×”, ×¢×¨×™×›×” ×•××—×™×§×” ×©×œ ×¡×•×’×™ ××©××¨×•×ª (×¡×™×•×¨, ×©××™×¨×”, ××˜×‘×— ×•×›×•×³).</td>
          </tr>
          <tr style="border-bottom:1px solid var(--clr-border);">
            <td style="padding:0.4rem 0.6rem;font-weight:600;">×ª×’×™×•×ª ×›×•×— ××“×</td>
            <td style="padding:0.4rem 0.6rem;">×¡×™××•×Ÿ ×× ×©×™× ×›×§×¦×™×Ÿ, ××¤×§×“ ××• × ×”×’.</td>
          </tr>
          <tr style="border-bottom:1px solid var(--clr-border);">
            <td style="padding:0.4rem 0.6rem;font-weight:600;">×¤×˜×•×¨×™×</td>
            <td style="padding:0.4rem 0.6rem;">×¤×˜×•×¨ ××“× ××¡×•×’ ××©×™××” ××¡×•×™× (×œ××©×œ: ×¤×˜×•×¨ ×××˜×‘×—).</td>
          </tr>
          <tr style="border-bottom:1px solid var(--clr-border);">
            <td style="padding:0.4rem 0.6rem;font-weight:600;">×›×œ×œ×™ ×–×•×’×•×ª</td>
            <td style="padding:0.4rem 0.6rem;">"×—×™×™×‘ ×™×—×“" â€” ×©× ×™ ×× ×©×™× ××©×•×‘×¦×™× ×™×—×“. "××¡×•×¨ ×™×—×“" â€” ×œ× ×™×©×•×‘×¦×• ×œ××•×ª×” ××©××¨×ª.</td>
          </tr>
          <tr style="border-bottom:1px solid var(--clr-border);">
            <td style="padding:0.4rem 0.6rem;font-weight:600;">×¤×¨××˜×¨×™×</td>
            <td style="padding:0.4rem 0.6rem;">×©×¢×•×ª ×× ×•×—×” ××™× ×™××œ×™×•×ª ×•×”×’×‘×œ×ª ×™××™× ×¨×¦×•×¤×™×.</td>
          </tr>
          <tr>
            <td style="padding:0.4rem 0.6rem;font-weight:600;">×ª×‘× ×™×ª ××©××¨×•×ª</td>
            <td style="padding:0.4rem 0.6rem;">×”×’×“×¨×ª ×”××©××¨×•×ª ×©× ×•×¦×¨×•×ª ×‘×›×œ ×™×•× (×¡×•×’, ×©×¢×ª ×”×ª×—×œ×” ×•×¡×™×•×).</td>
          </tr>
        </table>

        <h3 style="font-size:1.05rem;font-weight:700;margin:1rem 0 0.5rem;color:var(--clr-accent);">×›×¤×ª×•×¨×™×</h3>
        <table style="width:100%;border-collapse:collapse;margin:0.5rem 0;font-size:0.82rem;">
          <tr style="border-bottom:1px solid var(--clr-border);">
            <td style="padding:0.4rem 0.6rem;font-weight:600;">âš™ ×”×’×“×¨×•×ª</td>
            <td style="padding:0.4rem 0.6rem;">×¤×ª×™×—×ª ×—×œ×•×Ÿ ×”×”×’×“×¨×•×ª.</td>
          </tr>
          <tr style="border-bottom:1px solid var(--clr-border);">
            <td style="padding:0.4rem 0.6rem;font-weight:600;">×©×™×‘×•×¥ ××•×˜×•××˜×™</td>
            <td style="padding:0.4rem 0.6rem;">×”×¤×¢×œ×ª ×”×©×™×‘×•×¥ ×”×—×›× ×œ×™×•× / ×©×‘×•×¢ ×”× ×•×›×—×™.</td>
          </tr>
          <tr style="border-bottom:1px solid var(--clr-border);">
            <td style="padding:0.4rem 0.6rem;font-weight:600;">×”×•×’× ×•×ª</td>
            <td style="padding:0.4rem 0.6rem;">×˜×‘×œ×ª ×—×œ×•×§×ª ×©×¢×•×ª ×•××©×™××•×ª ×œ×›×œ ××“×.</td>
          </tr>
          <tr style="border-bottom:1px solid var(--clr-border);">
            <td style="padding:0.4rem 0.6rem;font-weight:600;">×”×ª×¨××•×ª</td>
            <td style="padding:0.4rem 0.6rem;">×¨×©×™××ª ×‘×¢×™×•×ª: ××©××¨×•×ª ×—×¡×¨×•×ª ×× ×©×™×, ×—×¡×¨ ××¤×§×“/× ×”×’.</td>
          </tr>
          <tr style="border-bottom:1px solid var(--clr-border);">
            <td style="padding:0.4rem 0.6rem;font-weight:600;">×™×™×¦×•× PDF</td>
            <td style="padding:0.4rem 0.6rem;">×¤×ª×™×—×ª ×”×©×‘×¦×´×§ ×‘×—×œ×•×Ÿ ×”×“×¤×¡×” ×œ×©××™×¨×” ×›-PDF ××• ×”×“×¤×¡×”.</td>
          </tr>
          <tr style="border-bottom:1px solid var(--clr-border);">
            <td style="padding:0.4rem 0.6rem;font-weight:600;">××—×§ ×™×•×</td>
            <td style="padding:0.4rem 0.6rem;">××—×™×§×ª ×›×œ ×”××©××¨×•×ª ×©×œ ×”×™×•× (×›×•×œ×œ ×©×™×‘×•×¦×™×). ××¤×©×¨ ×œ×™×¦×•×¨ ××—×“×© ××ª×‘× ×™×ª.</td>
          </tr>
          <tr>
            <td style="padding:0.4rem 0.6rem;font-weight:600;">ğŸ‘¥ (×‘×›×¨×˜×™×¡ ××©××¨×ª)</td>
            <td style="padding:0.4rem 0.6rem;">×©×™×‘×•×¥ ×™×“× ×™ â€” ×‘×—×™×¨×ª ×× ×©×™× ×•×ª×¤×§×™×“×™× ×™×“× ×™×ª ×œ××©××¨×ª.</td>
          </tr>
        </table>

        <h3 style="font-size:1.05rem;font-weight:700;margin:1rem 0 0.5rem;color:var(--clr-accent);">×ª×¦×•×’×•×ª</h3>
        <p><strong>×ª×¦×•×’×ª ×™×•×</strong> â€” ×›×¨×˜×™×¡×™ ××©××¨×•×ª ××¤×•×¨×˜×™× ×¢× ×©××•×ª, ×ª×¤×§×™×“×™× ×•×”×¢×¨×•×ª.<br>
        <strong>×ª×¦×•×’×ª ×©×‘×•×¢</strong> â€” ×ª×¦×•×’×ª ×’×× ×˜ (×¦×™×¨ ×–××Ÿ) ×©××¨××” ××ª ×›×œ ×”××©××¨×•×ª ×©×œ ×”×©×‘×•×¢ ×‘×˜×‘×œ×”.</p>

        <div style="margin-top:1.5rem;padding:0.75rem;background:var(--clr-accent-bg);border-radius:8px;font-size:0.82rem;">
          <strong>×˜×™×¤:</strong> ×œ×—×¦×• ×¢×œ ×”×ª××¨×™×š ×‘×¡×¨×’×œ ×”×¢×œ×™×•×Ÿ ×›×“×™ ×œ×¤×ª×•×— ×‘×•×¨×¨ ×ª××¨×™×›×™× ×•×œ×§×¤×•×¥ ×œ×™×•× ×¡×¤×¦×™×¤×™.
        </div>
      </div>
    `;

    createModal('×¢×–×¨×” â€” ××¢×¨×›×ª ×©×‘×¦×´×§', helpHtml, '');
  }

  function navigateDate(delta) {
    if (currentView === 'day') {
      currentDate.setDate(currentDate.getDate() + delta);
    } else {
      currentDate.setDate(currentDate.getDate() + delta * 7);
    }
    updateDateDisplay();
    refreshView();
  }

  // ===================== VIEW REFRESH =====================

  async function refreshView() {
    showLoading();
    try {
      let startDate, endDate;
      if (currentView === 'day') {
        startDate = endDate = formatDateStr(currentDate);
      } else {
        const weekDates = getWeekDates(currentDate);
        startDate = formatDateStr(weekDates[0]);
        endDate = formatDateStr(weekDates[6]);
      }

      // Load extra 3 days back for person history tooltip
      const recentStart = new Date(parseDateStr(startDate));
      recentStart.setDate(recentStart.getDate() - 3);
      const allLoaded = await loadShifts(formatDateStr(recentStart), endDate);

      recentShifts = allLoaded.filter(s => s.date < startDate);
      shifts = allLoaded.filter(s => s.date >= startDate && s.date <= endDate);
      buildShiftsByDateIndex();

      if (currentView === 'day') {
        renderDayView();
      } else {
        renderWeekView();
      }
    } finally {
      hideLoading();
    }
  }

  // ===================== DELETE SHIFTS (DATE RANGE) =====================

  function promptDeleteShifts() {
    if (isBusy) { showToast('×¤×¢×•×œ×” ×‘×ª×”×œ×™×š, × × ×œ×”××ª×™×Ÿ', 'info'); return; }
    const today = formatDateStr(currentDate);
    const { overlay, close } = createModal('××—×™×§×ª ××©××¨×•×ª', `
      <div class="form-group">
        <label class="form-label">×ª××¨×™×š ×”×ª×—×œ×”</label>
        <input type="date" class="form-input" id="modalDeleteStart" value="${today}">
      </div>
      <div class="form-group">
        <label class="form-label">×ª××¨×™×š ×¡×™×•×</label>
        <input type="date" class="form-input" id="modalDeleteEnd" value="${today}">
      </div>
      <div class="form-hint" id="deletePreview" style="margin-top:0.5rem;font-weight:500;"></div>
    `, `
      <button class="btn btn--danger" id="modalDeleteBtn">××—×§ ××©××¨×•×ª</button>
      <button class="btn" id="modalDeleteCancel">×‘×™×˜×•×œ</button>
    `);

    let debounceTimer;
    async function updatePreview() {
      const start = overlay.querySelector('#modalDeleteStart').value;
      const end = overlay.querySelector('#modalDeleteEnd').value;
      const preview = overlay.querySelector('#deletePreview');
      if (!start || !end || start > end) {
        preview.textContent = start && end && start > end ? '×ª××¨×™×š ×”×ª×—×œ×” ×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤× ×™ ×ª××¨×™×š ×¡×™×•×' : '';
        return;
      }
      preview.textContent = '×˜×•×¢×Ÿ...';
      try {
        const rangeShifts = await loadShifts(start, end);
        preview.textContent = rangeShifts.length > 0
          ? `×™×™××—×§×• ${rangeShifts.length} ××©××¨×•×ª`
          : '××™×Ÿ ××©××¨×•×ª ×‘×˜×•×•×— ×–×”';
      } catch (e) {
        preview.textContent = '×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×';
      }
    }

    function debouncedPreview() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(updatePreview, 300);
    }

    overlay.querySelector('#modalDeleteStart').addEventListener('change', debouncedPreview);
    overlay.querySelector('#modalDeleteEnd').addEventListener('change', debouncedPreview);
    updatePreview();

    overlay.querySelector('#modalDeleteBtn').addEventListener('click', async () => {
      const start = overlay.querySelector('#modalDeleteStart').value;
      const end = overlay.querySelector('#modalDeleteEnd').value;
      if (!start || !end) { showToast('×™×© ×œ×‘×—×•×¨ ×ª××¨×™×›×™×', 'error'); return; }
      if (start > end) { showToast('×ª××¨×™×š ×”×ª×—×œ×” ×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤× ×™ ×ª××¨×™×š ×¡×™×•×', 'error'); return; }

      close();
      showLoading();
      try {
        const rangeShifts = await loadShifts(start, end);
        if (rangeShifts.length === 0) {
          showToast('××™×Ÿ ××©××¨×•×ª ×œ××—×™×§×” ×‘×˜×•×•×— ×–×”', 'info');
          return;
        }
        const ids = rangeShifts.map(s => s.id);
        await callAppsScript({ action: 'deleteRosterShifts', ids });
        showToast(`× ××—×§×• ${ids.length} ××©××¨×•×ª`, 'success');
        await refreshView();
      } catch (err) {
        // toast shown
      } finally {
        hideLoading();
      }
    });

    overlay.querySelector('#modalDeleteCancel').addEventListener('click', close);
  }

  // ===================== PDF EXPORT =====================

  function exportPdf() {
    const dateStr = formatDateStr(currentDate);
    const dayShifts = (shiftsByDateIndex.get(dateStr) || []).slice();

    if (dayShifts.length === 0) {
      showToast('××™×Ÿ ××©××¨×•×ª ×œ×™×™×¦×•× ×‘×™×•× ×–×”', 'info');
      return;
    }

    sortShiftsByTypeAndTime(dayShifts);
    const pdfDuplicates = getDuplicateNames(dateStr);

    const dateLabel = formatDateHebrew(currentDate);

    let html = `<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>×©×‘×¦×´×§ â€” ${dateLabel}</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&family=Frank+Ruhl+Libre:wght@700;900&display=swap');
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Heebo', sans-serif; padding: 2rem; color: #1a1612; direction: rtl; }
  h1 { font-family: 'Frank Ruhl Libre', serif; font-size: 1.8rem; text-align: center; margin-bottom: 0.25rem; }
  .subtitle { text-align: center; font-size: 1rem; color: #6b5e52; margin-bottom: 1.5rem; }
  .line { width: 60px; height: 3px; background: linear-gradient(90deg, #7c3aed, #2563eb); border-radius: 3px; margin: 0.5rem auto 1.5rem; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; }
  th { background: #f5f1ec; padding: 0.6rem 0.8rem; text-align: right; font-weight: 700; font-size: 0.85rem; border: 1px solid #e8e2da; }
  td { padding: 0.5rem 0.8rem; border: 1px solid #e8e2da; font-size: 0.85rem; vertical-align: top; }
  .mission-header { background: #faf8f5; font-weight: 700; font-size: 0.95rem; }
  .mission-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-left: 0.4rem; vertical-align: middle; }
  .role-badge { display: inline-block; font-size: 0.72rem; padding: 0.1rem 0.4rem; border-radius: 4px; background: #f0edf5; color: #5b21b6; margin-right: 0.3rem; }
  .dup { color: #d97706; }
  .footnotes { margin-top: 1rem; padding: 0.6rem 0.8rem; border-top: 1px solid #e8e2da; font-size: 0.8rem; color: #92400e; }
  .note-row td { background: #fef9c3; font-size: 0.8rem; color: #92400e; font-style: italic; }
  .footer { text-align: center; font-size: 0.75rem; color: #9c8f82; margin-top: 2rem; border-top: 1px solid #e8e2da; padding-top: 0.75rem; }
  @media print { body { padding: 1rem; } }
</style>
</head>
<body>
<h1>×©×‘×¦×´×§ â€” ×¤×œ×•×’×” ×‘</h1>
<div class="subtitle">${escapeHtml(dateLabel)} | ${dateStr}</div>
<div class="line"></div>
<table>
<thead>
  <tr>
    <th style="width:20%;">××©×™××”</th>
    <th style="width:20%;white-space:nowrap;">×©×¢×•×ª</th>
    <th style="width:60%;">××©×•×‘×¦×™×</th>
  </tr>
</thead>
<tbody>`;

    dayShifts.forEach(shift => {
      const mt = getMissionType(shift.mission_type);
      const mtName = mt ? mt.name : shift.mission_type;
      const color = mt ? mt.color : '#888';
      const minTeam = mt ? mt.min_team : 1;
      const assigned = shift.assignments || [];
      const count = assigned.length;
      const timeLabel = shift.start_time === shift.end_time ? '×™×•× ×©×œ×' : `${shift.start_time} â€” ${shift.end_time}`;
      const statusText = count >= minTeam ? `âœ“ ${count}/${minTeam}` : `âœ— ${count}/${minTeam}`;

      const peopleHtml = assigned.length > 0
        ? assigned.map(a => {
            const roleLabel = ROLE_LABELS[a.role] || '';
            const badge = a.role !== 'member' ? `<span class="role-badge">${roleLabel}</span>` : '';
            const nameHtml = pdfDuplicates.has(a.name) ? `<span class="dup">âš  ${escapeHtml(a.name)}</span>` : escapeHtml(a.name);
            return `${nameHtml}${badge}`;
          }).join('<br>')
        : '<span style="color:#9c8f82;">â€”</span>';

      html += `
  <tr>
    <td class="mission-header"><span class="mission-dot" style="background:${color};"></span>${escapeHtml(mtName)}</td>
    <td style="direction:ltr;text-align:center;white-space:nowrap;">${timeLabel}</td>
    <td>${peopleHtml}</td>
  </tr>`;

      if (shift.note) {
        html += `<tr class="note-row"><td colspan="3">ğŸ“ ${escapeHtml(shift.note)}</td></tr>`;
      }
    });

    html += `
</tbody>
</table>`;

    if (pdfDuplicates.size > 0) {
      html += '<div class="footnotes">âš  â€” ××©×•×‘×¥/×ª ×œ×™×•×ª×¨ ×××©×™××” ××—×ª</div>';
    }

    html += `
<div class="footer">×©×‘×¦×´×§ â€” ×¤×œ×•×’×” ×‘ | ×”×•×¤×§ ×‘×ª××¨×™×š ${new Date().toLocaleDateString('he-IL')}</div>
</body>
</html>`;

    // Open in new window for print/save-as-PDF
    const printWindow = window.open('', '_blank');
    printWindow.document.write(html);
    printWindow.document.close();
    // Auto-trigger print dialog after content loads
    printWindow.onload = () => printWindow.print();
  }

  // ===================== THEME =====================

  function initTheme() {
    const saved = localStorage.getItem('theme');
    if (saved === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
    }
  }

  function toggleTheme() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    if (isDark) {
      document.documentElement.removeAttribute('data-theme');
      localStorage.setItem('theme', 'light');
    } else {
      document.documentElement.setAttribute('data-theme', 'dark');
      localStorage.setItem('theme', 'dark');
    }
  }

  // ===================== INIT =====================

  async function init() {
    initTheme();

    // Set initial date to today if in range, else to DATE_START
    const today = new Date();
    const rangeStart = parseDateStr(DATE_START);
    const rangeEnd = parseDateStr(DATE_END);
    if (today >= rangeStart && today <= rangeEnd) {
      currentDate = today;
    } else {
      currentDate = rangeStart;
    }

    updateDateDisplay();

    // Wire up controls
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    document.getElementById('btnPrevDay').addEventListener('click', () => navigateDate(-1));
    document.getElementById('btnNextDay').addEventListener('click', () => navigateDate(1));
    document.getElementById('btnConfig').addEventListener('click', openConfigModal);
    document.getElementById('btnGenerate').addEventListener('click', runAutoSchedule);
    document.getElementById('btnFairness').addEventListener('click', openFairnessModal);

    document.getElementById('btnHelp').addEventListener('click', openHelpModal);
    document.getElementById('btnExportPdf').addEventListener('click', exportPdf);
    document.getElementById('btnDeleteDay').addEventListener('click', promptDeleteShifts);

    document.getElementById('btnAlerts').addEventListener('click', () => {
      const panel = document.getElementById('alertsPanel');
      panel.style.display = panel.style.display === 'none' ? '' : 'none';
      renderAlerts();
    });

    // Delegated event listeners on #mainContent (replaces per-element listeners in render functions)
    const mainContent = document.getElementById('mainContent');

    mainContent.addEventListener('click', (e) => {
      // Shift card action buttons (day view)
      const btn = e.target.closest('.shift-card__action-btn');
      if (btn) {
        const action = btn.dataset.action;
        const shiftId = btn.dataset.shiftId;
        if (action === 'delete') {
          confirmModal('××—×™×§×ª ××©××¨×ª', '×œ××—×•×§ ××ª ×”××©××¨×ª?', '××—×§', () => deleteShift(shiftId));
        } else if (action === 'note') {
          promptShiftNote(shiftId);
        } else if (action === 'manual') {
          promptManualAssign(shiftId);
        }
        return;
      }

      // Week summary day row click (week view)
      const row = e.target.closest('.week-summary__day-row');
      if (row) {
        currentDate = parseDateStr(row.dataset.date);
        currentView = 'day';
        document.getElementById('btnDayView').classList.add('view-toggle__btn--active');
        document.getElementById('btnWeekView').classList.remove('view-toggle__btn--active');
        updateDateDisplay();
        refreshView();
        return;
      }

      // Empty state create-shifts button
      if (e.target.id === 'btnCreateShifts' || e.target.closest('#btnCreateShifts')) {
        promptCreateShifts();
      }
    });

    // View toggle
    document.getElementById('btnDayView').addEventListener('click', () => {
      if (currentView === 'day') return;
      currentView = 'day';
      document.getElementById('btnDayView').classList.add('view-toggle__btn--active');
      document.getElementById('btnWeekView').classList.remove('view-toggle__btn--active');
      updateDateDisplay();
      refreshView();
    });
    document.getElementById('btnWeekView').addEventListener('click', () => {
      if (currentView === 'week') return;
      currentView = 'week';
      document.getElementById('btnWeekView').classList.add('view-toggle__btn--active');
      document.getElementById('btnDayView').classList.remove('view-toggle__btn--active');
      updateDateDisplay();
      refreshView();
    });

    // Date label click â†’ show date picker
    document.getElementById('dateLabel').addEventListener('click', () => {
      const picker = document.getElementById('datePicker');
      picker.classList.toggle('date-nav__input--visible');
      picker.value = formatDateStr(currentDate);
      picker.focus();
    });
    document.getElementById('datePicker').addEventListener('change', (e) => {
      const val = e.target.value;
      if (val) {
        currentDate = parseDateStr(val);
        updateDateDisplay();
        refreshView();
      }
      e.target.classList.remove('date-nav__input--visible');
    });

    // btnCreateShifts click handled by delegated listener above

    // Load data
    showLoading();
    try {
      await Promise.all([loadConfig(), loadCalendarData()]);
      await refreshView();
    } catch (err) {
      showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×', 'error');
    } finally {
      hideLoading();
    }
  }

  // Start
  init();

})();
</script>

</body>
</html>
