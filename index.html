<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>◊ú◊ï◊ó ◊§◊¢◊ô◊ú◊ï◊ô◊ï◊™</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&family=Frank+Ruhl+Libre:wght@700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --clr-bg: #faf8f5;
    --clr-surface: #ffffff;
    --clr-border: #e8e2da;
    --clr-text: #1a1612;
    --clr-text-secondary: #6b5e52;
    --clr-text-tertiary: #9c8f82;
    --clr-activity: #16a34a;
    --clr-activity-bg: #dcfce7;
    --clr-home: #2563eb;
    --clr-home-bg: #dbeafe;
    --clr-shabbat: #eee9f7;
    --clr-shabbat-border: #d4c8e8;
    --clr-shabbat-text: #5b21b6;
    --clr-shavuot: #fef3c7;
    --clr-shavuot-border: #f59e0b;
    --clr-shavuot-text: #92400e;
    --radius: 10px;
    --shadow-sm: 0 1px 3px rgba(26,22,18,0.06);
    --shadow-md: 0 4px 16px rgba(26,22,18,0.08);
    --font-body: 'Heebo', sans-serif;
    --font-display: 'Frank Ruhl Libre', serif;
  }

  [data-theme="dark"] {
    --clr-bg: #1a1714;
    --clr-surface: #242019;
    --clr-border: #3d362c;
    --clr-text: #e8e2da;
    --clr-text-secondary: #a89e92;
    --clr-text-tertiary: #7a7068;
    --clr-activity-bg: #1a2e1a;
    --clr-home-bg: #1a2340;
    --clr-shabbat: #2a2540;
    --clr-shabbat-border: #4a3d6e;
    --clr-shabbat-text: #c4a8f0;
    --clr-shavuot: #332a12;
    --clr-shavuot-border: #a07208;
    --clr-shavuot-text: #f0c050;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.25);
  }

  [data-theme="dark"] body::before { opacity: 0.04; }

  [data-theme="dark"] .cal-header { background: #2a2520; }
  [data-theme="dark"] .cal-header--shabbat { background: #2d2842; color: var(--clr-shabbat-text); }
  [data-theme="dark"] .cal-cell--empty { background: #1e1b16; }
  [data-theme="dark"] .filter-select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23a89e92'%3E%3Cpath d='M4 6l4 4 4-4'/%3E%3C/svg%3E"); }
  [data-theme="dark"] .cal-cell--status-activity .cell-greg { color: #4ade80; }
  [data-theme="dark"] .cal-cell--status-home .cell-greg { color: #60a5fa; }
  [data-theme="dark"] .cal-cell--status-activity .cell-status-label { color: #4ade80; }
  [data-theme="dark"] .cal-cell--status-home .cell-status-label { color: #60a5fa; }
  [data-theme="dark"] .day-modal__close:hover { background: #3d362c; }
  [data-theme="dark"] .day-modal__person--activity { background: #1a2e1a; }
  [data-theme="dark"] .day-modal__person--home { background: #1a2340; }
  [data-theme="dark"] .day-modal__person--switch { background: linear-gradient(135deg, #1a2e1a 50%, #1a2340 50%); }
  [data-theme="dark"] .toolbar__btn { background: #2a2520; border-color: #3d362c; color: #a89e92; }
  [data-theme="dark"] .toolbar__btn:hover { border-color: #5a5040; background: #332e27; }
  [data-theme="dark"] .toolbar__btn--active { background: #1a2e1a; border-color: var(--clr-activity); color: #4ade80; }
  [data-theme="dark"] .save-bar { background: #332a12; border-color: #5a4810; color: #e8e2da; }
  [data-theme="dark"] .filter-nav-btn { background: #2a2520; border-color: #3d362c; color: #a89e92; }
  [data-theme="dark"] .filter-nav-btn:hover { background: #332e27; border-color: #5a5040; }
  [data-theme="dark"] .note-popup { background: var(--clr-surface); }
  [data-theme="dark"] .note-popup__input { background: #1a1714; border-color: #3d362c; color: #e8e2da; }
  [data-theme="dark"] .cell-note { background: #332a12; border-color: #5a4810; color: #f0c050; }
  [data-theme="dark"] .cell-holiday { background: rgba(160,114,8,0.25); color: #f0c050; }
  [data-theme="dark"] .cell-special { background: rgba(239,68,68,0.2); color: #fca5a5; }
  [data-theme="dark"] .example-item__row { background: #2a2520; border-color: #3d362c; }
  [data-theme="dark"] .examples-panel__close:hover { background: #3d362c; }
  [data-theme="dark"] .stats-bar__chip--activity { background: #1a2e1a; color: #4ade80; }
  [data-theme="dark"] .stats-bar__chip--home { background: #1a2340; color: #60a5fa; }
  [data-theme="dark"] .stats-bar__chip--switch { background: #2a2540; color: #a89e92; }
  [data-theme="dark"] .skeleton-header { background: #2a2520; }
  [data-theme="dark"] .skeleton-header__bar { background: #3d362c; }
  [data-theme="dark"] .skeleton-cell__date { background: #3d362c; }
  [data-theme="dark"] .skeleton-cell__line { background: #332e27; }
  [data-theme="dark"] .add-people-modal { background: var(--clr-surface); }
  [data-theme="dark"] .add-people-modal__input { background: #1a1714; border-color: #3d362c; color: #e8e2da; }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--font-body);
    background: var(--clr-bg);
    color: var(--clr-text);
    line-height: 1.5;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
  }

  .app {
    position: relative;
    z-index: 1;
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1.5rem 4rem;
  }

  /* Header */
  .header {
    text-align: center;
    margin-bottom: 2.5rem;
    animation: fadeInDown 0.6s ease-out;
  }

  .header__title {
    font-family: var(--font-display);
    font-weight: 900;
    font-size: clamp(2.2rem, 5vw, 3.5rem);
    color: var(--clr-text);
    letter-spacing: -0.02em;
    margin-bottom: 0.25rem;
  }

  .header__subtitle {
    font-weight: 300;
    font-size: 1.05rem;
    color: var(--clr-text-secondary);
    letter-spacing: 0.01em;
  }

  .header__line {
    width: 60px;
    height: 3px;
    background: linear-gradient(90deg, var(--clr-activity), var(--clr-home));
    border-radius: 3px;
    margin: 1rem auto 0;
  }

  /* Data freshness badge */
  .freshness-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    margin-top: 0.5rem;
    font-size: 0.78rem;
    font-weight: 400;
    padding: 0.2rem 0.65rem;
    border-radius: 12px;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .freshness-badge:hover {
    opacity: 0.8;
  }

  .freshness-badge__dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .freshness-badge--live {
    background: rgba(22,163,74,0.1);
    color: #15803d;
  }
  .freshness-badge--live .freshness-badge__dot { background: #16a34a; }

  .freshness-badge--cached {
    background: rgba(234,179,8,0.12);
    color: #a16207;
  }
  .freshness-badge--cached .freshness-badge__dot { background: #eab308; }

  .freshness-badge--fallback {
    background: rgba(239,68,68,0.1);
    color: #dc2626;
  }
  .freshness-badge--fallback .freshness-badge__dot { background: #ef4444; }

  [data-theme="dark"] .freshness-badge--live { background: rgba(74,222,128,0.1); color: #4ade80; }
  [data-theme="dark"] .freshness-badge--cached { background: rgba(234,179,8,0.1); color: #fbbf24; }
  [data-theme="dark"] .freshness-badge--fallback { background: rgba(248,113,113,0.1); color: #f87171; }

  .header__sheet-link {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    margin-top: 0.75rem;
    font-size: 0.85rem;
    font-weight: 400;
    color: var(--clr-text-tertiary);
    text-decoration: none;
    transition: color 0.2s;
  }

  .header__sheet-link:hover {
    color: var(--clr-text-secondary);
  }

  .header__sheet-link svg {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }

  /* Controls bar */
  .controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1.5rem;
    animation: fadeInUp 0.6s ease-out 0.15s both;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .filter-group__label {
    font-weight: 500;
    font-size: 0.95rem;
    color: var(--clr-text-secondary);
  }

  .filter-select {
    appearance: none;
    -webkit-appearance: none;
    font-family: var(--font-body);
    font-size: 0.95rem;
    font-weight: 500;
    color: var(--clr-text);
    background: var(--clr-surface);
    border: 1.5px solid var(--clr-border);
    border-radius: var(--radius);
    padding: 0.6rem 2.5rem 0.6rem 1rem;
    cursor: pointer;
    box-shadow: var(--shadow-sm);
    transition: border-color 0.2s, box-shadow 0.2s;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236b5e52'%3E%3Cpath d='M4 6l4 4 4-4'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: left 0.75rem center;
    min-width: 160px;
  }

  .filter-nav-btn {
    width: 34px;
    height: 34px;
    border-radius: 8px;
    border: 1.5px solid var(--clr-border);
    background: var(--clr-surface);
    color: var(--clr-text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: border-color 0.2s, background 0.2s, color 0.2s;
    touch-action: manipulation;
    flex-shrink: 0;
  }

  .filter-nav-btn:hover {
    border-color: #c4b8aa;
    background: #f5f1ec;
    color: var(--clr-text);
  }

  .filter-nav-btn:active {
    background: #ede8e1;
  }

  .filter-nav-btn:disabled {
    opacity: 0.3;
    cursor: default;
  }

  .filter-select:hover { border-color: #c4b8aa; }

  .filter-select:focus {
    outline: none;
    border-color: var(--clr-activity);
    box-shadow: 0 0 0 3px rgba(22,163,74,0.12);
  }

  /* Person Search */
  .filter-group__search-wrap {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    position: relative;
  }
  .person-search {
    font-family: var(--font-body);
    font-size: 0.9rem;
    font-weight: 500;
    padding: 0.45rem 2rem 0.45rem 0.75rem;
    border: 1.5px solid var(--clr-border);
    border-radius: var(--radius);
    background: var(--clr-surface);
    color: var(--clr-text);
    direction: rtl;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    width: 100%;
  }
  .person-search:focus {
    border-color: var(--clr-activity);
    box-shadow: 0 0 0 3px rgba(22,163,74,0.12);
  }
  .person-search::placeholder { color: var(--clr-text-tertiary); }
  .person-search-icon {
    position: absolute;
    top: 0.55rem;
    right: 0.55rem;
    width: 14px;
    height: 14px;
    color: var(--clr-text-tertiary);
    pointer-events: none;
  }
  .person-search-clear {
    position: absolute;
    top: 0.35rem;
    left: 0.35rem;
    width: 22px;
    height: 22px;
    border: none;
    background: var(--clr-border);
    color: var(--clr-text-secondary);
    border-radius: 50%;
    font-size: 0.8rem;
    line-height: 1;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
  }
  .person-search-clear--visible { display: flex; }
  .person-search-clear:hover { background: var(--clr-text-tertiary); color: var(--clr-surface); }

  [data-theme="dark"] .person-search { background: #1a1714; border-color: var(--clr-border); color: var(--clr-text); }
  [data-theme="dark"] .person-search-clear { background: var(--clr-border); color: var(--clr-text-secondary); }
  [data-theme="dark"] .person-search-clear:hover { background: var(--clr-text-tertiary); color: var(--clr-surface); }

  /* Association Filter */
  .assoc-filter-wrap { position: relative; display: inline-flex; }

  .assoc-filter-btn {
    width: 34px;
    height: 34px;
    border: 1px solid var(--clr-border);
    border-radius: 8px;
    background: var(--clr-surface);
    color: var(--clr-text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transition: border-color 0.2s, color 0.2s;
  }
  .assoc-filter-btn:hover { border-color: var(--clr-text-tertiary); color: var(--clr-text); }

  .assoc-filter-btn--active {
    border-color: var(--clr-activity);
    color: var(--clr-activity);
    background: var(--clr-activity-bg);
  }
  .assoc-filter-btn--active:hover { border-color: var(--clr-activity); }

  .assoc-filter-btn__badge {
    position: absolute;
    top: 4px;
    left: 4px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--clr-activity);
    display: none;
  }
  .assoc-filter-btn--active .assoc-filter-btn__badge { display: block; }

  .assoc-filter-popover {
    position: absolute;
    top: calc(100% + 6px);
    left: 0;
    min-width: 220px;
    background: var(--clr-surface);
    border: 1px solid var(--clr-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-md);
    z-index: 80;
    display: none;
    padding: 0.5rem 0;
    max-height: 320px;
    overflow-y: auto;
  }
  .assoc-filter-popover--open { display: block; }

  .assoc-filter-popover__header {
    display: flex;
    justify-content: space-between;
    padding: 0.35rem 0.75rem;
    font-size: 0.78rem;
    border-bottom: 1px solid var(--clr-border);
    margin-bottom: 0.25rem;
  }
  .assoc-filter-popover__header a {
    color: var(--clr-text-tertiary);
    text-decoration: none;
    cursor: pointer;
  }
  .assoc-filter-popover__header a:hover { color: var(--clr-text); text-decoration: underline; }

  .assoc-filter-popover__item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.35rem 0.75rem;
    font-size: 0.88rem;
    cursor: pointer;
    transition: background 0.15s;
  }
  .assoc-filter-popover__item:hover { background: var(--clr-activity-bg); }
  .assoc-filter-popover__item input[type="checkbox"] { accent-color: var(--clr-activity); cursor: pointer; }

  .assoc-filter-popover__footer {
    display: flex;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem 0.25rem;
    border-top: 1px solid var(--clr-border);
    margin-top: 0.25rem;
  }
  .assoc-filter-popover__footer button {
    flex: 1;
    padding: 0.35rem 0.5rem;
    font-size: 0.82rem;
    font-family: var(--font-body);
    border-radius: 6px;
    border: 1px solid var(--clr-border);
    cursor: pointer;
    transition: background 0.15s;
  }
  .assoc-filter-popover__btn-apply {
    background: var(--clr-activity);
    color: #fff;
    border-color: var(--clr-activity) !important;
  }
  .assoc-filter-popover__btn-apply:hover { opacity: 0.9; }
  .assoc-filter-popover__btn-reset {
    background: var(--clr-surface);
    color: var(--clr-text-secondary);
  }
  .assoc-filter-popover__btn-reset:hover { background: var(--clr-bg); }

  [data-theme="dark"] .assoc-filter-btn { background: #2a2520; border-color: #3d362c; color: #a89e92; }
  [data-theme="dark"] .assoc-filter-btn:hover { border-color: #5a5040; color: var(--clr-text); }
  [data-theme="dark"] .assoc-filter-btn--active { background: #1a2e1a; border-color: var(--clr-activity); color: #4ade80; }
  [data-theme="dark"] .assoc-filter-popover { background: var(--clr-surface); border-color: #3d362c; }
  [data-theme="dark"] .assoc-filter-popover__header { border-color: #3d362c; }
  [data-theme="dark"] .assoc-filter-popover__item:hover { background: #1a2e1a; }
  [data-theme="dark"] .assoc-filter-popover__footer { border-color: #3d362c; }
  [data-theme="dark"] .assoc-filter-popover__btn-reset { background: #2a2520; color: #a89e92; border-color: #3d362c; }
  [data-theme="dark"] .assoc-filter-popover__btn-reset:hover { background: #332e27; }

  /* Legend */
  .legend {
    display: flex;
    align-items: center;
    gap: 1.25rem;
    flex-wrap: wrap;
  }

  .legend__item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.85rem;
    font-weight: 400;
    color: var(--clr-text-secondary);
  }

  .legend__dot {
    width: 12px;
    height: 12px;
    border-radius: 3px;
    flex-shrink: 0;
  }

  .legend__dot--activity { background: var(--clr-activity); }
  .legend__dot--home { background: var(--clr-home); }
  .legend__dot--switch { background: linear-gradient(135deg, var(--clr-activity) 50%, var(--clr-home) 50%); }
  .legend__dot--shabbat { background: var(--clr-shabbat); border: 1px solid var(--clr-shabbat-border); }
  .legend__dot--shavuot { background: var(--clr-shavuot); border: 1px solid var(--clr-shavuot-border); }

  /* Stats bar */
  .stats-bar {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    padding: 0.6rem 1rem;
    background: var(--clr-surface);
    border: 1px solid var(--clr-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    font-size: 0.88rem;
    color: var(--clr-text-secondary);
    cursor: pointer;
    transition: border-color 0.2s;
    animation: fadeInUp 0.6s ease-out 0.22s both;
    flex-wrap: wrap;
  }

  .stats-bar:hover {
    border-color: #d97706;
  }

  .stats-bar__title {
    font-weight: 700;
    color: var(--clr-text);
    display: flex;
    align-items: center;
    gap: 0.35rem;
  }

  .stats-bar__chip {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.2rem 0.6rem;
    border-radius: 6px;
    font-weight: 500;
    font-size: 0.82rem;
  }

  .stats-bar__chip--activity {
    background: var(--clr-activity-bg);
    color: #15803d;
  }

  .stats-bar__chip--home {
    background: var(--clr-home-bg);
    color: #1d4ed8;
  }

  .stats-bar__chip--switch {
    background: #f3f0ff;
    color: var(--clr-text-secondary);
  }

  .stats-bar__dot {
    width: 8px;
    height: 8px;
    border-radius: 2px;
    flex-shrink: 0;
  }

  .stats-bar__dot--activity { background: var(--clr-activity); }
  .stats-bar__dot--home { background: var(--clr-home); }
  .stats-bar__dot--switch { background: linear-gradient(135deg, var(--clr-activity) 50%, var(--clr-home) 50%); }

  /* Person stats bar */
  .person-stats {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding: 0.6rem 1rem;
    background: var(--clr-surface);
    border: 1px solid var(--clr-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    font-size: 0.85rem;
    color: var(--clr-text-secondary);
    animation: fadeInUp 0.4s ease-out both;
    flex-wrap: wrap;
  }

  .person-stats__name {
    font-weight: 700;
    color: var(--clr-text);
    margin-inline-end: 0.25rem;
  }

  .person-stats__item {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    font-weight: 500;
  }

  .person-stats__item--activity { color: #15803d; }
  .person-stats__item--home { color: #1d4ed8; }
  .person-stats__item--switch { color: var(--clr-text-secondary); }

  [data-theme="dark"] .person-stats__item--activity { color: #4ade80; }
  [data-theme="dark"] .person-stats__item--home { color: #60a5fa; }

  .person-stats__bar {
    flex: 1;
    min-width: 80px;
    max-width: 200px;
    height: 6px;
    border-radius: 3px;
    background: var(--clr-border);
    overflow: hidden;
    display: flex;
  }

  .person-stats__bar-seg {
    height: 100%;
    transition: width 0.3s ease-out;
  }

  .person-stats__bar-seg--activity { background: var(--clr-activity); }
  .person-stats__bar-seg--home { background: var(--clr-home); }
  .person-stats__bar-seg--switch { background: #9ca3af; }

  .person-stats__sep {
    color: var(--clr-border);
  }

  /* Week Jump Bar */
  .week-jump-bar {
    display: flex;
    gap: 0.4rem;
    padding: 0.5rem 0.75rem;
    background: var(--clr-surface);
    border: 1px solid var(--clr-border);
    border-radius: var(--radius);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  .week-jump-bar::-webkit-scrollbar { display: none; }

  .week-pill {
    flex-shrink: 0;
    padding: 0.3rem 0.7rem;
    font-size: 0.78rem;
    font-family: var(--font-body);
    font-weight: 500;
    border: 1.5px solid var(--clr-border);
    border-radius: 16px;
    background: var(--clr-bg);
    color: var(--clr-text-secondary);
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s, color 0.2s;
    white-space: nowrap;
  }
  .week-pill:hover { border-color: #c4b8aa; background: #f5f1ec; color: var(--clr-text); }
  .week-pill--active { border-color: var(--clr-activity); background: var(--clr-activity-bg); color: var(--clr-activity); font-weight: 700; }
  .week-pill--has-today { border-color: #f59e0b; background: #fef3c7; color: #92400e; }

  [data-theme="dark"] .week-jump-bar { background: var(--clr-surface); border-color: var(--clr-border); }
  [data-theme="dark"] .week-pill { background: #1e1b16; border-color: var(--clr-border); color: var(--clr-text-secondary); }
  [data-theme="dark"] .week-pill:hover { border-color: #5a5040; background: #332e27; color: var(--clr-text); }
  [data-theme="dark"] .week-pill--active { border-color: var(--clr-activity); background: #1a2e1a; color: #4ade80; }
  [data-theme="dark"] .week-pill--has-today { border-color: #a07208; background: #332a12; color: #f0c050; }

  @media (max-width: 480px) {
    .stats-bar { font-size: 0.78rem; gap: 0.5rem; padding: 0.5rem 0.75rem; }
    .stats-bar__chip { font-size: 0.72rem; padding: 0.15rem 0.4rem; }
    .person-stats { font-size: 0.78rem; gap: 0.5rem; padding: 0.5rem 0.75rem; }
  }

  /* Calendar container transition */
  #calendarContainer {
    transition: opacity 0.15s ease-out;
  }

  #calendarContainer.fading {
    opacity: 0;
  }

  /* Calendar wrapper */
  .calendar-wrap {
    background: var(--clr-surface);
    border-radius: var(--radius);
    box-shadow: var(--shadow-md);
    overflow: visible;
    border: 1px solid var(--clr-border);
    animation: fadeInUp 0.6s ease-out 0.3s both;
  }

  .cal-headers {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
  }

  .cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
  }

  .cal-headers {
    position: sticky;
    top: 0;
    z-index: 10;
    transition: box-shadow 0.2s;
  }

  /* Day headers */
  .cal-header {
    padding: 0.75rem 0.5rem;
    text-align: center;
    font-weight: 700;
    font-size: 0.85rem;
    color: var(--clr-text-secondary);
    background: #f5f1ec;
    border-bottom: 1.5px solid var(--clr-border);
    user-select: none;
  }

  .cal-header--shabbat {
    color: var(--clr-shabbat-text);
    background: #ebe4f3;
  }

  /* Day cell */
  .cal-cell {
    min-height: 90px;
    padding: 0.5rem;
    border-bottom: 1px solid var(--clr-border);
    border-inline-start: 1px solid var(--clr-border);
    position: relative;
    transition: background 0.2s;
    display: flex;
    flex-direction: column;
  }

  .cal-grid > :nth-child(7n + 1) {
    border-inline-start: none;
  }

  .cal-cell--empty {
    background: #fdfcfa;
  }

  .cal-cell--shabbat {
    background: var(--clr-shabbat);
  }

  .cal-cell--shavuot {
    background: var(--clr-shavuot);
    box-shadow: inset 0 0 0 1.5px var(--clr-shavuot-border);
  }

  .cal-cell--shavuot.cal-cell--shabbat {
    background: linear-gradient(135deg, var(--clr-shavuot) 60%, var(--clr-shabbat) 100%);
  }

  .cal-cell--status-activity {
    background: var(--clr-activity-bg);
  }

  .cal-cell--status-home {
    background: var(--clr-home-bg);
  }

  .cal-cell--status-activity .cell-greg {
    color: #15803d;
  }

  .cal-cell--status-home .cell-greg {
    color: #1d4ed8;
  }

  .cal-cell--status-activity .cell-status-label {
    color: #15803d;
    font-weight: 500;
    font-size: 0.75rem;
  }

  .cal-cell--status-home .cell-status-label {
    color: #1d4ed8;
    font-weight: 500;
    font-size: 0.75rem;
  }

  .cal-cell--status-switch-home {
    background: linear-gradient(135deg, var(--clr-home-bg) 50%, var(--clr-activity-bg) 50%);
  }

  .cal-cell--status-switch-base {
    background: linear-gradient(135deg, var(--clr-activity-bg) 50%, var(--clr-home-bg) 50%);
  }

  .cal-cell--status-switch-home .cell-greg,
  .cal-cell--status-switch-base .cell-greg {
    color: var(--clr-text);
  }

  .cal-cell--status-switch-home .cell-status-label,
  .cal-cell--status-switch-base .cell-status-label {
    color: var(--clr-text-secondary);
    font-weight: 500;
    font-size: 0.75rem;
  }

  .cal-cell--shabbat.cal-cell--status-activity {
    background: linear-gradient(135deg, var(--clr-activity-bg) 70%, var(--clr-shabbat) 100%);
  }

  .cal-cell--shabbat.cal-cell--status-home {
    background: linear-gradient(135deg, var(--clr-home-bg) 70%, var(--clr-shabbat) 100%);
  }

  .cal-cell--shabbat.cal-cell--status-switch-home {
    background: linear-gradient(135deg, var(--clr-home-bg) 40%, var(--clr-activity-bg) 40%, var(--clr-activity-bg) 60%, var(--clr-shabbat) 100%);
  }

  .cal-cell--shabbat.cal-cell--status-switch-base {
    background: linear-gradient(135deg, var(--clr-activity-bg) 40%, var(--clr-home-bg) 40%, var(--clr-home-bg) 60%, var(--clr-shabbat) 100%);
  }

  .cal-cell--today {
    outline: 2.5px solid #d97706;
    outline-offset: -2.5px;
    z-index: 2;
  }

  .cal-cell--today .cell-greg {
    background: #d97706;
    color: #fff;
    border-radius: 5px;
    padding: 0 5px;
    display: inline-block;
  }

  .cal-cell:not(.cal-cell--empty):hover {
    filter: brightness(0.97);
  }

  /* Today floating button */
  .today-fab {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: 999;
    height: 40px;
    border-radius: 20px;
    border: none;
    background: #d97706;
    color: #fff;
    font-family: var(--font-body);
    font-size: 0.85rem;
    font-weight: 600;
    padding: 0 1rem;
    cursor: pointer;
    box-shadow: 0 4px 14px rgba(217,119,6,0.35);
    display: flex;
    align-items: center;
    gap: 0.35rem;
    transition: transform 0.2s, box-shadow 0.2s;
    touch-action: manipulation;
  }

  .today-fab:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(217,119,6,0.45);
  }

  .today-fab:active {
    transform: scale(0.96);
  }

  /* Dark mode toggle */
  .theme-toggle {
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 999;
    width: 38px;
    height: 38px;
    border-radius: 50%;
    border: 1.5px solid var(--clr-border);
    background: var(--clr-surface);
    color: var(--clr-text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: border-color 0.2s, background 0.2s, transform 0.2s;
    box-shadow: var(--shadow-sm);
    touch-action: manipulation;
  }

  .theme-toggle:hover {
    border-color: #c4b8aa;
    transform: scale(1.08);
  }

  .theme-toggle:active {
    transform: scale(0.95);
  }

  .theme-toggle svg {
    width: 18px;
    height: 18px;
    transition: transform 0.3s;
  }

  [data-theme="dark"] .theme-toggle svg {
    transform: rotate(180deg);
  }

  /* Month indicator inside cell */
  .cell-month-tag {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 0.7rem;
    color: var(--clr-text-tertiary);
    margin-bottom: 0.15rem;
  }

  /* Date info inside cell */
  .cell-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.25rem;
  }

  .cell-greg {
    font-weight: 700;
    font-size: 1rem;
    line-height: 1.2;
    color: var(--clr-text);
  }

  .cell-holiday {
    font-weight: 700;
    font-size: 0.7rem;
    color: var(--clr-shavuot-text);
    background: rgba(245,158,11,0.18);
    padding: 1px 5px;
    border-radius: 4px;
    display: inline-block;
    margin-bottom: 0.2rem;
    line-height: 1.4;
  }

  .cell-note {
    font-size: 0.65rem;
    color: #92400e;
    background: #fef9c3;
    padding: 1px 5px;
    border-radius: 4px;
    display: inline-block;
    margin-top: 0.15rem;
    line-height: 1.4;
    border: 1px solid #fde68a;
  }

  .cell-note::before {
    content: 'üìù ';
  }

  .cell-special {
    font-weight: 700;
    font-size: 0.7rem;
    color: #7f1d1d;
    background: rgba(239,68,68,0.12);
    padding: 1px 5px;
    border-radius: 4px;
    display: inline-block;
    margin-bottom: 0.2rem;
    line-height: 1.4;
  }

  /* Status display */
  .cell-status {
    margin-top: auto;
  }

  .status-summary {
    font-size: 0.7rem;
    line-height: 1.5;
    color: var(--clr-text-secondary);
  }

  .summary-row {
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }

  .summary-dot {
    width: 7px;
    height: 7px;
    border-radius: 2px;
    flex-shrink: 0;
  }

  .summary-dot--activity { background: var(--clr-activity); }
  .summary-dot--home { background: var(--clr-home); }
  .summary-dot--switch { background: linear-gradient(135deg, var(--clr-activity) 50%, var(--clr-home) 50%); }

  /* Loading skeleton */
  .loading {
    text-align: center;
    padding: 1rem 0 2rem;
    color: var(--clr-text-secondary);
    font-size: 0.9rem;
  }

  .loading__text {
    margin-top: 0.75rem;
    font-weight: 400;
  }

  .skeleton-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0;
    border: 1px solid var(--clr-border);
    border-radius: var(--radius);
    overflow: hidden;
    background: var(--clr-surface);
  }

  .skeleton-header {
    padding: 0.75rem 0.5rem;
    background: #f5f1ec;
    border-bottom: 1.5px solid var(--clr-border);
  }

  .skeleton-header__bar {
    height: 12px;
    width: 60%;
    margin: 0 auto;
    background: #e8e2da;
    border-radius: 4px;
  }

  .skeleton-cell {
    min-height: 80px;
    padding: 0.5rem;
    border-bottom: 1px solid var(--clr-border);
    border-inline-start: 1px solid var(--clr-border);
    position: relative;
    overflow: hidden;
  }

  .skeleton-cell:nth-child(7n + 1) {
    border-inline-start: none;
  }

  .skeleton-cell__date {
    height: 14px;
    width: 30px;
    background: #ede8e1;
    border-radius: 4px;
    margin-bottom: 0.5rem;
  }

  .skeleton-cell__line {
    height: 9px;
    width: 70%;
    background: #f0ece7;
    border-radius: 3px;
    margin-bottom: 0.3rem;
  }

  .skeleton-cell__line:last-child {
    width: 45%;
  }

  .skeleton-cell::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
    animation: shimmer 1.5s infinite;
  }

  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  /* Animations */
  @keyframes fadeInDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .app { padding: 1rem 0.5rem 3rem; }
    .controls { flex-direction: column; align-items: stretch; }
    .legend { justify-content: center; }
    .filter-group { justify-content: center; }
    .cal-cell { min-height: 70px; padding: 0.35rem; }
    .cell-greg { font-size: 0.85rem; }
    .status-summary { font-size: 0.6rem; }
    .toolbar { justify-content: center; }
    .save-bar { justify-content: center; font-size: 0.8rem; }
    .save-bar__btn { font-size: 0.75rem; padding: 0.35rem 0.6rem; }
    .status-picker { min-width: 120px; }
    .note-popup, .add-people-modal { max-width: 95vw; }
  }

  @media (max-width: 480px) {
    .cal-cell { min-height: 58px; padding: 0.25rem; }
    .cell-greg { font-size: 0.78rem; }
    .cal-header { font-size: 0.72rem; padding: 0.5rem 0.25rem; }
    .cell-holiday { font-size: 0.6rem; }
    .toolbar__btn { font-size: 0.78rem; padding: 0.4rem 0.75rem; }
  }

  /* Day detail modal */
  .day-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(26,22,18,0.45);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease-out;
    padding: 1rem;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .day-modal {
    background: var(--clr-surface);
    border-radius: var(--radius);
    box-shadow: 0 12px 40px rgba(26,22,18,0.2);
    max-width: 400px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    animation: fadeInUp 0.25s ease-out;
  }

  .day-modal__header {
    padding: 1.25rem 1.5rem 1rem;
    border-bottom: 1px solid var(--clr-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .day-modal__title {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 1.2rem;
    color: var(--clr-text);
  }

  .day-modal__close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--clr-text-tertiary);
    cursor: pointer;
    padding: 0.25rem;
    line-height: 1;
    border-radius: 4px;
    transition: background 0.15s, color 0.15s;
  }

  .day-modal__close:hover {
    background: #f0ece7;
    color: var(--clr-text);
  }

  .day-modal__body {
    padding: 1rem 1.5rem 1.5rem;
  }

  .day-modal__group {
    margin-bottom: 1rem;
  }

  .day-modal__group:last-child {
    margin-bottom: 0;
  }

  .day-modal__group-title {
    font-weight: 700;
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .day-modal__group-title--activity {
    color: #15803d;
  }

  .day-modal__group-title--home {
    color: #1d4ed8;
  }

  .day-modal__group-title--switch {
    color: var(--clr-text-secondary);
  }

  .day-modal__list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }

  .day-modal__person {
    font-size: 0.9rem;
    color: var(--clr-text);
    padding: 0.35rem 0.6rem;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .day-modal__person--activity {
    background: var(--clr-activity-bg);
  }

  .day-modal__person--home {
    background: var(--clr-home-bg);
  }

  .day-modal__person--switch {
    background: linear-gradient(135deg, #f0fdf4 50%, #eff6ff 50%);
  }

  .day-modal__person-note {
    font-size: 0.7rem;
    color: #92400e;
    background: #fef9c3;
    padding: 1px 5px;
    border-radius: 4px;
    border: 1px solid #fde68a;
  }

  .cal-cell--clickable {
    cursor: pointer;
  }

  .cal-cell--clickable:hover {
    outline: 2px solid var(--clr-activity);
    outline-offset: -2px;
    z-index: 1;
  }

  /* Examples floating button & popup */
  .examples-fab {
    position: fixed;
    bottom: 1.5rem;
    left: 1.5rem;
    z-index: 1000;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: none;
    background: linear-gradient(135deg, #229ED9, #1a8ac4);
    color: #fff;
    font-size: 1.35rem;
    cursor: pointer;
    box-shadow: 0 4px 16px rgba(34,158,217,0.35);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, box-shadow 0.2s;
    line-height: 1;
  }

  .examples-fab:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 24px rgba(34,158,217,0.45);
  }

  .examples-fab:active {
    transform: scale(0.95);
  }

  .examples-fab svg {
    width: 24px;
    height: 24px;
    fill: #fff;
  }

  .examples-overlay {
    position: fixed;
    inset: 0;
    z-index: 1001;
    background: rgba(26,22,18,0.4);
    backdrop-filter: blur(4px);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.25s, visibility 0.25s;
  }

  .examples-overlay--open {
    opacity: 1;
    visibility: visible;
  }

  .examples-panel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1002;
    max-height: 80vh;
    background: var(--clr-surface);
    border-radius: var(--radius) var(--radius) 0 0;
    box-shadow: 0 -8px 40px rgba(26,22,18,0.15);
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .examples-panel--open {
    transform: translateY(0);
  }

  .examples-panel__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--clr-border);
    flex-shrink: 0;
  }

  .examples-panel__title {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 1.2rem;
    color: var(--clr-text);
  }

  .examples-panel__close {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    background: transparent;
    color: var(--clr-text-secondary);
    font-size: 1.3rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s;
    line-height: 1;
  }

  .examples-panel__close:hover {
    background: #f0ebe5;
  }

  .examples-panel__body {
    overflow-y: auto;
    padding: 0.75rem 1.25rem 1.5rem;
    flex: 1;
  }

  .example-item {
    margin-bottom: 0.75rem;
  }

  .example-item__label {
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--clr-text-tertiary);
    margin-bottom: 0.3rem;
  }

  .example-item__row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: #f5f1ec;
    border: 1px solid var(--clr-border);
    border-radius: 8px;
    padding: 0.55rem 0.75rem;
    transition: border-color 0.15s;
  }

  .example-item__row:hover {
    border-color: #c4b8aa;
  }

  .example-item__text {
    flex: 1;
    font-family: var(--font-body);
    font-size: 0.88rem;
    color: var(--clr-text);
    direction: rtl;
    word-break: break-word;
    line-height: 1.5;
  }

  .example-item__copy {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: none;
    background: transparent;
    color: var(--clr-text-tertiary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s, color 0.15s;
    position: relative;
  }

  .example-item__copy:hover {
    background: var(--clr-surface);
    color: var(--clr-text);
  }

  .example-item__copy svg {
    width: 16px;
    height: 16px;
  }

  .example-item__copy--copied {
    color: var(--clr-activity) !important;
  }

  .example-item__feedback {
    position: absolute;
    top: -1.6rem;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.7rem;
    font-weight: 500;
    color: var(--clr-activity);
    background: #dcfce7;
    padding: 2px 8px;
    border-radius: 4px;
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.2s;
    pointer-events: none;
  }

  .example-item__feedback--show {
    opacity: 1;
  }

  /* Toolbar */
  .toolbar {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .toolbar__modes {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .toolbar__btn {
    font-family: var(--font-body);
    font-size: 0.85rem;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: var(--radius);
    border: 1.5px solid var(--clr-border);
    background: var(--clr-surface);
    color: var(--clr-text);
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: var(--shadow-sm);
    white-space: nowrap;
    touch-action: manipulation;
  }

  .toolbar__btn:hover {
    border-color: #c4b8aa;
    background: #f5f1ec;
  }

  .toolbar__btn--active {
    border-color: var(--clr-activity);
    background: var(--clr-activity-bg);
    color: #15803d;
    box-shadow: 0 0 0 3px rgba(22,163,74,0.12);
  }

  .toolbar__btn--cancel {
    border-color: #ef4444;
    color: #dc2626;
  }

  .toolbar__btn--cancel:hover {
    background: #fef2f2;
  }

  .toolbar__btn--add-people {
    border-color: var(--clr-home);
    color: var(--clr-home);
  }

  .toolbar__btn--add-people:hover {
    background: var(--clr-home-bg);
  }

  /* Save/discard bar */
  .save-bar {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.6rem 1rem;
    background: #fef9c3;
    border: 1.5px solid #fde68a;
    border-radius: var(--radius);
    flex-wrap: wrap;
    animation: fadeInUp 0.2s ease-out;
    margin-bottom: 1rem;
  }

  .save-bar__count {
    font-size: 0.85rem;
    font-weight: 500;
    color: #92400e;
  }

  .save-bar__btn {
    font-family: var(--font-body);
    font-size: 0.8rem;
    font-weight: 500;
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    touch-action: manipulation;
  }

  .save-bar__btn--save {
    background: var(--clr-activity);
    color: #fff;
  }

  .save-bar__btn--save:hover { background: #15803d; }

  .save-bar__btn--discard {
    background: #fee2e2;
    color: #dc2626;
  }

  .save-bar__btn--discard:hover { background: #fecaca; }

  .save-bar__btn--undo {
    background: #e0e7ff;
    color: #3730a3;
  }

  .save-bar__btn--undo:hover { background: #c7d2fe; }

  /* Toast */
  .toast-container {
    position: fixed;
    top: 1.5rem;
    left: 50%;
    transform: translateX(-50%);
    z-index: 2000;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    pointer-events: none;
  }

  .toast {
    background: var(--clr-text);
    color: #fff;
    padding: 0.75rem 1.25rem;
    border-radius: var(--radius);
    font-family: var(--font-body);
    font-size: 0.9rem;
    font-weight: 500;
    box-shadow: 0 8px 32px rgba(26,22,18,0.25);
    animation: toastIn 0.3s ease-out;
    pointer-events: auto;
    text-align: center;
    max-width: 90vw;
  }

  .toast--success { background: #15803d; }
  .toast--error { background: #dc2626; }
  .toast--info { background: #2563eb; }

  @keyframes toastIn {
    from { opacity: 0; transform: translateY(-12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes toastOut {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-12px); }
  }

  /* Note popup */
  .note-popup-overlay {
    position: fixed;
    inset: 0;
    background: rgba(26,22,18,0.45);
    z-index: 150;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease-out;
    padding: 1rem;
  }

  .note-popup {
    background: var(--clr-surface);
    border-radius: var(--radius);
    box-shadow: 0 12px 40px rgba(26,22,18,0.2);
    max-width: 360px;
    width: 100%;
    animation: fadeInUp 0.25s ease-out;
    padding: 1.25rem 1.5rem;
  }

  .note-popup__title {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
    color: var(--clr-text);
  }

  .note-popup__input {
    width: 100%;
    font-family: var(--font-body);
    font-size: 0.95rem;
    padding: 0.6rem 0.75rem;
    border: 1.5px solid var(--clr-border);
    border-radius: 8px;
    direction: rtl;
    resize: vertical;
    min-height: 60px;
    transition: border-color 0.2s;
  }

  .note-popup__input:focus {
    outline: none;
    border-color: var(--clr-activity);
    box-shadow: 0 0 0 3px rgba(22,163,74,0.12);
  }

  .note-popup__actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
    justify-content: flex-start;
  }

  .note-popup__btn {
    font-family: var(--font-body);
    font-size: 0.85rem;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
  }

  .note-popup__btn--save {
    background: var(--clr-activity);
    color: #fff;
  }

  .note-popup__btn--save:hover { background: #15803d; }

  .note-popup__btn--cancel {
    background: #f5f1ec;
    color: var(--clr-text-secondary);
    border: 1px solid var(--clr-border);
  }

  .note-popup__btn--cancel:hover { background: #ede8e1; }

  .note-popup__btn--delete {
    background: #fef2f2;
    color: #dc2626;
    border: 1px solid #fecaca;
    margin-inline-start: auto;
  }

  .note-popup__btn--delete:hover { background: #fee2e2; }

  /* Status picker */
  .status-picker {
    position: fixed;
    z-index: 200;
    background: var(--clr-surface);
    border-radius: var(--radius);
    box-shadow: 0 8px 32px rgba(26,22,18,0.18);
    border: 1px solid var(--clr-border);
    padding: 0.5rem;
    min-width: 140px;
    animation: fadeInUp 0.15s ease-out;
  }

  .status-picker__option {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: background 0.15s;
    border: none;
    background: none;
    width: 100%;
    text-align: right;
    font-family: var(--font-body);
    color: var(--clr-text);
    touch-action: manipulation;
  }

  .status-picker__option:hover { background: #f5f1ec; }

  .status-picker__option--active { background: var(--clr-activity-bg); }

  .status-picker__dot {
    width: 10px;
    height: 10px;
    border-radius: 3px;
    flex-shrink: 0;
  }

  .cal-cell--pending {
    outline: 2px dashed var(--clr-activity);
    outline-offset: -2px;
  }

  .cal-cell--drag-highlight {
    outline: 2px solid #f59e0b;
    outline-offset: -2px;
    filter: brightness(0.95);
  }

  .cal-cell--editable {
    cursor: pointer;
    touch-action: manipulation;
  }

  .cal-cell--focused {
    outline: 2.5px solid #8b5cf6;
    outline-offset: -2px;
    z-index: 2;
  }
  [data-theme="dark"] .cal-cell--focused {
    outline-color: #a78bfa;
  }

  /* Add People modal */
  .add-people-overlay {
    position: fixed;
    inset: 0;
    background: rgba(26,22,18,0.45);
    z-index: 150;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease-out;
    padding: 1rem;
  }

  .add-people-modal {
    background: var(--clr-surface);
    border-radius: var(--radius);
    box-shadow: 0 12px 40px rgba(26,22,18,0.2);
    max-width: 400px;
    width: 100%;
    animation: fadeInUp 0.25s ease-out;
    padding: 1.25rem 1.5rem;
  }

  .add-people-modal__title {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
    color: var(--clr-text);
  }

  .add-people-modal__desc {
    font-size: 0.85rem;
    color: var(--clr-text-secondary);
    margin-bottom: 0.75rem;
  }

  .add-people-modal__input {
    width: 100%;
    font-family: var(--font-body);
    font-size: 0.95rem;
    padding: 0.6rem 0.75rem;
    border: 1.5px solid var(--clr-border);
    border-radius: 8px;
    direction: rtl;
    resize: vertical;
    min-height: 80px;
    transition: border-color 0.2s;
  }

  .add-people-modal__input:focus {
    outline: none;
    border-color: var(--clr-home);
    box-shadow: 0 0 0 3px rgba(37,99,235,0.12);
  }

  .add-people-modal__warning {
    font-size: 0.8rem;
    color: #dc2626;
    margin-top: 0.5rem;
  }

  .add-people-modal__actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
    justify-content: flex-start;
  }

  .add-people-modal__btn {
    font-family: var(--font-body);
    font-size: 0.85rem;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    touch-action: manipulation;
  }

  .add-people-modal__btn--add {
    background: var(--clr-home);
    color: #fff;
  }

  .add-people-modal__btn--add:hover { background: #1d4ed8; }

  .add-people-modal__btn--cancel {
    background: #f5f1ec;
    color: var(--clr-text-secondary);
    border: 1px solid var(--clr-border);
  }

  .add-people-modal__btn--cancel:hover { background: #ede8e1; }

  .add-people-modal__field { margin-bottom: 0.75rem; }
  .add-people-modal__field-label {
    display: block;
    font-size: 0.82rem;
    font-weight: 500;
    color: var(--clr-text-secondary);
    margin-bottom: 0.3rem;
  }
  .add-people-modal__select {
    width: 100%;
    padding: 0.5rem 0.75rem;
    font-size: 0.92rem;
    font-family: var(--font-body);
    border: 1px solid var(--clr-border);
    border-radius: 8px;
    background: var(--clr-surface);
    color: var(--clr-text);
    appearance: auto;
    cursor: pointer;
  }
  .add-people-modal__custom-input {
    width: 100%;
    padding: 0.5rem 0.75rem;
    font-size: 0.92rem;
    font-family: var(--font-body);
    border: 1px solid var(--clr-border);
    border-radius: 8px;
    background: var(--clr-surface);
    color: var(--clr-text);
    margin-top: 0.4rem;
    display: none;
  }
  .add-people-modal__custom-input--visible { display: block; }

  [data-theme="dark"] .add-people-modal__select { background: #1a1714; border-color: #3d362c; color: #e8e2da; }
  [data-theme="dark"] .add-people-modal__custom-input { background: #1a1714; border-color: #3d362c; color: #e8e2da; }

  /* Fairness Dashboard */
  .fairness-overlay {
    position: fixed;
    inset: 0;
    background: rgba(26,22,18,0.45);
    z-index: 150;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease-out;
    padding: 1rem;
  }

  .fairness-modal {
    background: var(--clr-surface);
    border-radius: var(--radius);
    box-shadow: 0 12px 40px rgba(26,22,18,0.2);
    max-width: 620px;
    width: 100%;
    max-height: 85vh;
    overflow-y: auto;
    animation: fadeInUp 0.25s ease-out;
  }

  .fairness-modal__header {
    padding: 1.25rem 1.5rem 1rem;
    border-bottom: 1px solid var(--clr-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    background: var(--clr-surface);
    z-index: 1;
  }

  .fairness-modal__title {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 1.2rem;
    color: var(--clr-text);
  }

  .fairness-modal__close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--clr-text-tertiary);
    cursor: pointer;
    padding: 0.25rem;
    line-height: 1;
    border-radius: 4px;
    transition: background 0.15s, color 0.15s;
  }

  .fairness-modal__close:hover { background: #f0ece7; color: var(--clr-text); }

  .fairness-modal__body { padding: 1rem 1.5rem 1.5rem; }

  .fairness-modal__table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }

  .fairness-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }

  .fairness-table th {
    text-align: right;
    font-weight: 700;
    color: var(--clr-text-secondary);
    padding: 0.5rem 0.5rem;
    border-bottom: 2px solid var(--clr-border);
    white-space: nowrap;
    font-size: 0.75rem;
  }

  .fairness-table td {
    padding: 0.45rem 0.5rem;
    border-bottom: 1px solid var(--clr-border);
    vertical-align: middle;
  }

  .fairness-table__row--commander { background: rgba(217,119,6,0.08); }

  .fairness-table__name { font-weight: 500; color: var(--clr-text); }
  .fairness-table__name--commander { font-weight: 700; }
  .fairness-table__name--commander::before { content: '‚≠ê '; }

  .fairness-table__bar-cell { width: 100px; }

  .fairness-table__bar {
    height: 7px;
    border-radius: 4px;
    background: var(--clr-border);
    overflow: hidden;
    display: flex;
  }

  .fairness-table__bar-seg { height: 100%; }
  .fairness-table__bar-seg--activity { background: var(--clr-activity); }
  .fairness-table__bar-seg--home { background: var(--clr-home); }
  .fairness-table__bar-seg--switch { background: #9ca3af; }

  .fairness-table__pct { font-weight: 600; text-align: center; width: 50px; }
  .fairness-table__pct--high { color: var(--clr-home); }
  .fairness-table__pct--low { color: var(--clr-activity); }

  .fairness-avg {
    margin-top: 1rem;
    padding: 0.6rem 1rem;
    background: rgba(37,99,235,0.06);
    border: 1px solid rgba(37,99,235,0.15);
    border-radius: 8px;
    font-size: 0.85rem;
    color: var(--clr-text-secondary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .fairness-avg__value { font-weight: 700; color: var(--clr-home); }

  [data-theme="dark"] .fairness-modal__close:hover { background: #3d362c; }
  [data-theme="dark"] .fairness-table__row--commander { background: rgba(217,119,6,0.12); }
  [data-theme="dark"] .fairness-table__pct--high { color: #60a5fa; }
  [data-theme="dark"] .fairness-table__pct--low { color: #4ade80; }
  [data-theme="dark"] .fairness-avg { background: rgba(96,165,250,0.08); border-color: rgba(96,165,250,0.2); }
  [data-theme="dark"] .fairness-avg__value { color: #60a5fa; }

  .toolbar__btn--fairness { border-color: #d97706; color: #92400e; }
  .toolbar__btn--fairness:hover { background: #fef3c7; }
  [data-theme="dark"] .toolbar__btn--fairness { border-color: #a07208; color: #f0c050; }
  [data-theme="dark"] .toolbar__btn--fairness:hover { background: #332a12; }

  /* Rotation Pattern Generator */
  .rotation-overlay {
    position: fixed;
    inset: 0;
    background: rgba(26,22,18,0.45);
    z-index: 150;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease-out;
    padding: 1rem;
  }

  .rotation-modal {
    background: var(--clr-surface);
    border-radius: var(--radius);
    box-shadow: 0 12px 40px rgba(26,22,18,0.2);
    max-width: 480px;
    width: 100%;
    max-height: 85vh;
    overflow-y: auto;
    animation: fadeInUp 0.25s ease-out;
  }

  .rotation-modal__header {
    padding: 1.25rem 1.5rem 1rem;
    border-bottom: 1px solid var(--clr-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .rotation-modal__title {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 1.15rem;
    color: var(--clr-text);
  }

  .rotation-modal__close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--clr-text-tertiary);
    cursor: pointer;
    padding: 0.25rem;
    line-height: 1;
    border-radius: 4px;
    transition: background 0.15s, color 0.15s;
  }

  .rotation-modal__close:hover { background: #f0ece7; color: var(--clr-text); }

  .rotation-modal__body { padding: 1rem 1.5rem 1.5rem; }

  .rotation-form { display: flex; flex-direction: column; gap: 1rem; }

  .rotation-form__field { display: flex; flex-direction: column; gap: 0.3rem; }

  .rotation-form__label { font-weight: 600; font-size: 0.85rem; color: var(--clr-text); }
  .rotation-form__hint { font-size: 0.72rem; color: var(--clr-text-tertiary); }

  .rotation-form__input {
    font-family: var(--font-body);
    font-size: 0.9rem;
    padding: 0.5rem 0.7rem;
    border: 1.5px solid var(--clr-border);
    border-radius: 8px;
    direction: rtl;
    background: var(--clr-surface);
    color: var(--clr-text);
    transition: border-color 0.2s;
  }

  .rotation-form__input:focus {
    outline: none;
    border-color: var(--clr-activity);
    box-shadow: 0 0 0 3px rgba(22,163,74,0.12);
  }

  .rotation-form__input[type="number"] { width: 80px; text-align: center; }
  .rotation-form__input[type="date"] { direction: ltr; }

  .rotation-form__row { display: flex; gap: 1rem; align-items: flex-end; }

  .rotation-form__actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; }

  .rotation-form__btn {
    font-family: var(--font-body);
    font-size: 0.85rem;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    touch-action: manipulation;
  }

  .rotation-form__btn--preview { background: var(--clr-home); color: #fff; }
  .rotation-form__btn--preview:hover { background: #1d4ed8; }
  .rotation-form__btn--apply { background: var(--clr-activity); color: #fff; }
  .rotation-form__btn--apply:hover { background: #15803d; }
  .rotation-form__btn--cancel { background: #f5f1ec; color: var(--clr-text-secondary); border: 1px solid var(--clr-border); }
  .rotation-form__btn--cancel:hover { background: #ede8e1; }
  .rotation-form__btn:disabled { opacity: 0.5; cursor: default; }

  .rotation-preview { margin-top: 1rem; border: 1px solid var(--clr-border); border-radius: 8px; overflow: hidden; }

  .rotation-preview__header {
    padding: 0.5rem 0.75rem;
    background: #f5f1ec;
    border-bottom: 1px solid var(--clr-border);
    font-weight: 600;
    font-size: 0.82rem;
    color: var(--clr-text-secondary);
    display: flex;
    justify-content: space-between;
  }

  .rotation-preview__count { font-weight: 500; color: var(--clr-text-tertiary); }

  .rotation-preview__list { max-height: 200px; overflow-y: auto; padding: 0.25rem; }

  .rotation-preview__item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.3rem 0.5rem;
    font-size: 0.8rem;
    border-radius: 4px;
  }

  .rotation-preview__item:nth-child(even) { background: rgba(0,0,0,0.02); }

  .rotation-preview__item-date { font-weight: 500; color: var(--clr-text); min-width: 42px; }

  .rotation-preview__item-dot {
    width: 8px;
    height: 8px;
    border-radius: 2px;
    flex-shrink: 0;
  }

  .rotation-preview__item-dot--activity { background: var(--clr-activity); }
  .rotation-preview__item-dot--home { background: var(--clr-home); }
  .rotation-preview__item-dot--switch { background: linear-gradient(135deg, var(--clr-activity) 50%, var(--clr-home) 50%); }

  .rotation-preview__item-label { color: var(--clr-text-secondary); }

  .toolbar__btn--rotation { border-color: #8b5cf6; color: #6d28d9; }
  .toolbar__btn--rotation:hover { background: #f3f0ff; }
  [data-theme="dark"] .toolbar__btn--rotation { border-color: #7c3aed; color: #a78bfa; }
  [data-theme="dark"] .toolbar__btn--rotation:hover { background: #2a2540; }

  [data-theme="dark"] .rotation-modal__close:hover { background: #3d362c; }
  [data-theme="dark"] .rotation-form__input { background: #1a1714; border-color: #3d362c; color: #e8e2da; }
  [data-theme="dark"] .rotation-form__btn--cancel { background: #2a2520; border-color: #3d362c; }
  [data-theme="dark"] .rotation-preview__header { background: #2a2520; }
  [data-theme="dark"] .rotation-preview__item:nth-child(even) { background: rgba(255,255,255,0.02); }

  /* Timeline / Gantt View */
  .view-toggle {
    display: flex;
    align-items: center;
    gap: 0;
    border: 1.5px solid var(--clr-border);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
  }

  .view-toggle__btn {
    font-family: var(--font-body);
    font-size: 0.82rem;
    font-weight: 500;
    padding: 0.5rem 0.85rem;
    border: none;
    background: var(--clr-surface);
    color: var(--clr-text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    touch-action: manipulation;
  }

  .view-toggle__btn:last-child { border-inline-start: 1px solid var(--clr-border); }
  .view-toggle__btn:hover { background: #f5f1ec; }

  .view-toggle__btn--active {
    background: var(--clr-activity-bg);
    color: #15803d;
    font-weight: 600;
  }

  [data-theme="dark"] .view-toggle { border-color: #3d362c; }
  [data-theme="dark"] .view-toggle__btn { background: #2a2520; color: #a89e92; }
  [data-theme="dark"] .view-toggle__btn:last-child { border-color: #3d362c; }
  [data-theme="dark"] .view-toggle__btn:hover { background: #332e27; }
  [data-theme="dark"] .view-toggle__btn--active { background: #1a2e1a; color: #4ade80; }

  .timeline-wrap {
    background: var(--clr-surface);
    border-radius: var(--radius);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--clr-border);
    overflow: hidden;
    animation: fadeInUp 0.4s ease-out both;
  }

  .timeline-scroll {
    overflow-x: auto;
    overflow-y: visible;
    -webkit-overflow-scrolling: touch;
  }

  .timeline-grid { display: grid; min-width: max-content; }

  .timeline-corner {
    position: sticky;
    right: 0;
    z-index: 12;
    background: var(--clr-surface);
    border-bottom: 2px solid var(--clr-border);
    border-inline-start: 2px solid var(--clr-border);
    padding: 0.4rem 0.6rem;
    font-weight: 700;
    font-size: 0.75rem;
    color: var(--clr-text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 90px;
  }

  .timeline-date-header {
    border-bottom: 2px solid var(--clr-border);
    border-inline-start: 1px solid var(--clr-border);
    padding: 0.2rem 0;
    text-align: center;
    font-size: 0.62rem;
    font-weight: 500;
    color: var(--clr-text-secondary);
    min-width: 22px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    line-height: 1.2;
    user-select: none;
  }

  .timeline-date-header--shabbat { background: var(--clr-shabbat); color: var(--clr-shabbat-text); }
  .timeline-date-header--shavuot { background: var(--clr-shavuot); color: var(--clr-shavuot-text); }
  .timeline-date-header--today { background: #d97706; color: #fff; font-weight: 700; }

  .timeline-date-header__day { font-size: 0.68rem; font-weight: 700; }
  .timeline-date-header__dow { font-size: 0.52rem; opacity: 0.7; }

  .timeline-name {
    position: sticky;
    right: 0;
    z-index: 11;
    background: var(--clr-surface);
    border-bottom: 1px solid var(--clr-border);
    border-inline-start: 2px solid var(--clr-border);
    padding: 0.2rem 0.6rem;
    font-size: 0.78rem;
    font-weight: 500;
    color: var(--clr-text);
    display: flex;
    align-items: center;
    white-space: nowrap;
    min-width: 90px;
    min-height: 28px;
  }

  .timeline-name--commander { font-weight: 700; }
  .timeline-name--commander::before { content: '‚≠ê '; font-size: 0.65rem; }

  .timeline-cell {
    border-bottom: 1px solid var(--clr-border);
    border-inline-start: 1px solid rgba(0,0,0,0.04);
    min-width: 22px;
    min-height: 28px;
    cursor: pointer;
    transition: filter 0.15s;
    position: relative;
  }

  .timeline-cell:hover { filter: brightness(0.9); z-index: 1; }

  .timeline-cell--activity { background: var(--clr-activity-bg); }
  .timeline-cell--home { background: var(--clr-home-bg); }
  .timeline-cell--switch-home { background: linear-gradient(135deg, var(--clr-home-bg) 50%, var(--clr-activity-bg) 50%); }
  .timeline-cell--switch-base { background: linear-gradient(135deg, var(--clr-activity-bg) 50%, var(--clr-home-bg) 50%); }
  .timeline-cell--shabbat { background: var(--clr-shabbat); }

  .timeline-cell__dot {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 5px;
    height: 5px;
    border-radius: 2px;
  }

  .timeline-cell__dot--activity { background: var(--clr-activity); }
  .timeline-cell__dot--home { background: var(--clr-home); }
  .timeline-cell__dot--switch { background: linear-gradient(135deg, var(--clr-activity) 50%, var(--clr-home) 50%); }

  .timeline-cell--today { box-shadow: inset 0 0 0 1.5px #d97706; }
  .timeline-cell--pending { outline: 1.5px dashed var(--clr-activity); outline-offset: -1.5px; }


  .timeline-tooltip {
    position: fixed;
    z-index: 300;
    background: var(--clr-text);
    color: #fff;
    font-family: var(--font-body);
    font-size: 0.78rem;
    padding: 0.35rem 0.65rem;
    border-radius: 6px;
    pointer-events: none;
    white-space: nowrap;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }

  [data-theme="dark"] .timeline-corner { background: #242019; }
  [data-theme="dark"] .timeline-name { background: #242019; }
  [data-theme="dark"] .timeline-cell { border-inline-start-color: rgba(255,255,255,0.04); }
  [data-theme="dark"] .timeline-date-header--shabbat { background: #2d2842; }
  [data-theme="dark"] .timeline-date-header--shavuot { background: #332a12; }

  @media (max-width: 768px) {
    .timeline-name, .timeline-corner { min-width: 75px; font-size: 0.7rem; }
    .timeline-cell { min-width: 18px; }
    .timeline-date-header { min-width: 18px; font-size: 0.55rem; }
    .view-toggle__btn { font-size: 0.75rem; padding: 0.4rem 0.65rem; }
  }

  @media (max-width: 480px) {
    .fairness-modal { max-width: 98vw; }
    .fairness-table { font-size: 0.72rem; }
    .fairness-table th, .fairness-table td { padding: 0.3rem 0.35rem; }
    .fairness-table__bar-cell { width: 70px; }
    .rotation-modal { max-width: 95vw; }
    .rotation-form__row { flex-direction: column; gap: 0.75rem; }
    .timeline-name, .timeline-corner { min-width: 60px; font-size: 0.62rem; }
    .timeline-cell { min-width: 15px; min-height: 22px; }
    .timeline-date-header { min-width: 15px; }
  }

  /* Print */
  @media print {
    body { background: #fff; }
    body::before { display: none; }
    .app { padding: 0; max-width: 100%; }
    .controls { break-inside: avoid; }
    .calendar-wrap { box-shadow: none; border: 1px solid #ccc; }
    .cal-cell { min-height: 60px; }
    .filter-select { border: 1px solid #999; box-shadow: none; }
    .examples-fab, .examples-overlay, .examples-panel { display: none; }
    .toolbar, .save-bar, .toast-container, #notePopup, #addPeopleModal, #fairnessModal, #rotationModal, .view-toggle, .timeline-tooltip, .week-jump-bar, .person-search { display: none; }
  }
</style>
</head>
<body>
<button class="theme-toggle" id="themeToggle" title="◊û◊¶◊ë ◊õ◊î◊î/◊ë◊î◊ô◊®" aria-label="◊î◊ó◊ú◊£ ◊¢◊®◊õ◊™ ◊†◊ï◊©◊ê">
  <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
  </svg>
</button>
<div class="app">
  <header class="header">
    <h1 class="header__title">◊û◊ó◊ú◊ß◊î 1</h1>
    <p class="header__subtitle">18.6.2026 ‚Äì 26.4.2026</p>
    <div class="header__line"></div>
    <div class="freshness-badge" id="freshnessBadge" style="display:none;" title="◊ú◊ó◊• ◊ú◊®◊¢◊†◊ü"></div>
    <a class="header__sheet-link" href="https://docs.google.com/spreadsheets/d/1AL55-KKFtd2jM2pAGwqZoacYm-kIcqFx-K-DOht-COA/edit" target="_blank" rel="noopener">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      ◊§◊™◊ó ◊í◊ô◊ú◊ô◊ï◊ü ◊†◊™◊ï◊†◊ô◊ù
    </a>
  </header>

  <div class="controls">
    <div class="filter-group">
      <label class="filter-group__label" for="personFilter">◊î◊¶◊í◊î ◊¢◊ë◊ï◊®:</label>
      <button class="filter-nav-btn" id="btnPrevPerson" title="◊î◊ß◊ï◊ì◊ù" style="display:none;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
      <div class="filter-group__search-wrap">
        <div style="position:relative;">
          <svg class="person-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" class="person-search" id="personSearch" placeholder="◊ó◊ô◊§◊ï◊© ◊©◊ù..." autocomplete="off">
          <button class="person-search-clear" id="personSearchClear" type="button">&times;</button>
        </div>
        <select class="filter-select" id="personFilter">
          <option value="__all__">◊õ◊ï◊ú◊ù</option>
        </select>
      </div>
      <button class="filter-nav-btn" id="btnNextPerson" title="◊î◊ë◊ê" style="display:none;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
      </button>
      <div class="assoc-filter-wrap" id="assocFilterWrap">
        <button class="assoc-filter-btn" id="btnAssocFilter" title="◊°◊†◊ü ◊ú◊§◊ô ◊©◊ô◊ï◊ö">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
          <span class="assoc-filter-btn__badge"></span>
        </button>
        <div class="assoc-filter-popover" id="assocFilterPopover"></div>
      </div>
    </div>
    <div class="view-toggle" id="viewToggle">
      <button class="view-toggle__btn view-toggle__btn--active" id="btnCalView">üìÖ ◊ú◊ï◊ó</button>
      <button class="view-toggle__btn" id="btnTimelineView">üìä ◊¶◊ô◊® ◊ñ◊û◊ü</button>
    </div>
    <div class="toolbar" id="toolbar">
      <div class="toolbar__modes" id="toolbarModes" style="display:none;">
        <button class="toolbar__btn" id="btnNote">üìù ◊î◊¢◊®◊î</button>
        <button class="toolbar__btn" id="btnEdit">‚úèÔ∏è ◊¢◊®◊ô◊õ◊î</button>
        <button class="toolbar__btn toolbar__btn--rotation" id="btnRotation">üîÑ ◊™◊ë◊†◊ô◊™</button>
        <button class="toolbar__btn toolbar__btn--cancel" id="btnCancel" style="display:none;">‚ùå ◊ë◊ô◊ò◊ï◊ú</button>
      </div>
      <button class="toolbar__btn toolbar__btn--add-people" id="btnAddPeople">‚ûï ◊î◊ï◊°◊£ ◊ê◊†◊©◊ô◊ù</button>
      <button class="toolbar__btn toolbar__btn--fairness" id="btnFairness">üìä ◊°◊ô◊õ◊ï◊ù</button>
    </div>
    <div class="legend">
      <span class="legend__item"><span class="legend__dot legend__dot--activity"></span>◊ë◊û◊ï◊¶◊ë</span>
      <span class="legend__item"><span class="legend__dot legend__dot--home"></span>◊ë◊ë◊ô◊™</span>
      <span class="legend__item"><span class="legend__dot legend__dot--switch"></span>◊û◊¢◊ë◊®</span>
      <span class="legend__item"><span class="legend__dot legend__dot--shabbat"></span>◊©◊ë◊™</span>
      <span class="legend__item"><span class="legend__dot legend__dot--shavuot"></span>◊©◊ë◊ï◊¢◊ï◊™</span>
    </div>
  </div>

  <div class="stats-bar" id="statsBar" style="display:none;" title="◊ú◊ó◊• ◊ú◊í◊ú◊ï◊ú ◊ú◊î◊ô◊ï◊ù"></div>
  <div class="person-stats" id="personStats" style="display:none;"></div>
  <div class="week-jump-bar" id="weekJumpBar" style="display:none;"></div>

  <div class="save-bar" id="saveBar" style="display:none;">
    <span class="save-bar__count" id="saveBarCount"></span>
    <button class="save-bar__btn save-bar__btn--save" id="btnSaveAll">üíæ ◊©◊û◊ï◊® ◊©◊ô◊†◊ï◊ô◊ô◊ù</button>
    <button class="save-bar__btn save-bar__btn--discard" id="btnDiscardAll">üóëÔ∏è ◊ë◊ò◊ú ◊î◊õ◊ú</button>
    <button class="save-bar__btn save-bar__btn--undo" id="btnUndo">‚Ü©Ô∏è ◊ë◊ò◊ú ◊ê◊ó◊®◊ï◊ü</button>
  </div>

  <div id="calendarContainer" style="padding-bottom:120px;">
    <div class="loading">
      <div class="skeleton-grid">
        <div class="skeleton-header"><div class="skeleton-header__bar"></div></div>
        <div class="skeleton-header"><div class="skeleton-header__bar"></div></div>
        <div class="skeleton-header"><div class="skeleton-header__bar"></div></div>
        <div class="skeleton-header"><div class="skeleton-header__bar"></div></div>
        <div class="skeleton-header"><div class="skeleton-header__bar"></div></div>
        <div class="skeleton-header"><div class="skeleton-header__bar"></div></div>
        <div class="skeleton-header"><div class="skeleton-header__bar"></div></div>
        <div class="skeleton-cell"><div class="skeleton-cell__date"></div><div class="skeleton-cell__line"></div><div class="skeleton-cell__line"></div></div>
        <div class="skeleton-cell"><div class="skeleton-cell__date"></div><div class="skeleton-cell__line"></div><div class="skeleton-cell__line"></div></div>
        <div class="skeleton-cell"><div class="skeleton-cell__date"></div><div class="skeleton-cell__line"></div><div class="skeleton-cell__line"></div></div>
        <div class="skeleton-cell"><div class="skeleton-cell__date"></div><div class="skeleton-cell__line"></div><div class="skeleton-cell__line"></div></div>
        <div class="skeleton-cell"><div class="skeleton-cell__date"></div><div class="skeleton-cell__line"></div><div class="skeleton-cell__line"></div></div>
        <div class="skeleton-cell"><div class="skeleton-cell__date"></div><div class="skeleton-cell__line"></div><div class="skeleton-cell__line"></div></div>
        <div class="skeleton-cell"><div class="skeleton-cell__date"></div><div class="skeleton-cell__line"></div><div class="skeleton-cell__line"></div></div>
        <div class="skeleton-cell"><div class="skeleton-cell__date"></div><div class="skeleton-cell__line"></div></div>
        <div class="skeleton-cell"><div class="skeleton-cell__date"></div><div class="skeleton-cell__line"></div></div>
        <div class="skeleton-cell"><div class="skeleton-cell__date"></div><div class="skeleton-cell__line"></div></div>
        <div class="skeleton-cell"><div class="skeleton-cell__date"></div><div class="skeleton-cell__line"></div></div>
        <div class="skeleton-cell"><div class="skeleton-cell__date"></div><div class="skeleton-cell__line"></div></div>
        <div class="skeleton-cell"><div class="skeleton-cell__date"></div><div class="skeleton-cell__line"></div></div>
        <div class="skeleton-cell"><div class="skeleton-cell__date"></div><div class="skeleton-cell__line"></div></div>
      </div>
      <div class="loading__text">◊ò◊ï◊¢◊ü ◊†◊™◊ï◊†◊ô◊ù...</div>
    </div>
  </div>

  <div id="dayModal"></div>
  <div id="notePopup"></div>
  <div id="addPeopleModal"></div>
  <div id="fairnessModal"></div>
  <div id="rotationModal"></div>
</div>

<div class="toast-container" id="toastContainer"></div>

<button class="today-fab" id="todayFab" title="◊í◊ú◊ï◊ú ◊ú◊î◊ô◊ï◊ù" style="display:none;">
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><circle cx="12" cy="16" r="2" fill="currentColor" stroke="none"/></svg>
  ◊î◊ô◊ï◊ù
</button>

<!-- Examples popup -->
<button class="examples-fab" id="examplesFab" title="◊ì◊ï◊í◊û◊ê◊ï◊™ ◊ú◊§◊ß◊ï◊ì◊ï◊™" aria-label="◊ì◊ï◊í◊û◊ê◊ï◊™ ◊ú◊§◊ß◊ï◊ì◊ï◊™">
  <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12zM7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/></svg>
</button>

<div class="examples-overlay" id="examplesOverlay"></div>

<div class="examples-panel" id="examplesPanel">
  <div class="examples-panel__header">
    <span class="examples-panel__title">◊ì◊ï◊í◊û◊ê◊ï◊™ ◊ú◊§◊ß◊ï◊ì◊ï◊™ ◊ë◊ï◊ò</span>
    <button class="examples-panel__close" id="examplesPanelClose" aria-label="◊°◊í◊ï◊®">&times;</button>
  </div>
  <div class="examples-panel__body" id="examplesPanelBody"></div>
</div>

<script>
// Theme toggle (runs immediately)
(function() {
  const moonSvg = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
  const sunSvg = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';

  function applyTheme(dark) {
    document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
    var icon = document.getElementById('themeIcon');
    if (icon) icon.innerHTML = dark ? moonSvg : sunSvg;
  }

  // Initialize from localStorage or system preference
  var stored = localStorage.getItem('theme');
  var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  var isDark = stored ? stored === 'dark' : prefersDark;
  applyTheme(isDark);

  document.getElementById('themeToggle').addEventListener('click', function() {
    isDark = !isDark;
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    applyTheme(isDark);
  });
})();

(function() {
  const holidays = {
    '2026-05-22': '◊©◊ë◊ï◊¢◊ï◊™ ◊ê◊≥',
    '2026-05-23': '◊©◊ë◊ï◊¢◊ï◊™ ◊ë◊≥'
  };

  const specialDays = {
    '2026-04-26': '◊ê◊ú◊¥◊™',
    '2026-04-27': '◊ê◊ú◊¥◊™',
    '2026-04-28': '◊ê◊ú◊¥◊™',
    '2026-04-29': '◊ê◊ú◊¥◊™',
    '2026-04-30': '◊™◊§◊ô◊°◊™ ◊ß◊ï'
  };

  const dayNames = ['◊®◊ê◊©◊ï◊ü', '◊©◊†◊ô', '◊©◊ú◊ô◊©◊ô', '◊®◊ë◊ô◊¢◊ô', '◊ó◊û◊ô◊©◊ô', '◊©◊ô◊©◊ô', '◊©◊ë◊™'];

  const gregMonths = {
    3: '◊ê◊§◊®◊ô◊ú', 4: '◊û◊ê◊ô', 5: '◊ô◊ï◊†◊ô'
  };

  // ---- Editing state ----
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwVV2JInfFv2UqOzf8KaA5S-q9ZwkmchqjmEoUvyAnzhoWrC6Yxhn_uO-19VBDUYkWN/exec';
  const DATE_START = '2026-04-26';
  const DATE_END = '2026-06-18';

  let currentMode = null;       // null | 'note' | 'edit'
  let pendingEdits = {};        // "name|YYYY-MM-DD" -> new status
  let undoStack = [];           // { type, key, oldValue }
  let isDragging = false;
  let dragStatus = null;
  let draggedCells = [];
  let currentDataMap = null;
  let currentNotesMap = null;
  let currentNames = null;
  let currentSelectedPerson = '__all__';
  let currentView = 'calendar'; // 'calendar' | 'timeline'
  let currentAssociationMap = {};   // name ‚Üí association string
  let currentAssociationFilter = null; // null = off, Set = active set of associations

  // ---- Utilities ----

  function formatDate(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const dd = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${dd}`;
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function statusLabel(s) {
    if (s === 'activity') return '◊ë◊û◊ï◊¶◊ë';
    if (s === 'home') return '◊ë◊ë◊ô◊™';
    if (s === 'switch-home') return '◊ô◊ï◊¶◊ê ◊î◊ë◊ô◊™◊î';
    return '◊ó◊ï◊ñ◊® ◊ú◊û◊ï◊¶◊ë';
  }

  // ---- Toast ----

  function showToast(message, type, duration) {
    type = type || 'info';
    duration = duration || 3000;
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'toast toast--' + type;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
      toast.style.animation = 'toastOut 0.3s ease-in forwards';
      toast.addEventListener('animationend', () => toast.remove());
    }, duration);
  }

  // ---- Apps Script API ----

  async function callAppsScript(payload) {
    if (APPS_SCRIPT_URL === 'YOUR_DEPLOYED_APPS_SCRIPT_URL_HERE') {
      showToast('◊ô◊© ◊ú◊î◊í◊ì◊ô◊® ◊ê◊™ ◊õ◊™◊ï◊ë◊™ Apps Script', 'error', 4000);
      throw new Error('Apps Script URL not configured');
    }
    try {
      const resp = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
      });
      const result = await resp.json();
      if (!result.success) throw new Error(result.error || 'Unknown error');
      return result;
    } catch (err) {
      showToast('◊©◊í◊ô◊ê◊î: ' + err.message, 'error', 5000);
      throw err;
    }
  }

  // ---- CSV Parsing ----

  function parseCSV(text) {
    text = text.replace(/^\uFEFF/, '');
    const lines = text.trim().split(/\r?\n/);
    if (lines.length < 2) return [];

    const header = lines[0].split(',').map(h => h.trim());
    const nameIdx = header.indexOf('name');
    const dateIdx = header.indexOf('date');
    const statusIdx = header.indexOf('status');
    const noteIdx = header.indexOf('note');
    const assocIdx = header.indexOf('association');

    if (nameIdx === -1 || dateIdx === -1 || statusIdx === -1) return [];

    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const parts = lines[i].split(',');
      if (parts.length < 3) continue;
      rows.push({
        name: parts[nameIdx].trim(),
        date: parts[dateIdx].trim(),
        status: parts[statusIdx].trim(),
        note: noteIdx !== -1 && parts[noteIdx] ? parts[noteIdx].trim() : '',
        association: assocIdx !== -1 && parts[assocIdx] ? parts[assocIdx].trim() : ''
      });
    }
    return rows;
  }

  function buildDataMap(rows) {
    const map = {};
    const notesMap = {};
    const names = new Set();
    const associationMap = {};
    rows.forEach(r => {
      if (!map[r.date]) map[r.date] = {};
      map[r.date][r.name] = r.status;
      if (r.note) {
        if (!notesMap[r.date]) notesMap[r.date] = {};
        notesMap[r.date][r.name] = r.note;
      }
      names.add(r.name);
      // First non-empty association wins for each name
      if (r.association && !associationMap[r.name]) {
        associationMap[r.name] = r.association;
      }
    });
    return { map, notesMap, names: [...names].sort(), associationMap };
  }

  function getFilteredNames() {
    if (!currentAssociationFilter) return currentNames;
    return currentNames.filter(name => {
      const assoc = currentAssociationMap[name] || '';
      return currentAssociationFilter.has(assoc);
    });
  }

  function getUniqueAssociations() {
    const vals = new Set();
    Object.values(currentAssociationMap).forEach(v => { if (v) vals.add(v); });
    return [...vals].sort((a, b) => a.localeCompare(b, 'he'));
  }

  // ---- Rendering ----

  const todayKey = formatDate(new Date());

  function renderCell(day, dataMap, notesMap, selectedPerson) {
    const key = formatDate(day);
    const dow = day.getDay();
    const isShabbat = dow === 6;
    const holiday = holidays[key] || null;
    const isToday = key === todayKey;

    let personStatus = null;
    if (selectedPerson !== '__all__') {
      const dayData = dataMap[key] || {};
      personStatus = dayData[selectedPerson] || null;
      // Check pending edits for override
      const pendingKey = selectedPerson + '|' + key;
      if (pendingEdits[pendingKey]) {
        personStatus = pendingEdits[pendingKey];
      }
    }

    let cellClass = 'cal-cell';
    if (isToday) cellClass += ' cal-cell--today';
    if (isShabbat) cellClass += ' cal-cell--shabbat';
    if (holiday) cellClass += ' cal-cell--shavuot';
    if (personStatus === 'activity') cellClass += ' cal-cell--status-activity';
    if (personStatus === 'home') cellClass += ' cal-cell--status-home';
    if (personStatus === 'switch-home') cellClass += ' cal-cell--status-switch-home';
    if (personStatus === 'switch-base') cellClass += ' cal-cell--status-switch-base';

    if (selectedPerson === '__all__') cellClass += ' cal-cell--clickable';
    if (selectedPerson !== '__all__' && currentMode) cellClass += ' cal-cell--editable';

    // Mark pending cells
    if (selectedPerson !== '__all__' && pendingEdits[selectedPerson + '|' + key]) {
      cellClass += ' cal-cell--pending';
    }

    let html = `<div class="${cellClass}" data-date="${key}">`;

    // Show month name on the 1st of each month
    if (day.getDate() === 1) {
      html += `<span class="cell-month-tag">${gregMonths[day.getMonth()]}</span>`;
    }

    html += '<div class="cell-top">';
    html += `<span class="cell-greg">${day.getDate()}/${day.getMonth() + 1}</span>`;
    html += '</div>';

    if (holiday) {
      html += `<span class="cell-holiday">${holiday}</span>`;
    }

    const special = specialDays[key];
    if (special) {
      html += `<span class="cell-special">${special}</span>`;
    }

    html += '<div class="cell-status">';
    if (selectedPerson === '__all__') {
      const dayData = dataMap[key] || {};
      let actCount = 0, homeCount = 0, switchCount = 0;
      Object.entries(dayData).forEach(([name, s]) => {
        if (currentAssociationFilter && !currentAssociationFilter.has(currentAssociationMap[name] || '')) return;
        if (s === 'activity') actCount++;
        else if (s === 'home') homeCount++;
        else if (s.startsWith('switch')) switchCount++;
      });
      if (actCount + homeCount + switchCount > 0) {
        html += '<div class="status-summary">';
        if (actCount) html += `<div class="summary-row"><span class="summary-dot summary-dot--activity"></span>${actCount} ◊ë◊û◊ï◊¶◊ë</div>`;
        if (homeCount) html += `<div class="summary-row"><span class="summary-dot summary-dot--home"></span>${homeCount} ◊ë◊ë◊ô◊™</div>`;
        if (switchCount) html += `<div class="summary-row"><span class="summary-dot summary-dot--switch"></span>${switchCount} ◊û◊¢◊ë◊®</div>`;
        html += '</div>';
      }
    } else if (personStatus) {
      html += `<span class="cell-status-label">${statusLabel(personStatus)}</span>`;
    }
    html += '</div>';

    // Notes
    const dayNotes = notesMap[key] || {};
    if (selectedPerson !== '__all__' && dayNotes[selectedPerson]) {
      html += `<span class="cell-note">${escapeHtml(dayNotes[selectedPerson])}</span>`;
    }

    html += '</div>';
    return html;
  }

  function renderCalendar(dataMap, notesMap, names, selectedPerson) {
    const container = document.getElementById('calendarContainer');

    const allDays = [];
    const d = new Date(2026, 3, 26);
    const end = new Date(2026, 5, 18);
    while (d <= end) {
      allDays.push(new Date(d));
      d.setDate(d.getDate() + 1);
    }

    let html = '<div class="calendar-wrap">';

    html += '<div class="cal-headers">';
    dayNames.forEach((name, i) => {
      html += `<div class="cal-header${i === 6 ? ' cal-header--shabbat' : ''}">${name}</div>`;
    });
    html += '</div>';

    html += '<div class="cal-grid">';

    const firstDow = allDays[0].getDay();
    for (let i = 0; i < firstDow; i++) {
      html += '<div class="cal-cell cal-cell--empty"></div>';
    }

    allDays.forEach(day => {
      html += renderCell(day, dataMap, notesMap, selectedPerson);
    });

    const lastDow = allDays[allDays.length - 1].getDay();
    for (let i = lastDow + 1; i < 7; i++) {
      html += '<div class="cal-cell cal-cell--empty"></div>';
    }

    html += '</div></div>';
    container.innerHTML = html;

    // Attach click handlers
    if (selectedPerson === '__all__') {
      container.querySelectorAll('.cal-cell--clickable').forEach(cell => {
        cell.addEventListener('click', () => {
          const dateKey = cell.getAttribute('data-date');
          showDayModal(dateKey, dataMap, notesMap);
        });
      });
    } else {
      // Individual person ‚Äî mode-aware clicks
      container.querySelectorAll('.cal-cell[data-date]').forEach(cell => {
        if (cell.classList.contains('cal-cell--empty')) return;
        cell.addEventListener('click', (e) => {
          if (isDragging && draggedCells.length > 1) return;
          if (e.target.closest('.status-picker')) return;
          const dateKey = cell.getAttribute('data-date');
          if (currentMode === 'note') {
            showNotePopup(dateKey);
          } else if (currentMode === 'edit') {
            showStatusPicker(cell, dateKey);
          }
        });
      });
    }

    // Re-attach sticky header shadow observer after innerHTML rebuild
    attachStickyHeaderObserver();
  }

  // ---- Sticky Header Observer ----

  let _stickyObserver = null;
  function attachStickyHeaderObserver() {
    if (_stickyObserver) _stickyObserver.disconnect();
    const calHeaders = document.querySelector('.cal-headers');
    if (!calHeaders) return;
    _stickyObserver = new IntersectionObserver(
      ([entry]) => {
        calHeaders.style.boxShadow = entry.intersectionRatio < 1
          ? '0 3px 8px rgba(26,22,18,0.1)'
          : 'none';
      },
      { threshold: [1], rootMargin: '-1px 0px 0px 0px' }
    );
    _stickyObserver.observe(calHeaders);
  }

  // ---- Crossfade Transition ----

  let _fadeTimer = null;
  function fadeSwapCalendar(renderFn) {
    const container = document.getElementById('calendarContainer');
    if (_fadeTimer) {
      clearTimeout(_fadeTimer);
      _fadeTimer = null;
    }
    container.classList.add('fading');
    _fadeTimer = setTimeout(() => {
      _fadeTimer = null;
      renderFn();
      container.classList.remove('fading');
    }, 150);
  }

  // ---- Stats Bar ----

  function updateStatsBar(dataMap) {
    const bar = document.getElementById('statsBar');
    const dayData = dataMap[todayKey] || {};
    let total = 0;

    let actCount = 0, homeCount = 0, switchCount = 0;
    Object.entries(dayData).forEach(([name, s]) => {
      if (currentAssociationFilter && !currentAssociationFilter.has(currentAssociationMap[name] || '')) return;
      total++;
      if (s === 'activity') actCount++;
      else if (s === 'home') homeCount++;
      else if (s && s.startsWith('switch')) switchCount++;
    });

    if (total === 0) {
      bar.style.display = 'none';
      return;
    }

    const [, m, d] = todayKey.split('-').map(Number);
    let html = '<span class="stats-bar__title">';
    html += '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>';
    html += '◊î◊ô◊ï◊ù ' + d + '/' + m + ':</span>';

    if (actCount) html += '<span class="stats-bar__chip stats-bar__chip--activity"><span class="stats-bar__dot stats-bar__dot--activity"></span>' + actCount + ' ◊ë◊û◊ï◊¶◊ë</span>';
    if (homeCount) html += '<span class="stats-bar__chip stats-bar__chip--home"><span class="stats-bar__dot stats-bar__dot--home"></span>' + homeCount + ' ◊ë◊ë◊ô◊™</span>';
    if (switchCount) html += '<span class="stats-bar__chip stats-bar__chip--switch"><span class="stats-bar__dot stats-bar__dot--switch"></span>' + switchCount + ' ◊û◊¢◊ë◊®</span>';

    bar.innerHTML = html;
    bar.style.display = 'flex';
    bar.onclick = function() {
      const todayCell = document.querySelector('.cal-cell--today');
      if (todayCell) todayCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };
  }

  // ---- Person Stats ----

  function updatePersonStats(dataMap, person) {
    const el = document.getElementById('personStats');
    if (person === '__all__') {
      el.style.display = 'none';
      return;
    }

    let actCount = 0, homeCount = 0, switchCount = 0;
    Object.keys(dataMap).forEach(dateKey => {
      const status = dataMap[dateKey] && dataMap[dateKey][person];
      if (status === 'activity') actCount++;
      else if (status === 'home') homeCount++;
      else if (status && status.startsWith('switch')) switchCount++;
    });

    const total = actCount + homeCount + switchCount;
    if (total === 0) {
      el.style.display = 'none';
      return;
    }

    const actPct = (actCount / total * 100).toFixed(1);
    const homePct = (homeCount / total * 100).toFixed(1);
    const switchPct = (switchCount / total * 100).toFixed(1);

    let html = '<span class="person-stats__name">' + escapeHtml(person) + ':</span>';
    html += '<span class="person-stats__item person-stats__item--activity">' + actCount + ' ◊ë◊û◊ï◊¶◊ë</span>';
    html += '<span class="person-stats__sep">|</span>';
    html += '<span class="person-stats__item person-stats__item--home">' + homeCount + ' ◊ë◊ë◊ô◊™</span>';
    if (switchCount > 0) {
      html += '<span class="person-stats__sep">|</span>';
      html += '<span class="person-stats__item person-stats__item--switch">' + switchCount + ' ◊û◊¢◊ë◊®</span>';
    }
    html += '<div class="person-stats__bar">';
    html += '<div class="person-stats__bar-seg person-stats__bar-seg--activity" style="width:' + actPct + '%"></div>';
    html += '<div class="person-stats__bar-seg person-stats__bar-seg--home" style="width:' + homePct + '%"></div>';
    html += '<div class="person-stats__bar-seg person-stats__bar-seg--switch" style="width:' + switchPct + '%"></div>';
    html += '</div>';

    el.innerHTML = html;
    el.style.display = 'flex';
  }

  // ---- Day Detail Modal (Everyone view) ----

  function showDayModal(dateKey, dataMap, notesMap) {
    const dayData = dataMap[dateKey] || {};
    const dayNotes = notesMap[dateKey] || {};
    const modalEl = document.getElementById('dayModal');

    const [y, m, d] = dateKey.split('-').map(Number);
    const dateObj = new Date(y, m - 1, d);
    const dayName = dayNames[dateObj.getDay()];
    const dateLabel = `◊ô◊ï◊ù ${dayName}, ${d}/${m}`;

    const atBase = [];
    const atHome = [];
    const switching = [];
    Object.entries(dayData).forEach(([name, status]) => {
      if (currentAssociationFilter && !currentAssociationFilter.has(currentAssociationMap[name] || '')) return;
      const note = dayNotes[name] || '';
      if (status === 'activity') atBase.push({ name, note, sub: '' });
      else if (status === 'home') atHome.push({ name, note, sub: '' });
      else if (status === 'switch-home') switching.push({ name, note, sub: '◊ô◊ï◊¶◊ê ◊î◊ë◊ô◊™◊î' });
      else if (status === 'switch-base') switching.push({ name, note, sub: '◊ó◊ï◊ñ◊® ◊ú◊û◊ï◊¶◊ë' });
    });

    const sortFn = (a, b) => a.name.localeCompare(b.name, 'he');
    atBase.sort(sortFn);
    atHome.sort(sortFn);
    switching.sort(sortFn);

    function renderGroup(title, titleClass, people, personClass) {
      if (people.length === 0) return '';
      let h = `<div class="day-modal__group">`;
      h += `<div class="day-modal__group-title ${titleClass}">${title} (${people.length})</div>`;
      h += `<ul class="day-modal__list">`;
      people.forEach(p => {
        h += `<li class="day-modal__person ${personClass}">`;
        h += `<span>${p.name}${p.sub ? ' ‚Äî ' + p.sub : ''}</span>`;
        if (p.note) h += `<span class="day-modal__person-note">${escapeHtml(p.note)}</span>`;
        h += `</li>`;
      });
      h += `</ul></div>`;
      return h;
    }

    let html = `<div class="day-modal-overlay" id="dayModalOverlay">`;
    html += `<div class="day-modal">`;
    html += `<div class="day-modal__header">`;
    html += `<span class="day-modal__title">${dateLabel}</span>`;
    html += `<button class="day-modal__close" id="dayModalClose">&times;</button>`;
    html += `</div>`;
    html += `<div class="day-modal__body">`;
    html += renderGroup('◊ë◊û◊ï◊¶◊ë', 'day-modal__group-title--activity', atBase, 'day-modal__person--activity');
    html += renderGroup('◊ë◊ë◊ô◊™', 'day-modal__group-title--home', atHome, 'day-modal__person--home');
    html += renderGroup('◊û◊¢◊ë◊®', 'day-modal__group-title--switch', switching, 'day-modal__person--switch');
    html += `</div></div></div>`;

    modalEl.innerHTML = html;

    document.getElementById('dayModalClose').addEventListener('click', () => { modalEl.innerHTML = ''; });
    function dismissDayModal(e) {
      if (e.target === e.currentTarget) modalEl.innerHTML = '';
    }
    document.getElementById('dayModalOverlay').addEventListener('click', dismissDayModal);
    document.getElementById('dayModalOverlay').addEventListener('touchend', dismissDayModal);
  }

  // ---- Note Mode ----

  function showNotePopup(dateKey) {
    const person = currentSelectedPerson;
    if (person === '__all__') return;

    const existingNote = (currentNotesMap[dateKey] && currentNotesMap[dateKey][person]) || '';
    const currentNote = existingNote;

    const [y, m, d] = dateKey.split('-').map(Number);
    const dateDisplay = d + '/' + m;

    const popup = document.getElementById('notePopup');
    let html = '<div class="note-popup-overlay" id="notePopupOverlay">';
    html += '<div class="note-popup">';
    html += '<div class="note-popup__title">◊î◊¢◊®◊î ◊ú' + escapeHtml(person) + ' ‚Äî ' + dateDisplay + '</div>';
    html += '<textarea class="note-popup__input" id="noteInput" placeholder="◊î◊ß◊ú◊ì ◊î◊¢◊®◊î...">' + escapeHtml(currentNote) + '</textarea>';
    html += '<div class="note-popup__actions">';
    html += '<button class="note-popup__btn note-popup__btn--save" id="noteSave">◊©◊û◊ï◊®</button>';
    html += '<button class="note-popup__btn note-popup__btn--cancel" id="noteCancel">◊ë◊ô◊ò◊ï◊ú</button>';
    if (currentNote) {
      html += '<button class="note-popup__btn note-popup__btn--delete" id="noteDelete">◊û◊ó◊ß</button>';
    }
    html += '</div></div></div>';

    popup.innerHTML = html;
    document.getElementById('noteInput').focus();

    document.getElementById('noteSave').addEventListener('click', async () => {
      const newNote = document.getElementById('noteInput').value.trim();
      const btn = document.getElementById('noteSave');
      btn.disabled = true;
      btn.textContent = '◊©◊ï◊û◊®...';
      try {
        await callAppsScript({
          action: 'updateCells',
          edits: [],
          notes: [{ name: person, date: dateKey, note: newNote }]
        });
        if (!currentNotesMap[dateKey]) currentNotesMap[dateKey] = {};
        if (newNote) {
          currentNotesMap[dateKey][person] = newNote;
        } else {
          delete currentNotesMap[dateKey][person];
        }
        popup.innerHTML = '';
        showToast('◊î◊î◊¢◊®◊î ◊†◊©◊û◊®◊î ◊ë◊î◊¶◊ú◊ó◊î', 'success');
        renderCurrentView();
      } catch (err) {
        btn.disabled = false;
        btn.textContent = '◊©◊û◊ï◊®';
      }
    });

    document.getElementById('noteCancel').addEventListener('click', () => {
      popup.innerHTML = '';
    });

    const deleteBtn = document.getElementById('noteDelete');
    if (deleteBtn) {
      deleteBtn.addEventListener('click', async () => {
        deleteBtn.disabled = true;
        deleteBtn.textContent = '◊û◊ï◊ó◊ß...';
        try {
          await callAppsScript({
            action: 'updateCells',
            edits: [],
            notes: [{ name: person, date: dateKey, note: '' }]
          });
          if (currentNotesMap[dateKey]) delete currentNotesMap[dateKey][person];
          popup.innerHTML = '';
          showToast('◊î◊î◊¢◊®◊î ◊†◊û◊ó◊ß◊î', 'success');
          renderCurrentView();
        } catch (err) {
          deleteBtn.disabled = false;
          deleteBtn.textContent = '◊û◊ó◊ß';
        }
      });
    }

    function dismissNoteOverlay(e) {
      if (e.target === e.currentTarget) popup.innerHTML = '';
    }
    document.getElementById('notePopupOverlay').addEventListener('click', dismissNoteOverlay);
    document.getElementById('notePopupOverlay').addEventListener('touchend', dismissNoteOverlay);
  }

  // ---- Edit Mode: Status Picker ----

  function showStatusPicker(cellElement, dateKey) {
    removeStatusPicker();

    const person = currentSelectedPerson;
    const pendingKey = person + '|' + dateKey;
    const currentStatus = pendingEdits[pendingKey] ||
      (currentDataMap[dateKey] && currentDataMap[dateKey][person]) || null;

    const options = [
      { value: 'activity', label: '◊ë◊û◊ï◊¶◊ë', style: 'background:var(--clr-activity)' },
      { value: 'home', label: '◊ë◊ë◊ô◊™', style: 'background:var(--clr-home)' },
      { value: 'switch-base', label: '◊ó◊ï◊ñ◊® ◊ú◊û◊ï◊¶◊ë', style: 'background:linear-gradient(135deg,var(--clr-activity) 50%,var(--clr-home) 50%)' },
      { value: 'switch-home', label: '◊ô◊ï◊¶◊ê ◊î◊ë◊ô◊™◊î', style: 'background:linear-gradient(135deg,var(--clr-home) 50%,var(--clr-activity) 50%)' }
    ];

    const picker = document.createElement('div');
    picker.className = 'status-picker';
    picker.id = 'statusPicker';

    options.forEach(opt => {
      const btn = document.createElement('button');
      btn.className = 'status-picker__option' + (currentStatus === opt.value ? ' status-picker__option--active' : '');
      btn.innerHTML = '<span class="status-picker__dot" style="' + opt.style + '"></span>' + opt.label;
      function handlePickerSelect(e) {
        e.stopPropagation();
        e.preventDefault();
        stageEdit(dateKey, opt.value);
        removeStatusPicker();
      }
      btn.addEventListener('click', handlePickerSelect);
      btn.addEventListener('touchend', handlePickerSelect);
      picker.appendChild(btn);
    });

    const rect = cellElement.getBoundingClientRect();
    picker.style.position = 'fixed';
    picker.style.top = (rect.bottom + 4) + 'px';
    picker.style.right = (window.innerWidth - rect.right) + 'px';
    document.body.appendChild(picker);

    setTimeout(() => {
      document.addEventListener('click', closePickerOnOutsideClick);
      document.addEventListener('touchend', closePickerOnOutsideTouch);
    }, 10);
  }

  function closePickerOnOutsideClick(e) {
    const picker = document.getElementById('statusPicker');
    if (picker && !picker.contains(e.target)) {
      removeStatusPicker();
    }
  }

  function closePickerOnOutsideTouch(e) {
    const picker = document.getElementById('statusPicker');
    if (!picker) return;
    const touch = e.changedTouches && e.changedTouches[0];
    if (!touch) return;
    const el = document.elementFromPoint(touch.clientX, touch.clientY);
    if (el && !picker.contains(el)) {
      removeStatusPicker();
    }
  }

  function removeStatusPicker() {
    const existing = document.getElementById('statusPicker');
    if (existing) existing.remove();
    document.removeEventListener('click', closePickerOnOutsideClick);
    document.removeEventListener('touchend', closePickerOnOutsideTouch);
  }

  // ---- Week Jump Bar ----

  function renderWeekJumpBar() {
    const bar = document.getElementById('weekJumpBar');
    if (currentView === 'timeline') {
      bar.style.display = 'none';
      return;
    }

    const start = new Date(2026, 3, 26); // Apr 26
    const end = new Date(2026, 5, 18);   // Jun 18
    const weeks = [];
    const d = new Date(start);

    while (d <= end) {
      const weekStart = new Date(d);
      const weekEnd = new Date(d);
      weekEnd.setDate(weekEnd.getDate() + 6);
      if (weekEnd > end) weekEnd.setTime(end.getTime());
      weeks.push({ start: new Date(weekStart), end: new Date(weekEnd) });
      d.setDate(d.getDate() + 7);
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    let html = '';
    weeks.forEach((w, i) => {
      const label = w.start.getDate() + '/' + (w.start.getMonth() + 1) + '‚Äì' + w.end.getDate() + '/' + (w.end.getMonth() + 1);
      const hasToday = today >= w.start && today <= w.end;
      const cls = 'week-pill' + (hasToday ? ' week-pill--has-today' : '');
      const startKey = formatDate(w.start);
      html += '<button class="' + cls + '" data-week-start="' + startKey + '" data-week-idx="' + i + '">' + label + '</button>';
    });

    bar.innerHTML = html;
    bar.style.display = 'flex';

    bar.addEventListener('click', function(e) {
      const pill = e.target.closest('.week-pill');
      if (!pill) return;
      const startKey = pill.getAttribute('data-week-start');
      const cell = document.querySelector('.cal-cell[data-date="' + startKey + '"]');
      if (cell) cell.scrollIntoView({ behavior: 'smooth', block: 'center' });
      bar.querySelectorAll('.week-pill').forEach(p => p.classList.remove('week-pill--active'));
      pill.classList.add('week-pill--active');
    });
  }

  // ---- Keyboard Cell Navigation ----

  let focusedDateKey = null;

  function setFocusedCell(dateKey) {
    const oldCell = document.querySelector('.cal-cell--focused');
    if (oldCell) oldCell.classList.remove('cal-cell--focused');
    focusedDateKey = dateKey;
    if (!dateKey) return;
    const cell = document.querySelector('.cal-cell[data-date="' + dateKey + '"]');
    if (cell) {
      cell.classList.add('cal-cell--focused');
      cell.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }

  function navigateCell(deltaDays) {
    if (!focusedDateKey) {
      // Start from today or first day
      const todayCell = document.querySelector('.cal-cell--today');
      if (todayCell) {
        setFocusedCell(todayCell.getAttribute('data-date'));
      } else {
        setFocusedCell(DATE_START);
      }
      return;
    }

    const [y, m, d] = focusedDateKey.split('-').map(Number);
    const current = new Date(y, m - 1, d);
    current.setDate(current.getDate() + deltaDays);
    const targetKey = formatDate(current);

    // Check bounds
    if (targetKey < DATE_START || targetKey > DATE_END) return;

    setFocusedCell(targetKey);
  }

  function activateFocusedCell() {
    if (!focusedDateKey) return;
    const cell = document.querySelector('.cal-cell[data-date="' + focusedDateKey + '"]');
    if (!cell) return;

    if (currentSelectedPerson === '__all__') {
      showDayModal(focusedDateKey, currentDataMap, currentNotesMap);
    } else if (currentMode === 'note') {
      showNotePopup(focusedDateKey);
    } else if (currentMode === 'edit') {
      showStatusPicker(cell, focusedDateKey);
    }
  }

  // ---- Person Search ----

  let allPersonOptions = []; // snapshot of {value, text} after population

  function capturePersonOptions() {
    const select = document.getElementById('personFilter');
    allPersonOptions = [];
    for (let i = 0; i < select.options.length; i++) {
      allPersonOptions.push({ value: select.options[i].value, text: select.options[i].textContent });
    }
  }

  function filterPersons(query) {
    const select = document.getElementById('personFilter');
    const currentVal = select.value;
    const q = query.trim().toLowerCase();

    // Clear all options
    while (select.options.length > 0) select.remove(0);

    allPersonOptions.forEach(opt => {
      if (opt.value === '__all__' || q === '' ||
          opt.value.toLowerCase().includes(q) ||
          opt.text.toLowerCase().includes(q)) {
        const o = document.createElement('option');
        o.value = opt.value;
        o.textContent = opt.text;
        select.appendChild(o);
      }
    });

    // Restore selection if still visible
    const stillHas = Array.from(select.options).some(o => o.value === currentVal);
    if (stillHas) {
      select.value = currentVal;
    }
  }

  // ---- Association Filter Logic ----

  function renderAssocFilterPopover() {
    const popover = document.getElementById('assocFilterPopover');
    const associations = getUniqueAssociations();
    const hasNoAssoc = currentNames.some(n => !currentAssociationMap[n]);

    let html = '<div class="assoc-filter-popover__header">';
    html += '<a id="assocSelectAll">◊ë◊ó◊® ◊î◊õ◊ú</a>';
    html += '<a id="assocClearAll">◊†◊ß◊î ◊î◊õ◊ú</a>';
    html += '</div>';

    associations.forEach(assoc => {
      const checked = !currentAssociationFilter || currentAssociationFilter.has(assoc);
      html += '<label class="assoc-filter-popover__item">';
      html += '<input type="checkbox" value="' + escapeHtml(assoc) + '"' + (checked ? ' checked' : '') + '>';
      html += '<span>' + escapeHtml(assoc) + '</span></label>';
    });

    if (hasNoAssoc) {
      const checked = !currentAssociationFilter || currentAssociationFilter.has('');
      html += '<label class="assoc-filter-popover__item">';
      html += '<input type="checkbox" value=""' + (checked ? ' checked' : '') + '>';
      html += '<span>(◊ú◊ú◊ê ◊©◊ô◊ï◊ö)</span></label>';
    }

    html += '<div class="assoc-filter-popover__footer">';
    html += '<button class="assoc-filter-popover__btn-apply" id="assocApply">◊î◊ó◊ú</button>';
    html += '<button class="assoc-filter-popover__btn-reset" id="assocReset">◊î◊¶◊í ◊î◊õ◊ú</button>';
    html += '</div>';

    popover.innerHTML = html;

    document.getElementById('assocSelectAll').addEventListener('click', () => {
      popover.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    });
    document.getElementById('assocClearAll').addEventListener('click', () => {
      popover.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    });
    document.getElementById('assocApply').addEventListener('click', () => {
      applyAssocFilter();
      popover.classList.remove('assoc-filter-popover--open');
    });
    document.getElementById('assocReset').addEventListener('click', () => {
      currentAssociationFilter = null;
      updateAssocFilterButton();
      repopulatePersonDropdown();
      refreshCalendarAndStats();
      popover.classList.remove('assoc-filter-popover--open');
    });
  }

  function applyAssocFilter() {
    const popover = document.getElementById('assocFilterPopover');
    const checked = popover.querySelectorAll('input[type="checkbox"]:checked');
    const allBoxes = popover.querySelectorAll('input[type="checkbox"]');

    if (checked.length === 0 || checked.length === allBoxes.length) {
      currentAssociationFilter = null;
    } else {
      currentAssociationFilter = new Set();
      checked.forEach(cb => currentAssociationFilter.add(cb.value));
    }

    updateAssocFilterButton();
    repopulatePersonDropdown();
    refreshCalendarAndStats();
  }

  function updateAssocFilterButton() {
    const btn = document.getElementById('btnAssocFilter');
    btn.classList.toggle('assoc-filter-btn--active', currentAssociationFilter !== null);
  }

  function repopulatePersonDropdown() {
    const select = document.getElementById('personFilter');
    const commander = '◊í◊ô◊ú ◊ñ◊ê◊ë◊ô';
    const filteredNames = getFilteredNames();
    const currentVal = select.value;

    // Clear all options
    while (select.options.length > 0) select.remove(0);

    // Re-add __all__
    const allOpt = document.createElement('option');
    allOpt.value = '__all__';
    allOpt.textContent = '◊õ◊ï◊ú◊ù';
    select.appendChild(allOpt);

    // Re-add filtered names (commander first)
    const sorted = [commander, ...filteredNames.filter(n => n !== commander)].filter(n => filteredNames.includes(n));
    sorted.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name === commander ? '‚≠ê ' + name : name;
      select.appendChild(opt);
    });

    // Re-snapshot for person search
    capturePersonOptions();

    // Restore selection if still valid
    const stillHas = Array.from(select.options).some(o => o.value === currentVal);
    if (stillHas) {
      select.value = currentVal;
    } else {
      select.value = '__all__';
      select.dispatchEvent(new Event('change'));
    }
  }

  function refreshCalendarAndStats() {
    fadeSwapCalendar(() => {
      renderCurrentView();
      if (currentSelectedPerson === '__all__') {
        updateStatsBar(currentDataMap);
      } else {
        document.getElementById('statsBar').style.display = 'none';
      }
      updatePersonStats(currentDataMap, currentSelectedPerson);
      renderWeekJumpBar();
    });
  }

  function stageEdit(dateKey, newStatus) {
    const person = currentSelectedPerson;
    const pendingKey = person + '|' + dateKey;
    const origStatus = (currentDataMap[dateKey] && currentDataMap[dateKey][person]) || null;
    const prevPending = pendingEdits[pendingKey];

    undoStack.push({
      type: 'edit',
      key: pendingKey,
      oldValue: prevPending !== undefined ? prevPending : origStatus
    });

    // If setting back to original, remove from pending
    if (newStatus === origStatus) {
      delete pendingEdits[pendingKey];
    } else {
      pendingEdits[pendingKey] = newStatus;
    }

    updateCellVisual(dateKey, newStatus, newStatus !== origStatus);
    updateSaveDiscardBar();
  }

  function updateCellVisual(dateKey, newStatus, isPending) {
    const cell = document.querySelector('.cal-cell[data-date="' + dateKey + '"]');
    if (!cell) return;

    cell.classList.remove('cal-cell--status-activity', 'cal-cell--status-home',
      'cal-cell--status-switch-home', 'cal-cell--status-switch-base');

    if (newStatus) {
      cell.classList.add('cal-cell--status-' + newStatus);
    }

    if (isPending) {
      cell.classList.add('cal-cell--pending');
    } else {
      cell.classList.remove('cal-cell--pending');
    }

    const statusDiv = cell.querySelector('.cell-status');
    if (statusDiv && newStatus) {
      statusDiv.innerHTML = '<span class="cell-status-label">' + statusLabel(newStatus) + '</span>';
    }
  }

  // ---- Drag-to-Fill ----

  function setupDragHandlers() {
    const container = document.getElementById('calendarContainer');

    container.addEventListener('mousedown', onDragStart);
    document.addEventListener('mousemove', onDragMove);
    document.addEventListener('mouseup', onDragEnd);

    container.addEventListener('touchstart', onTouchStart, { passive: false });
    document.addEventListener('touchmove', onTouchMove, { passive: false });
    document.addEventListener('touchend', onTouchEnd);
  }

  function getCellFromEvent(e) {
    const el = document.elementFromPoint(e.clientX, e.clientY);
    if (!el) return null;
    const cell = el.closest('.cal-cell[data-date], .timeline-cell[data-date]');
    if (!cell || cell.classList.contains('cal-cell--empty')) return null;
    return cell;
  }


  function onDragStart(e) {
    if (currentMode !== 'edit') return;
    const cell = e.target.closest('.cal-cell[data-date], .timeline-cell[data-date]');
    if (!cell || cell.classList.contains('cal-cell--empty')) return;
    if (e.target.closest('.status-picker')) return;

    const dateKey = cell.getAttribute('data-date');
    const person = currentSelectedPerson;
    const pendingKey = person + '|' + dateKey;

    dragStatus = pendingEdits[pendingKey] ||
      (currentDataMap[dateKey] && currentDataMap[dateKey][person]) || 'activity';

    isDragging = true;
    draggedCells = [dateKey];

    cell.classList.add('cal-cell--drag-highlight');
    e.preventDefault();
  }

  function onDragMove(e) {
    if (!isDragging || currentMode !== 'edit') return;

    const cell = getCellFromEvent(e);
    if (!cell) return;

    const dateKey = cell.getAttribute('data-date');
    if (draggedCells.includes(dateKey)) return;

    draggedCells.push(dateKey);
    stageEdit(dateKey, dragStatus);
    cell.classList.add('cal-cell--drag-highlight');
  }

  function onDragEnd() {
    if (!isDragging) return;
    isDragging = false;

    document.querySelectorAll('.cal-cell--drag-highlight').forEach(c => {
      c.classList.remove('cal-cell--drag-highlight');
    });

    draggedCells = [];
    updateSaveDiscardBar();
  }

  let touchDragMoved = false;
  let touchStartCell = null;

  function onTouchStart(e) {
    if (currentMode !== 'edit') return;
    const touch = e.touches[0];
    const el = document.elementFromPoint(touch.clientX, touch.clientY);
    if (!el) return;
    const cell = el.closest('.cal-cell[data-date]');
    if (cell && !cell.classList.contains('cal-cell--empty') && !el.closest('.status-picker')) {
      e.preventDefault();
      touchDragMoved = false;
      touchStartCell = cell;
      onDragStart({
        target: cell,
        clientX: touch.clientX,
        clientY: touch.clientY,
        preventDefault: function() {}
      });
    }
  }

  function onTouchMove(e) {
    if (!isDragging) return;
    e.preventDefault();
    const touch = e.touches[0];
    const movedCell = getCellFromEvent({ clientX: touch.clientX, clientY: touch.clientY });
    if (movedCell && movedCell !== touchStartCell) {
      touchDragMoved = true;
    }
    onDragMove({ clientX: touch.clientX, clientY: touch.clientY });
  }

  function onTouchEnd() {
    // If this was a single tap (no drag movement), show the status picker
    if (isDragging && !touchDragMoved && touchStartCell && currentMode === 'edit') {
      const dateKey = touchStartCell.getAttribute('data-date');
      onDragEnd();
      showStatusPicker(touchStartCell, dateKey);
      touchStartCell = null;
      return;
    }
    touchStartCell = null;
    onDragEnd();
  }

  // ---- Save / Discard Bar ----

  function updateSaveDiscardBar() {
    const count = Object.keys(pendingEdits).length;
    const bar = document.getElementById('saveBar');
    const counter = document.getElementById('saveBarCount');

    if (count === 0) {
      bar.style.display = 'none';
      return;
    }

    bar.style.display = 'flex';
    counter.textContent = count + ' ◊©◊ô◊†◊ï◊ô◊ô◊ù ◊û◊û◊™◊ô◊†◊ô◊ù';
  }

  async function saveAllEdits() {
    const edits = [];
    Object.entries(pendingEdits).forEach(([key, status]) => {
      const sep = key.indexOf('|');
      const name = key.substring(0, sep);
      const date = key.substring(sep + 1);
      edits.push({ name, date, status });
    });

    if (edits.length === 0) {
      showToast('◊ê◊ô◊ü ◊©◊ô◊†◊ï◊ô◊ô◊ù ◊ú◊©◊û◊ô◊®◊î', 'info');
      return;
    }

    const btn = document.getElementById('btnSaveAll');
    btn.disabled = true;
    btn.textContent = '◊©◊ï◊û◊®...';

    try {
      const result = await callAppsScript({
        action: 'updateCells',
        edits: edits,
        notes: []
      });

      const skippedKeys = new Set(result.missingKeys || []);

      edits.forEach(edit => {
        const key = edit.name + '|' + edit.date;
        if (skippedKeys.has(key)) return;
        if (!currentDataMap[edit.date]) currentDataMap[edit.date] = {};
        currentDataMap[edit.date][edit.name] = edit.status;
      });

      // Only remove saved edits from pendingEdits; keep skipped ones
      for (const key of Object.keys(pendingEdits)) {
        if (!skippedKeys.has(key)) {
          delete pendingEdits[key];
        }
      }
      undoStack = [];

      if (result.skipped > 0) {
        showToast('◊†◊©◊û◊®◊ï ' + result.updated + ' ◊©◊ô◊†◊ï◊ô◊ô◊ù, ' + result.skipped + ' ◊ú◊ê ◊†◊û◊¶◊ê◊ï', 'warning', 5000);
      } else {
        showToast('◊†◊©◊û◊®◊ï ' + result.updated + ' ◊©◊ô◊†◊ï◊ô◊ô◊ù ◊ë◊î◊¶◊ú◊ó◊î', 'success');
      }
      renderCurrentView();
      // Hide save bar only if no skipped edits remain
      if (Object.keys(pendingEdits).length === 0) {
        document.getElementById('saveBar').style.display = 'none';
      } else {
        updateSaveDiscardBar();
      }
    } catch (err) {
      // Error toast shown by callAppsScript
    } finally {
      btn.disabled = false;
      btn.textContent = 'üíæ ◊©◊û◊ï◊® ◊©◊ô◊†◊ï◊ô◊ô◊ù';
    }
  }

  let discardConfirmTimer = null;
  let discardConfirmActive = false;

  function discardAllEdits() {
    const btn = document.getElementById('btnDiscardAll');

    if (!discardConfirmActive) {
      // First click: enter confirm state
      discardConfirmActive = true;
      btn.textContent = '‚ö†Ô∏è ◊ë◊ò◊ï◊ó?';
      btn.style.background = '#dc2626';
      btn.style.color = '#fff';
      btn.style.borderColor = '#dc2626';
      discardConfirmTimer = setTimeout(() => {
        discardConfirmActive = false;
        btn.textContent = 'üóëÔ∏è ◊ë◊ò◊ú ◊î◊õ◊ú';
        btn.style.background = '';
        btn.style.color = '';
        btn.style.borderColor = '';
      }, 3000);
      return;
    }

    // Second click: actually discard
    clearTimeout(discardConfirmTimer);
    discardConfirmActive = false;
    btn.textContent = 'üóëÔ∏è ◊ë◊ò◊ú ◊î◊õ◊ú';
    btn.style.background = '';
    btn.style.color = '';
    btn.style.borderColor = '';

    pendingEdits = {};
    undoStack = [];
    renderCurrentView();
    document.getElementById('saveBar').style.display = 'none';
    showToast('◊õ◊ú ◊î◊©◊ô◊†◊ï◊ô◊ô◊ù ◊ë◊ï◊ò◊ú◊ï', 'info');
  }

  function undoLastEdit() {
    if (undoStack.length === 0) {
      showToast('◊ê◊ô◊ü ◊û◊î ◊ú◊ë◊ò◊ú', 'info');
      return;
    }

    const last = undoStack.pop();
    if (last.type === 'edit') {
      const sep = last.key.indexOf('|');
      const name = last.key.substring(0, sep);
      const dateKey = last.key.substring(sep + 1);
      const origStatus = (currentDataMap[dateKey] && currentDataMap[dateKey][name]) || null;

      if (last.oldValue === origStatus || last.oldValue === null) {
        delete pendingEdits[last.key];
      } else {
        pendingEdits[last.key] = last.oldValue;
      }

      const currentStatus = pendingEdits[last.key] || origStatus;
      updateCellVisual(dateKey, currentStatus, !!pendingEdits[last.key]);
    }

    updateSaveDiscardBar();
  }

  // ---- Add People Modal ----

  function showAddPeopleModal() {
    const modal = document.getElementById('addPeopleModal');

    let html = '<div class="add-people-overlay" id="addPeopleOverlay">';
    html += '<div class="add-people-modal">';
    html += '<div class="add-people-modal__title">◊î◊ï◊°◊§◊™ ◊ê◊†◊©◊ô◊ù</div>';
    html += '<div class="add-people-modal__desc">◊î◊õ◊†◊° ◊©◊û◊ï◊™, ◊û◊ï◊§◊®◊ì◊ô◊ù ◊ë◊§◊°◊ô◊ß ◊ê◊ï ◊©◊ï◊®◊î ◊ó◊ì◊©◊î</div>';
    html += '<textarea class="add-people-modal__input" id="addPeopleInput" placeholder="◊©◊ù ◊®◊ê◊©◊ï◊ü, ◊©◊ù ◊©◊†◊ô&#10;◊©◊ù ◊©◊ú◊ô◊©◊ô"></textarea>';

    // Association selector
    const associations = getUniqueAssociations();
    html += '<div class="add-people-modal__field">';
    html += '<label class="add-people-modal__field-label">◊©◊ô◊ï◊ö</label>';
    html += '<select class="add-people-modal__select" id="addPeopleAssoc">';
    html += '<option value="">(◊ú◊ú◊ê ◊©◊ô◊ï◊ö)</option>';
    associations.forEach(a => {
      html += '<option value="' + escapeHtml(a) + '">' + escapeHtml(a) + '</option>';
    });
    html += '<option value="__other__">◊ê◊ó◊®...</option>';
    html += '</select>';
    html += '<input type="text" class="add-people-modal__custom-input" id="addPeopleAssocCustom" placeholder="◊î◊ñ◊ü ◊©◊ô◊ï◊ö ◊ó◊ì◊©...">';
    html += '</div>';

    html += '<div class="add-people-modal__warning" id="addPeopleWarning" style="display:none;"></div>';
    html += '<div class="add-people-modal__actions">';
    html += '<button class="add-people-modal__btn add-people-modal__btn--add" id="addPeopleSubmit">◊î◊ï◊°◊£</button>';
    html += '<button class="add-people-modal__btn add-people-modal__btn--cancel" id="addPeopleCancel">◊ë◊ô◊ò◊ï◊ú</button>';
    html += '</div></div></div>';

    modal.innerHTML = html;
    // Delay focus to avoid iOS keyboard issues on modal open
    setTimeout(() => {
      const inp = document.getElementById('addPeopleInput');
      if (inp) inp.focus();
    }, 100);

    // Show/hide custom association input
    document.getElementById('addPeopleAssoc').addEventListener('change', function() {
      const customInput = document.getElementById('addPeopleAssocCustom');
      customInput.classList.toggle('add-people-modal__custom-input--visible', this.value === '__other__');
      if (this.value === '__other__') customInput.focus();
    });

    let modalTouchTime = 0;
    function isModalTouchDuplicate(e) {
      if (e.type === 'touchend') { modalTouchTime = Date.now(); return false; }
      return (e.type === 'click' && Date.now() - modalTouchTime < 500);
    }
    function onSubmit(e) {
      if (isModalTouchDuplicate(e)) return;
      e.preventDefault();
      handleAddPeople();
    }
    function onCancel(e) {
      if (isModalTouchDuplicate(e)) return;
      e.preventDefault();
      modal.innerHTML = '';
    }
    document.getElementById('addPeopleSubmit').addEventListener('click', onSubmit);
    document.getElementById('addPeopleSubmit').addEventListener('touchend', onSubmit);
    document.getElementById('addPeopleCancel').addEventListener('click', onCancel);
    document.getElementById('addPeopleCancel').addEventListener('touchend', onCancel);
    function dismissOverlay(e) {
      if (e.target === e.currentTarget) modal.innerHTML = '';
    }
    document.getElementById('addPeopleOverlay').addEventListener('click', dismissOverlay);
    document.getElementById('addPeopleOverlay').addEventListener('touchend', dismissOverlay);
  }

  async function handleAddPeople() {
    const input = document.getElementById('addPeopleInput').value;
    const warning = document.getElementById('addPeopleWarning');

    const names = input
      .split(/[,\n]/)
      .map(n => n.trim())
      .filter(n => n.length > 0);

    if (names.length === 0) {
      warning.textContent = '◊ô◊© ◊ú◊î◊ñ◊ô◊ü ◊ú◊§◊ó◊ï◊™ ◊©◊ù ◊ê◊ó◊ì';
      warning.style.display = 'block';
      return;
    }

    const duplicates = names.filter(n => currentNames.includes(n));
    const newNames = names.filter(n => !currentNames.includes(n));

    if (newNames.length === 0) {
      warning.textContent = '◊õ◊ú ◊î◊©◊û◊ï◊™ ◊©◊î◊ï◊ñ◊†◊ï ◊õ◊ë◊® ◊ß◊ô◊ô◊û◊ô◊ù ◊ë◊û◊¢◊®◊õ◊™';
      warning.style.display = 'block';
      return;
    }

    if (duplicates.length > 0) {
      warning.textContent = '◊©◊û◊ï◊™ ◊©◊õ◊ë◊® ◊ß◊ô◊ô◊û◊ô◊ù (◊ô◊ì◊ú◊í◊ï): ' + duplicates.join(', ');
      warning.style.display = 'block';
    }

    const btn = document.getElementById('addPeopleSubmit');
    btn.disabled = true;
    btn.textContent = '◊û◊ï◊°◊ô◊£...';

    // Read association value
    const assocSelect = document.getElementById('addPeopleAssoc');
    const assocCustom = document.getElementById('addPeopleAssocCustom');
    const association = assocSelect.value === '__other__' ? assocCustom.value.trim() : assocSelect.value;

    try {
      await callAppsScript({
        action: 'addPeople',
        names: newNames,
        dateRange: { start: DATE_START, end: DATE_END },
        defaultStatus: 'activity',
        association: association
      });

      document.getElementById('addPeopleModal').innerHTML = '';
      showToast('◊†◊ï◊°◊§◊ï ' + newNames.length + ' ◊ê◊†◊©◊ô◊ù ◊ë◊î◊¶◊ú◊ó◊î. ◊ò◊ï◊¢◊ü ◊û◊ó◊ì◊©...', 'success', 3000);

      setTimeout(() => location.reload(), 2000);
    } catch (err) {
      btn.disabled = false;
      btn.textContent = '◊î◊ï◊°◊£';
    }
  }

  // ---- Toolbar Setup ----

  function setupToolbar() {
    const modes = document.getElementById('toolbarModes');
    const btnNote = document.getElementById('btnNote');
    const btnEdit = document.getElementById('btnEdit');
    const btnCancel = document.getElementById('btnCancel');
    const btnAddPeople = document.getElementById('btnAddPeople');

    function updateToolbarVisibility() {
      const isAll = currentSelectedPerson === '__all__';
      modes.style.display = isAll ? 'none' : 'flex';
      btnAddPeople.style.display = isAll ? '' : 'none';
    }

    function setMode(mode) {
      currentMode = mode;
      btnNote.classList.toggle('toolbar__btn--active', mode === 'note');
      btnEdit.classList.toggle('toolbar__btn--active', mode === 'edit');
      btnCancel.style.display = mode ? '' : 'none';
      removeStatusPicker();
    }

    // Guard against touch + click double-firing on mobile
    let lastTouchTime = 0;
    function isTouchDuplicate(e) {
      if (e.type === 'touchend') {
        lastTouchTime = Date.now();
        return false;
      }
      // Skip click if a recent touchend already handled it
      return (e.type === 'click' && Date.now() - lastTouchTime < 500);
    }

    function handleNoteToggle(e) {
      if (isTouchDuplicate(e)) return;
      e.preventDefault();
      setMode(currentMode === 'note' ? null : 'note');
    }
    function handleEditToggle(e) {
      if (isTouchDuplicate(e)) return;
      e.preventDefault();
      setMode(currentMode === 'edit' ? null : 'edit');
    }
    function handleCancel(e) {
      if (isTouchDuplicate(e)) return;
      e.preventDefault();
      setMode(null);
      if (Object.keys(pendingEdits).length > 0) {
        discardAllEdits();
      }
    }
    function handleAddPeopleOpen(e) {
      if (isTouchDuplicate(e)) return;
      e.preventDefault();
      showAddPeopleModal();
    }

    btnNote.addEventListener('click', handleNoteToggle);
    btnNote.addEventListener('touchend', handleNoteToggle);
    btnEdit.addEventListener('click', handleEditToggle);
    btnEdit.addEventListener('touchend', handleEditToggle);
    btnCancel.addEventListener('click', handleCancel);
    btnCancel.addEventListener('touchend', handleCancel);
    btnAddPeople.addEventListener('click', handleAddPeopleOpen);
    btnAddPeople.addEventListener('touchend', handleAddPeopleOpen);

    // Rotation pattern button
    const btnRotation = document.getElementById('btnRotation');
    function handleRotation(e) {
      if (isTouchDuplicate(e)) return;
      e.preventDefault();
      showRotationModal();
    }
    btnRotation.addEventListener('click', handleRotation);
    btnRotation.addEventListener('touchend', handleRotation);

    // Fairness dashboard button
    const btnFairness = document.getElementById('btnFairness');
    function handleFairness(e) {
      if (isTouchDuplicate(e)) return;
      e.preventDefault();
      showFairnessDashboard();
    }
    btnFairness.addEventListener('click', handleFairness);
    btnFairness.addEventListener('touchend', handleFairness);

    return { updateToolbarVisibility, setMode };
  }

  // ---- Fairness Dashboard ----

  function computeFairnessData(dataMap, names) {
    const commander = '◊í◊ô◊ú ◊ñ◊ê◊ë◊ô';
    const filteredNames = getFilteredNames();
    const results = [];
    filteredNames.forEach(name => {
      let homeDays = 0, baseDays = 0, switchDays = 0;
      Object.keys(dataMap).forEach(dateKey => {
        const status = dataMap[dateKey] && dataMap[dateKey][name];
        if (status === 'home') homeDays++;
        else if (status === 'activity') baseDays++;
        else if (status && status.startsWith('switch')) switchDays++;
      });
      const totalDays = homeDays + baseDays + switchDays;
      const homePct = totalDays > 0 ? (homeDays / totalDays * 100) : 0;
      results.push({ name, homeDays, baseDays, switchDays, totalDays, homePct, isCommander: name === commander });
    });
    results.sort((a, b) => b.homeDays - a.homeDays);
    return results;
  }

  function showFairnessDashboard() {
    const data = computeFairnessData(currentDataMap, currentNames);
    const modalEl = document.getElementById('fairnessModal');
    const avgHomePct = data.length > 0
      ? (data.reduce((sum, d) => sum + d.homePct, 0) / data.length).toFixed(1)
      : 0;

    let html = '<div class="fairness-overlay" id="fairnessOverlay">';
    html += '<div class="fairness-modal">';
    html += '<div class="fairness-modal__header">';
    html += '<span class="fairness-modal__title">◊°◊ô◊õ◊ï◊ù ◊î◊ï◊í◊†◊ï◊™</span>';
    html += '<button class="fairness-modal__close" id="fairnessClose">&times;</button>';
    html += '</div>';
    html += '<div class="fairness-modal__body">';
    html += '<div class="fairness-modal__table-wrap">';
    html += '<table class="fairness-table"><thead><tr>';
    html += '<th>#</th><th>◊©◊ù</th><th>◊ë◊ë◊ô◊™</th><th>◊ë◊û◊ï◊¶◊ë</th><th>◊û◊¢◊ë◊®</th><th>◊°◊î"◊õ</th><th>◊î◊™◊§◊ú◊í◊ï◊™</th><th>% ◊ë◊ë◊ô◊™</th>';
    html += '</tr></thead><tbody>';

    data.forEach((row, idx) => {
      const rowClass = row.isCommander ? ' class="fairness-table__row--commander"' : '';
      const nameClass = row.isCommander ? ' fairness-table__name--commander' : '';
      const actPct = row.totalDays > 0 ? (row.baseDays / row.totalDays * 100).toFixed(1) : 0;
      const homePctBar = row.totalDays > 0 ? (row.homeDays / row.totalDays * 100).toFixed(1) : 0;
      const switchPctBar = row.totalDays > 0 ? (row.switchDays / row.totalDays * 100).toFixed(1) : 0;
      const pctClass = row.homePct >= parseFloat(avgHomePct) ? 'fairness-table__pct--high' : 'fairness-table__pct--low';

      html += '<tr' + rowClass + '>';
      html += '<td style="text-align:center;color:var(--clr-text-tertiary);width:28px">' + (idx + 1) + '</td>';
      html += '<td class="fairness-table__name' + nameClass + '">' + escapeHtml(row.name) + '</td>';
      html += '<td>' + row.homeDays + '</td>';
      html += '<td>' + row.baseDays + '</td>';
      html += '<td>' + row.switchDays + '</td>';
      html += '<td>' + row.totalDays + '</td>';
      html += '<td class="fairness-table__bar-cell"><div class="fairness-table__bar">';
      html += '<div class="fairness-table__bar-seg fairness-table__bar-seg--activity" style="width:' + actPct + '%"></div>';
      html += '<div class="fairness-table__bar-seg fairness-table__bar-seg--home" style="width:' + homePctBar + '%"></div>';
      html += '<div class="fairness-table__bar-seg fairness-table__bar-seg--switch" style="width:' + switchPctBar + '%"></div>';
      html += '</div></td>';
      html += '<td class="fairness-table__pct ' + pctClass + '">' + row.homePct.toFixed(1) + '%</td>';
      html += '</tr>';
    });

    html += '</tbody></table></div>';
    html += '<div class="fairness-avg"><span>◊û◊û◊ï◊¶◊¢ % ◊ë◊ë◊ô◊™:</span><span class="fairness-avg__value">' + avgHomePct + '%</span></div>';
    html += '</div></div></div>';

    modalEl.innerHTML = html;

    document.getElementById('fairnessClose').addEventListener('click', () => { modalEl.innerHTML = ''; });
    document.getElementById('fairnessOverlay').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) modalEl.innerHTML = '';
    });
  }

  // ---- Rotation Pattern Generator ----

  function generateRotationPattern(baseDays, homeDays, startDate, endDate) {
    const edits = [];
    const start = new Date(startDate + 'T00:00:00');
    const end = new Date(endDate + 'T00:00:00');

    let phase = 'base'; // 'base' or 'home'
    let baseRemaining = baseDays;
    let homeRemaining = homeDays;
    let returningFromHome = false;

    const d = new Date(start);
    while (d <= end) {
      const dateKey = formatDate(d);
      const dow = d.getDay(); // 0=Sun, 6=Sat
      let status;

      if (phase === 'base') {
        baseRemaining--;
        if (baseRemaining === 0) {
          status = 'switch-home';
          phase = 'home';
          homeRemaining = homeDays;
        } else if (returningFromHome) {
          status = 'switch-base';
          returningFromHome = false;
        } else {
          status = 'activity';
        }
      } else {
        // phase === 'home'
        status = 'home';
        // Count toward home days: Sat doesn't count (free with Fri)
        if (dow !== 6) {
          homeRemaining--;
        }
        // Transition back to base if home days used up (but not on Friday ‚Äî Sat still included)
        if (homeRemaining <= 0 && dow !== 5) {
          phase = 'base';
          baseRemaining = baseDays;
          returningFromHome = true;
        }
      }

      edits.push({ date: dateKey, status: status });
      d.setDate(d.getDate() + 1);
    }
    return edits;
  }

  function showRotationModal() {
    const person = currentSelectedPerson;
    if (person === '__all__') return;

    const modalEl = document.getElementById('rotationModal');
    let html = '<div class="rotation-overlay" id="rotationOverlay">';
    html += '<div class="rotation-modal">';
    html += '<div class="rotation-modal__header">';
    html += '<span class="rotation-modal__title">◊™◊ë◊†◊ô◊™ ◊û◊ó◊ñ◊ï◊®◊ô◊™ ‚Äî ' + escapeHtml(person) + '</span>';
    html += '<button class="rotation-modal__close" id="rotationClose">&times;</button>';
    html += '</div>';
    html += '<div class="rotation-modal__body"><div class="rotation-form">';

    html += '<div class="rotation-form__row">';
    html += '<div class="rotation-form__field">';
    html += '<label class="rotation-form__label">◊ô◊û◊ô ◊û◊ï◊¶◊ë</label>';
    html += '<input class="rotation-form__input" type="number" id="rotBaseDays" min="1" max="60" value="10">';
    html += '</div>';
    html += '<div class="rotation-form__field">';
    html += '<label class="rotation-form__label">◊ô◊û◊ô ◊ë◊ô◊™</label>';
    html += '<input class="rotation-form__input" type="number" id="rotHomeDays" min="1" max="30" value="4">';
    html += '<span class="rotation-form__hint">◊©◊ô◊©◊ô-◊©◊ë◊™ = ◊ô◊ï◊ù ◊ê◊ó◊ì</span>';
    html += '</div></div>';

    html += '<div class="rotation-form__field">';
    html += '<label class="rotation-form__label">◊™◊ê◊®◊ô◊ö ◊î◊™◊ó◊ú◊î</label>';
    html += '<input class="rotation-form__input" type="date" id="rotStartDate" min="' + DATE_START + '" max="' + DATE_END + '" value="' + DATE_START + '">';
    html += '</div>';

    html += '<div class="rotation-form__field">';
    html += '<label class="rotation-form__label">◊™◊ê◊®◊ô◊ö ◊°◊ô◊ï◊ù</label>';
    html += '<input class="rotation-form__input" type="date" id="rotEndDate" min="' + DATE_START + '" max="' + DATE_END + '" value="' + DATE_END + '">';
    html += '</div>';

    html += '<div id="rotationPreview" style="display:none;"></div>';

    html += '<div class="rotation-form__actions">';
    html += '<button class="rotation-form__btn rotation-form__btn--preview" id="rotPreview">◊™◊¶◊ï◊í◊î ◊û◊ß◊ì◊ô◊û◊î</button>';
    html += '<button class="rotation-form__btn rotation-form__btn--apply" id="rotApply" disabled>◊î◊ó◊ú ◊¢◊ú ◊î◊ú◊ï◊ó</button>';
    html += '<button class="rotation-form__btn rotation-form__btn--cancel" id="rotCancel">◊ë◊ô◊ò◊ï◊ú</button>';
    html += '</div>';

    html += '</div></div></div></div>';
    modalEl.innerHTML = html;

    let previewEdits = null;

    document.getElementById('rotPreview').addEventListener('click', () => {
      const bd = parseInt(document.getElementById('rotBaseDays').value, 10);
      const hd = parseInt(document.getElementById('rotHomeDays').value, 10);
      const sd = document.getElementById('rotStartDate').value;
      const ed = document.getElementById('rotEndDate').value || DATE_END;

      if (!bd || bd < 1 || !hd || hd < 1) {
        showToast('◊ô◊© ◊ú◊î◊ñ◊ô◊ü ◊û◊°◊§◊® ◊ô◊û◊ô◊ù ◊™◊ß◊ô◊ü', 'error');
        return;
      }
      if (sd > ed) {
        showToast('◊™◊ê◊®◊ô◊ö ◊î◊™◊ó◊ú◊î ◊ó◊ô◊ô◊ë ◊ú◊î◊ô◊ï◊™ ◊ú◊§◊†◊ô ◊™◊ê◊®◊ô◊ö ◊°◊ô◊ï◊ù', 'error');
        return;
      }

      previewEdits = generateRotationPattern(bd, hd, sd, ed);
      renderRotationPreview(previewEdits);
      document.getElementById('rotApply').disabled = false;
    });

    document.getElementById('rotApply').addEventListener('click', () => {
      if (!previewEdits || previewEdits.length === 0) return;
      previewEdits.forEach(edit => { stageEdit(edit.date, edit.status); });
      modalEl.innerHTML = '';
      showToast(previewEdits.length + ' ◊©◊ô◊†◊ï◊ô◊ô◊ù ◊î◊ï◊ó◊ú◊ï (◊ò◊®◊ù ◊†◊©◊û◊®◊ï)', 'success');
      renderCurrentView();
      updateSaveDiscardBar();
    });

    document.getElementById('rotCancel').addEventListener('click', () => { modalEl.innerHTML = ''; });
    document.getElementById('rotationClose').addEventListener('click', () => { modalEl.innerHTML = ''; });
    document.getElementById('rotationOverlay').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) modalEl.innerHTML = '';
    });
  }

  function renderRotationPreview(edits) {
    const previewEl = document.getElementById('rotationPreview');
    if (!edits || edits.length === 0) {
      previewEl.style.display = 'none';
      return;
    }

    let html = '<div class="rotation-preview">';
    html += '<div class="rotation-preview__header"><span>◊™◊¶◊ï◊í◊î ◊û◊ß◊ì◊ô◊û◊î</span>';
    html += '<span class="rotation-preview__count">' + edits.length + ' ◊ô◊û◊ô◊ù</span></div>';
    html += '<div class="rotation-preview__list">';

    edits.forEach(edit => {
      const [y, m, d] = edit.date.split('-').map(Number);
      const dateObj = new Date(y, m - 1, d);
      const dayName = dayNames[dateObj.getDay()];
      const dotClass = edit.status.startsWith('switch')
        ? 'rotation-preview__item-dot--switch'
        : 'rotation-preview__item-dot--' + edit.status;

      html += '<div class="rotation-preview__item">';
      html += '<span class="rotation-preview__item-date">' + d + '/' + m + '</span>';
      html += '<span class="rotation-preview__item-dot ' + dotClass + '"></span>';
      html += '<span class="rotation-preview__item-label">' + dayName + ' ‚Äî ' + statusLabel(edit.status) + '</span>';
      html += '</div>';
    });

    html += '</div></div>';
    previewEl.innerHTML = html;
    previewEl.style.display = '';
  }

  // ---- Timeline / Gantt View ----

  const dowAbbr = ['◊ê', '◊ë', '◊í', '◊ì', '◊î', '◊ï', '◊©'];

  function renderTimeline(dataMap, notesMap, names, selectedPerson) {
    const container = document.getElementById('calendarContainer');
    const commander = '◊í◊ô◊ú ◊ñ◊ê◊ë◊ô';

    const allDays = [];
    const d = new Date(2026, 3, 26);
    const end = new Date(2026, 5, 18);
    while (d <= end) { allDays.push(new Date(d)); d.setDate(d.getDate() + 1); }

    const filteredForTimeline = getFilteredNames();
    const displayNames = [commander, ...filteredForTimeline.filter(n => n !== commander)].filter(n => filteredForTimeline.includes(n));

    const colDef = 'minmax(90px, auto) repeat(' + allDays.length + ', auto)';

    let html = '<div class="timeline-wrap">';
    html += '<div class="timeline-scroll">';
    html += '<div class="timeline-grid" style="grid-template-columns: ' + colDef + ';">';

    // Header row: corner first (RTL = right side), then dates
    html += '<div class="timeline-corner">◊©◊ù</div>';

    allDays.forEach(day => {
      const key = formatDate(day);
      const dow = day.getDay();
      const isShabbat = dow === 6;
      const holiday = holidays[key] || null;
      const isToday = key === todayKey;

      let hdrClass = 'timeline-date-header';
      if (isToday) hdrClass += ' timeline-date-header--today';
      else if (holiday) hdrClass += ' timeline-date-header--shavuot';
      else if (isShabbat) hdrClass += ' timeline-date-header--shabbat';

      html += '<div class="' + hdrClass + '">';
      html += '<span class="timeline-date-header__day">' + day.getDate() + '</span>';
      html += '<span class="timeline-date-header__dow">' + dowAbbr[dow] + '</span>';
      html += '</div>';
    });

    // Data rows: name first (RTL = right side), then day cells
    displayNames.forEach(name => {
      const isCmd = name === commander;
      html += '<div class="timeline-name' + (isCmd ? ' timeline-name--commander' : '') + '">' + escapeHtml(name) + '</div>';

      allDays.forEach(day => {
        const key = formatDate(day);
        const dow = day.getDay();
        const isShabbat = dow === 6;
        const isToday = key === todayKey;

        const dayData = dataMap[key] || {};
        let status = dayData[name] || null;
        const pendingKey = name + '|' + key;
        if (pendingEdits[pendingKey]) status = pendingEdits[pendingKey];

        let cellClass = 'timeline-cell';
        if (status === 'activity') cellClass += ' timeline-cell--activity';
        else if (status === 'home') cellClass += ' timeline-cell--home';
        else if (status === 'switch-home') cellClass += ' timeline-cell--switch-home';
        else if (status === 'switch-base') cellClass += ' timeline-cell--switch-base';
        else if (isShabbat) cellClass += ' timeline-cell--shabbat';

        if (isToday) cellClass += ' timeline-cell--today';
        if (pendingEdits[pendingKey]) cellClass += ' timeline-cell--pending';

        const dotClass = status && status.startsWith('switch')
          ? 'timeline-cell__dot--switch'
          : (status ? 'timeline-cell__dot--' + status : '');

        html += '<div class="' + cellClass + '" data-date="' + key + '" data-person="' + escapeHtml(name) + '">';
        if (status && dotClass) html += '<span class="timeline-cell__dot ' + dotClass + '"></span>';
        html += '</div>';
      });
    });

    html += '</div></div></div>';
    container.innerHTML = html;

    // Tooltips
    setupTimelineTooltips(container);

    // Click handlers
    container.querySelectorAll('.timeline-cell[data-date]').forEach(cell => {
      cell.addEventListener('click', () => {
        const dateKey = cell.getAttribute('data-date');
        showDayModal(dateKey, dataMap, notesMap);
      });
    });

    // Auto-scroll to today
    const todayHeader = container.querySelector('.timeline-date-header--today');
    if (todayHeader) {
      setTimeout(() => {
        todayHeader.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }, 300);
    }
  }

  let _timelineTooltip = null;

  function setupTimelineTooltips(container) {
    function showTip(e) {
      const cell = e.target.closest('.timeline-cell[data-date]');
      if (!cell) { hideTip(); return; }

      const dateKey = cell.getAttribute('data-date');
      const person = cell.getAttribute('data-person');
      const [y, m, d] = dateKey.split('-').map(Number);
      const dateObj = new Date(y, m - 1, d);
      const dayName = dayNames[dateObj.getDay()];

      let status = (currentDataMap[dateKey] && currentDataMap[dateKey][person]) || null;
      const pendingKey = person + '|' + dateKey;
      if (pendingEdits[pendingKey]) status = pendingEdits[pendingKey];
      const statusText = status ? statusLabel(status) : '◊ú◊ú◊ê ◊°◊ò◊ò◊ï◊°';

      if (!_timelineTooltip) {
        _timelineTooltip = document.createElement('div');
        _timelineTooltip.className = 'timeline-tooltip';
        document.body.appendChild(_timelineTooltip);
      }

      _timelineTooltip.textContent = dayName + ' ' + d + '/' + m + ' ‚Äî ' + person + ': ' + statusText;
      _timelineTooltip.style.display = '';
      positionTip(e);
    }

    function positionTip(e) {
      if (!_timelineTooltip || _timelineTooltip.style.display === 'none') return;
      let x = e.clientX + 12;
      let y = e.clientY - 32;
      _timelineTooltip.style.left = x + 'px';
      _timelineTooltip.style.top = y + 'px';
      const rect = _timelineTooltip.getBoundingClientRect();
      if (rect.right > window.innerWidth) _timelineTooltip.style.left = (e.clientX - rect.width - 10) + 'px';
      if (rect.top < 0) _timelineTooltip.style.top = (e.clientY + 18) + 'px';
    }

    function hideTip() {
      if (_timelineTooltip) _timelineTooltip.style.display = 'none';
    }

    container.addEventListener('mouseover', showTip);
    container.addEventListener('mousemove', positionTip);
    container.addEventListener('mouseout', (e) => {
      if (!e.target.closest('.timeline-cell')) hideTip();
    });
  }

  function renderCurrentView() {
    if (currentView === 'timeline') {
      renderTimeline(currentDataMap, currentNotesMap, currentNames, currentSelectedPerson);
    } else {
      renderCalendar(currentDataMap, currentNotesMap, currentNames, currentSelectedPerson);
      // Re-apply keyboard focus after re-render
      if (focusedDateKey) {
        const cell = document.querySelector('.cal-cell[data-date="' + focusedDateKey + '"]');
        if (cell) cell.classList.add('cal-cell--focused');
      }
    }
  }

  function switchView(newView) {
    if (currentView === newView) return;
    currentView = newView;
    document.getElementById('btnCalView').classList.toggle('view-toggle__btn--active', newView === 'calendar');
    document.getElementById('btnTimelineView').classList.toggle('view-toggle__btn--active', newView === 'timeline');
    fadeSwapCalendar(() => {
      renderCurrentView();
      renderWeekJumpBar();
    });
  }

  // ---- Fallback data ----

  function generateFallbackData() {
    const names = ['◊í◊ô◊ú ◊ñ◊ê◊ë◊ô','◊ê◊ë◊ô◊®◊ü ◊í◊®◊ô◊ü','◊ú◊®◊î','◊û◊ô◊î ◊ô◊ì◊ô◊ì◊î','◊¢◊û◊ô◊™ ◊ï◊ô◊ô◊°','◊©◊®◊ï◊ü ◊õ◊î◊ü','◊ê◊ú◊ï◊ü ◊í◊ú◊§◊®◊ô◊ü','◊õ◊®◊û◊ú ◊ê◊ú◊ô◊û◊ú◊ö','◊ô◊ï◊ê◊ë ◊ê◊©◊ì','◊©◊†◊ô ◊ú◊ê◊ï◊†◊ï◊ë','◊ê◊ú◊ô◊ñ◊ë◊™','◊©◊ô ◊ô◊§◊®◊ó','◊©◊†◊î◊ë'];
    const rows = [];
    const d = new Date(2026, 3, 26);
    const end = new Date(2026, 5, 18);
    let seed = 42;
    function pseudoRandom() {
      seed = (seed * 16807 + 0) % 2147483647;
      return seed / 2147483647;
    }
    while (d <= end) {
      const key = formatDate(d);
      names.forEach(name => {
        const r = pseudoRandom();
        rows.push({ name, date: key, status: r > 0.6 ? 'activity' : r > 0.15 ? 'home' : (r > 0.075 ? 'switch-home' : 'switch-base') });
      });
      d.setDate(d.getDate() + 1);
    }
    return rows;
  }

  // ---- Init ----

  function updateFreshnessBadge(source) {
    const badge = document.getElementById('freshnessBadge');
    const labels = {
      live: '◊†◊™◊ï◊†◊ô◊ù ◊û◊¢◊ï◊ì◊õ◊†◊ô◊ù',
      cached: '◊†◊™◊ï◊†◊ô◊ù ◊û◊ß◊ï◊ë◊• CSV',
      fallback: '◊†◊™◊ï◊†◊ô ◊ì◊ï◊í◊û◊î (◊ú◊ê ◊û◊ß◊ï◊ï◊ü)'
    };
    badge.className = 'freshness-badge freshness-badge--' + source;
    badge.innerHTML = '<span class="freshness-badge__dot"></span>' + labels[source];
    badge.style.display = 'inline-flex';
    badge.onclick = function() { location.reload(); };
  }

  async function init() {
    let rows;
    let dataSource = 'fallback';
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRh9ERHvLzkE2yu1cWs7_zMpYo17Hok-w7Eb3m3IfJFxh_Nk-UQJ31CUDz2B-yV5GeDIhb5bUx5RcyJ/pub?output=csv';

    // Try Apps Script API first (always fresh data)
    try {
      const resp = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'getData' })
      });
      const result = await resp.json();
      if (!result.success || !result.rows || result.rows.length === 0) throw new Error('empty response');
      rows = result.rows;
      dataSource = 'live';
    } catch (e) {
      console.warn('Apps Script getData failed, trying published CSV:', e);
      // Fallback to published CSV
      try {
        const resp = await fetch(SHEET_URL);
        if (!resp.ok) throw new Error('fetch failed');
        const text = await resp.text();
        rows = parseCSV(text);
        if (rows.length === 0) throw new Error('empty CSV');
        dataSource = 'cached';
      } catch (e2) {
        console.warn('Published CSV failed, trying local backup:', e2);
        try {
          const resp = await fetch('data.csv');
          if (!resp.ok) throw new Error('local fetch failed');
          const text = await resp.text();
          rows = parseCSV(text);
          if (rows.length === 0) throw new Error('empty local CSV');
          dataSource = 'cached';
        } catch (e3) {
          console.warn('Local CSV also failed, using fallback data:', e3);
          rows = generateFallbackData();
          dataSource = 'fallback';
        }
      }
    }

    updateFreshnessBadge(dataSource);

    const { map, notesMap, names, associationMap } = buildDataMap(rows);

    // Store global refs
    currentDataMap = map;
    currentNotesMap = notesMap;
    currentNames = names;
    currentAssociationMap = associationMap;

    const select = document.getElementById('personFilter');
    const commander = '◊í◊ô◊ú ◊ñ◊ê◊ë◊ô';
    const sortedNames = [commander, ...names.filter(n => n !== commander)];
    sortedNames.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name === commander ? '‚≠ê ' + name : name;
      select.appendChild(opt);
    });

    renderCalendar(map, notesMap, names, '__all__');
    updateStatsBar(map);
    updatePersonStats(map, '__all__');
    renderWeekJumpBar();
    capturePersonOptions();

    // Association filter button
    const btnAssocFilter = document.getElementById('btnAssocFilter');
    const assocPopover = document.getElementById('assocFilterPopover');

    btnAssocFilter.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = assocPopover.classList.contains('assoc-filter-popover--open');
      if (isOpen) {
        assocPopover.classList.remove('assoc-filter-popover--open');
      } else {
        renderAssocFilterPopover();
        assocPopover.classList.add('assoc-filter-popover--open');
      }
    });

    // Close popover on click outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#assocFilterWrap')) {
        assocPopover.classList.remove('assoc-filter-popover--open');
      }
    });

    // Today button + auto-scroll
    function scrollToToday() {
      const todayCell = document.querySelector('.cal-cell--today');
      if (todayCell) {
        todayCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    const todayFab = document.getElementById('todayFab');
    if (document.querySelector('.cal-cell--today')) {
      todayFab.style.display = 'flex';
      todayFab.addEventListener('click', scrollToToday);
      // Auto-scroll on first load
      setTimeout(scrollToToday, 400);
    }

    // Setup toolbar
    const toolbarCtrl = setupToolbar();
    toolbarCtrl.updateToolbarVisibility();

    // Setup drag handlers
    setupDragHandlers();

    // Person quick-switch arrows
    const btnPrev = document.getElementById('btnPrevPerson');
    const btnNext = document.getElementById('btnNextPerson');

    function updateNavButtons() {
      const isAll = select.value === '__all__';
      btnPrev.style.display = isAll ? 'none' : '';
      btnNext.style.display = isAll ? 'none' : '';
      if (!isAll) {
        btnPrev.disabled = select.selectedIndex <= 1; // index 0 is __all__
        btnNext.disabled = select.selectedIndex >= select.options.length - 1;
      }
    }

    function switchPerson(delta) {
      const newIdx = select.selectedIndex + delta;
      if (newIdx < 0 || newIdx >= select.options.length) return;
      select.selectedIndex = newIdx;
      select.dispatchEvent(new Event('change'));
    }

    btnPrev.addEventListener('click', () => switchPerson(-1));
    btnNext.addEventListener('click', () => switchPerson(1));
    updateNavButtons();

    // View toggle
    document.getElementById('btnCalView').addEventListener('click', () => switchView('calendar'));
    document.getElementById('btnTimelineView').addEventListener('click', () => switchView('timeline'));

    // Setup save/discard buttons
    document.getElementById('btnSaveAll').addEventListener('click', saveAllEdits);
    document.getElementById('btnDiscardAll').addEventListener('click', discardAllEdits);
    document.getElementById('btnUndo').addEventListener('click', undoLastEdit);

    // Dropdown change handler
    select.addEventListener('change', () => {
      currentSelectedPerson = select.value;
      currentMode = null;
      pendingEdits = {};
      undoStack = [];
      focusedDateKey = null;
      toolbarCtrl.setMode(null);
      document.getElementById('saveBar').style.display = 'none';
      // Timeline and summary only available for everyone view
      const viewToggle = document.getElementById('viewToggle');
      const btnFairnessEl = document.getElementById('btnFairness');
      if (select.value !== '__all__') {
        if (currentView === 'timeline') switchView('calendar');
        viewToggle.style.display = 'none';
        btnFairnessEl.style.display = 'none';
      } else {
        viewToggle.style.display = '';
        btnFairnessEl.style.display = '';
      }
      fadeSwapCalendar(() => {
        renderCurrentView();
        toolbarCtrl.updateToolbarVisibility();
        // Show stats bar only in "Everyone" view
        if (select.value === '__all__') {
          updateStatsBar(map);
        } else {
          document.getElementById('statsBar').style.display = 'none';
        }
        updatePersonStats(map, select.value);
        updateNavButtons();
        renderWeekJumpBar();
      });
    });

    // Sticky header shadow ‚Äî observer is auto-attached inside renderCalendar()

    // Person search input
    const personSearchInput = document.getElementById('personSearch');
    const personSearchClear = document.getElementById('personSearchClear');

    personSearchInput.addEventListener('input', () => {
      const q = personSearchInput.value;
      filterPersons(q);
      personSearchClear.classList.toggle('person-search-clear--visible', q.length > 0);
    });

    personSearchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        // Select first non-__all__ match, or __all__ if nothing else
        const firstOpt = select.options.length > 1 ? select.options[1] : select.options[0];
        if (firstOpt) {
          select.value = firstOpt.value;
          select.dispatchEvent(new Event('change'));
        }
        personSearchInput.value = '';
        personSearchClear.classList.remove('person-search-clear--visible');
        filterPersons('');
        personSearchInput.blur();
      } else if (e.key === 'Escape') {
        personSearchInput.value = '';
        personSearchClear.classList.remove('person-search-clear--visible');
        filterPersons('');
        personSearchInput.blur();
      }
    });

    personSearchClear.addEventListener('click', () => {
      personSearchInput.value = '';
      personSearchClear.classList.remove('person-search-clear--visible');
      filterPersons('');
      personSearchInput.focus();
    });

    // Undo keyboard shortcut + cell navigation
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && currentMode === 'edit') {
        e.preventDefault();
        undoLastEdit();
        return;
      }

      // Skip keyboard nav if focus is in input/textarea/select or a modal is open
      const tag = document.activeElement && document.activeElement.tagName;
      if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
      if (document.querySelector('.day-modal-overlay, .add-people-overlay, .fairness-overlay, .rotation-overlay')) return;
      if (currentView === 'timeline') return;

      // Arrow key cell navigation (RTL-aware)
      if (e.key === 'ArrowRight') {
        e.preventDefault();
        navigateCell(-1); // RTL: right = previous day
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        navigateCell(1);  // RTL: left = next day
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        navigateCell(-7);
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        navigateCell(7);
      } else if (e.key === 'Enter' && focusedDateKey) {
        e.preventDefault();
        activateFocusedCell();
      } else if (e.key === 'Escape') {
        if (focusedDateKey) {
          e.preventDefault();
          setFocusedCell(null);
        }
      }

      // Quick-select status 1-4 when status picker is open
      const picker = document.getElementById('statusPicker');
      if (picker && e.key >= '1' && e.key <= '4') {
        e.preventDefault();
        const statusMap = { '1': 'activity', '2': 'home', '3': 'switch-base', '4': 'switch-home' };
        if (focusedDateKey) {
          stageEdit(focusedDateKey, statusMap[e.key]);
          removeStatusPicker();
        }
      }
    });

    // Warn before leaving with unsaved edits
    window.addEventListener('beforeunload', (e) => {
      if (Object.keys(pendingEdits).length > 0) {
        e.preventDefault();
        e.returnValue = '';
      }
    });
  }

  init();
})();

// Examples popup logic
(function() {
  const examples = [
    { label: '◊ô◊¶◊ô◊ê◊î', text: '◊í◊ô◊ú ◊ñ◊ê◊ë◊ô ◊ô◊ï◊¶◊ê ◊î◊ë◊ô◊™◊î ◊ë-15.05 ◊ï◊ó◊ï◊ñ◊® ◊ë-20.05' },
    { label: '◊ô◊¶◊ô◊ê◊î + ◊ú◊ï◊ó ◊©◊ú◊ù', text: '◊í◊ô◊ú ◊ñ◊ê◊ë◊ô ◊ë◊û◊ï◊¶◊ë ◊û-01.05 ◊¢◊ì 30.05, ◊ô◊ï◊¶◊ê ◊ë-15.05 ◊ï◊ó◊ï◊ñ◊® ◊ë-20.05' },
    { label: '◊ë◊ô◊ò◊ï◊ú ◊ó◊ï◊§◊©◊î', text: '◊í◊ô◊ú ◊ñ◊ê◊ë◊ô ◊û◊ë◊ò◊ú ◊ê◊™ ◊î◊ó◊ï◊§◊©◊î ◊û-15.05 ◊¢◊ì 20.05' },
    { label: '◊î◊ê◊®◊õ◊™ ◊ó◊ï◊§◊©◊î', text: '◊í◊ô◊ú ◊ñ◊ê◊ë◊ô ◊û◊ê◊®◊ô◊ö ◊¢◊ì 22.05' },
    { label: '◊î◊ï◊°◊§◊™ ◊ê◊ì◊ù', text: '◊™◊ï◊°◊ô◊£ ◊ê◊™ ◊í◊ô◊ú ◊ñ◊ê◊ë◊ô' },
    { label: '◊î◊°◊®◊™ ◊ê◊ì◊ù', text: '◊™◊°◊ô◊® ◊ê◊™ ◊í◊ô◊ú ◊ñ◊ê◊ë◊ô' },
    { label: '◊î◊¢◊®◊î', text: '◊î◊¢◊®◊î ◊ú◊í◊ô◊ú ◊ñ◊ê◊ë◊ô ◊ë-15.05: ◊™◊ï◊®◊†◊ï◊™' },
    { label: '◊î◊ó◊ú◊§◊î', text: '◊í◊ô◊ú ◊ñ◊ê◊ë◊ô ◊ï◊ô◊ï◊°◊ô ◊õ◊î◊ü ◊û◊ó◊ú◊ô◊§◊ô◊ù ◊û-15.05 ◊¢◊ì 20.05' },
    { label: '◊¢◊ì◊õ◊ï◊ü ◊°◊ò◊ò◊ï◊°', text: '◊õ◊ï◊ú◊ù ◊ë◊§◊¢◊ô◊ú◊ï◊™ ◊û-01.05 ◊¢◊ì 10.05' },
    { label: '◊™◊ï◊õ◊†◊ô◊™ ◊û◊ó◊ñ◊ï◊®◊ô◊™', text: '◊™◊ï◊õ◊†◊ô◊™ ◊ô◊¶◊ô◊ê◊ï◊™ ◊ú◊í◊ô◊ú ◊ñ◊ê◊ë◊ô ◊û◊™◊õ◊ï◊†◊™ 10-4 ◊û-01.05 ◊¢◊ì 30.06' },
    { label: '◊î◊¢◊™◊ß◊™ ◊î◊¢◊®◊ï◊™', text: '◊™◊¢◊™◊ô◊ß ◊î◊¢◊®◊ï◊™ ◊û◊í◊ô◊ú ◊ñ◊ê◊ë◊ô ◊ú◊ô◊ï◊°◊ô ◊õ◊î◊ü' },
    { label: '◊î◊¢◊™◊ß◊™ ◊™◊ï◊õ◊†◊ô◊™', text: '◊™◊¢◊™◊ô◊ß ◊™◊ï◊õ◊†◊ô◊™ ◊û◊í◊ô◊ú ◊ñ◊ê◊ë◊ô ◊ú◊ô◊ï◊°◊ô ◊õ◊î◊ü' },
    { label: '◊©◊ê◊ô◊ú◊™◊î', text: '◊û◊ô ◊ë◊ë◊ô◊™ ◊ë-15.05?' },
    { label: '◊©◊ê◊ô◊ú◊™◊î', text: '◊û◊î ◊î◊°◊ò◊ò◊ï◊° ◊©◊ú ◊í◊ô◊ú ◊ñ◊ê◊ë◊ô?' },
    { label: '◊ë◊ô◊ò◊ï◊ú ◊©◊ô◊†◊ï◊ô◊ô◊ù', text: '◊™◊ë◊ò◊ú ◊©◊ô◊†◊ï◊ô◊ô◊ù' }
  ];

  const copySvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
  const checkSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';

  const body = document.getElementById('examplesPanelBody');
  let html = '';
  examples.forEach(function(ex, i) {
    html += '<div class="example-item">';
    html += '<div class="example-item__label">' + ex.label + '</div>';
    html += '<div class="example-item__row">';
    html += '<span class="example-item__text">' + ex.text + '</span>';
    html += '<button class="example-item__copy" data-idx="' + i + '" aria-label="◊î◊¢◊™◊ß">';
    html += '<span class="example-item__feedback">◊î◊ï◊¢◊™◊ß!</span>';
    html += copySvg;
    html += '</button>';
    html += '</div></div>';
  });
  body.innerHTML = html;

  var fab = document.getElementById('examplesFab');
  var overlay = document.getElementById('examplesOverlay');
  var panel = document.getElementById('examplesPanel');
  var closeBtn = document.getElementById('examplesPanelClose');

  function openPanel() {
    overlay.classList.add('examples-overlay--open');
    panel.classList.add('examples-panel--open');
  }

  function closePanel() {
    overlay.classList.remove('examples-overlay--open');
    panel.classList.remove('examples-panel--open');
  }

  fab.addEventListener('click', openPanel);
  overlay.addEventListener('click', closePanel);
  closeBtn.addEventListener('click', closePanel);

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closePanel();
  });

  body.addEventListener('click', function(e) {
    var btn = e.target.closest('.example-item__copy');
    if (!btn) return;
    var idx = parseInt(btn.getAttribute('data-idx'), 10);
    var text = examples[idx].text;
    navigator.clipboard.writeText(text).then(function() {
      btn.classList.add('example-item__copy--copied');
      btn.innerHTML = '<span class="example-item__feedback example-item__feedback--show">◊î◊ï◊¢◊™◊ß!</span>' + checkSvg;
      setTimeout(function() {
        btn.classList.remove('example-item__copy--copied');
        btn.innerHTML = '<span class="example-item__feedback">◊î◊ï◊¢◊™◊ß!</span>' + copySvg;
      }, 1500);
    });
  });
})();
</script>
</body>
</html>
